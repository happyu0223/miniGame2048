<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‹¼äººæ€ - å…¨æ–°ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.544.0/dist/umd/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&family=Ma+Shan+Zheng&display=swap');

        :root {
            --primary-dark: #1a1a1a;
            --primary: #4a4a4a;
            --primary-light: #6a6a6a;
            --secondary: #8b4513;
            --accent: #cc0000;
            --background: #0a0a0a;
            --text-light: #d0d0d0;
            --text-gold: #cc0000;
            --shadow-dark: rgba(0, 0, 0, 0.8);
            --shadow-accent: rgba(204, 0, 0, 0.3);
        }

        body {
            background-color: var(--background);
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            color: var(--text-light);
            font-family: 'Noto Sans SC', sans-serif;
            overflow-x: hidden;
        }

        .game-container {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(15px);
            min-height: 100vh;
            border: 1px solid rgba(184, 134, 11, 0.2);
        }

        .title-font {
            font-family: 'Ma Shan Zheng', cursive;
            font-weight: normal;
            text-shadow: 2px 2px 4px var(--shadow-dark), 0 0 20px var(--shadow-accent);
            letter-spacing: 2px;
        }

        .dialogue-font {
            font-family: 'Noto Sans SC', sans-serif;
            font-weight: 500;
        }

        .role-werewolf { color: #ff4444; text-shadow: 0 0 10px #ff4444; }
        .role-seer { color: #44ffff; text-shadow: 0 0 10px #44ffff; }
        .role-witch { color: #ff44ff; text-shadow: 0 0 10px #ff44ff; }
        .role-hunter { color: #ffa500; text-shadow: 0 0 10px #ffa500; }
        .role-idiot { color: #ffff44; text-shadow: 0 0 10px #ffff44; }
        .role-villager { color: #44ff44; text-shadow: 0 0 10px #44ff44; }

        .player-avatar {
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .player-avatar:hover:not(.dead) {
            transform: translateY(-10px) scale(1.1);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.5);
        }

        .player-avatar.dead {
            filter: grayscale(100%) sepia(50%);
            opacity: 0.5;
        }

        .avatar-frame {
            border: 3px solid var(--accent);
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 0 20px var(--accent);
        }

        .avatar-frame.dead {
            border-color: #666;
            box-shadow: none;
        }

        .vote-count {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--secondary);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 3px solid white;
            z-index: 9999; /* è®¾ç½®ä¸ºæœ€é«˜å±‚çº§ */
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.8);
            font-size: 16px;
            pointer-events: none; /* é¿å…é®æŒ¡ç‚¹å‡» */
        }

        .vote-count-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--secondary);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
            z-index: 5;
            font-size: 1rem;
        }

        .avatar-frame {
            position: relative;
            z-index: 1;
        }

        .timer-container {
            width: 100%;
            height: 8px;
            background-color: #333;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .timer-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--secondary));
            transition: width 1s linear;
            box-shadow: 0 0 10px var(--accent);
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--accent);
            animation: fadeIn 0.5s ease;
        }

        /* å…¬å±åŒºåŸŸé™åˆ¶é«˜åº¦å¹¶å¯ç”¨æ»šè½®æ»šåŠ¨ */
        #chat-area {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 8px;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        #chat-area::-webkit-scrollbar {
            width: 8px;
        }

        #chat-area::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        #chat-area::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        #chat-area::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        .chat-message.system {
            background: rgba(218, 165, 32, 0.2);
            border-left-color: var(--accent);
            text-align: center;
            font-weight: bold;
        }

        .chat-message.private {
            background: rgba(128, 128, 128, 0.2);
            font-style: italic;
            border-left-color: #888;
        }

        .action-button {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            background: linear-gradient(145deg, var(--primary-dark), var(--primary));
            border: 2px solid var(--accent);
            box-shadow: 
                0 4px 8px var(--shadow-dark),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            text-shadow: 1px 1px 2px var(--shadow-dark);
        }

        .action-button.selected {
            background: linear-gradient(145deg, #2a0a0a, #4a1a1a);
            border-color: #cc0000;
            transform: translateY(2px);
            box-shadow: 
                0 2px 4px var(--shadow-dark),
                inset 0 1px 0 rgba(0, 0, 0, 0.3),
                0 0 20px rgba(204, 0, 0, 0.3);
        }

        .action-button.selected::after {
            content: 'âœ•';
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            color: #cc0000;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(204, 0, 0, 0.8);
        }

        .action-button.claw-effect::before {
            content: 'ğŸ©¸';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            color: #cc0000;
            opacity: 0;
            animation: clawMark 0.6s ease-out;
            pointer-events: none;
            z-index: 10;
        }

        .action-button:hover {
            background: linear-gradient(145deg, var(--primary), var(--primary-light));
            transform: translateY(-2px);
            box-shadow: 
                0 6px 12px var(--shadow-dark),
                0 0 20px var(--shadow-accent),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        .action-button:active {
            transform: translateY(0);
            box-shadow: 
                0 2px 4px var(--shadow-dark),
                inset 0 1px 0 rgba(0, 0, 0, 0.2);
        }

        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.3), transparent);
            transition: left 0.6s;
        }

        .action-button:hover::before {
            left: 100%;
        }

        .phase-indicator {
            animation: pulse 2s infinite;
            text-shadow: 0 0 20px var(--text-gold);
        }

        .chat-area {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(184, 134, 11, 0.3);
            backdrop-filter: blur(10px);
        }

        .status-bar {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(184, 134, 11, 0.3);
            backdrop-filter: blur(10px);
        }

        .action-area {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(184, 134, 11, 0.4);
            backdrop-filter: blur(10px);
        }

        .timer-bar {
            background: linear-gradient(90deg, var(--accent), var(--secondary));
            box-shadow: 0 0 15px var(--shadow-accent);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes glow {
            0%, 100% { 
                text-shadow: 0 0 20px #cc0000;
            }
            50% { 
                text-shadow: 0 0 30px #cc0000, 0 0 40px rgba(204, 0, 0, 0.5);
            }
        }

        @keyframes clawMark {
            0% { 
                opacity: 0; 
                transform: scale(0.5) rotate(-10deg);
            }
            50% { 
                opacity: 1; 
                transform: scale(1) rotate(0deg);
            }
            100% { 
                opacity: 0; 
                transform: scale(1.2) rotate(10deg);
            }
        }



        .fog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="rgba(212, 175, 55, 0.03)" fill-opacity="1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,128C672,128,768,160,864,165.3C960,171,1056,149,1152,138.7C1248,128,1344,128,1392,128L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
            background-size: cover;
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 1;
            animation: fogMove 60s linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes fogMove {
            0% { transform: translateX(0); }
            100% { transform: translateX(-1440px); }
        }
    </style>
</head>
<body>
    <div class="fog"></div>


    <div class="game-container min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Menu Screen -->
        <div id="menu-screen" class="w-full max-w-4xl glass-morphism rounded-lg p-8 border-4 border-[var(--text-gold)] shadow-[0_0_30px_rgba(204,0,0,0.5)] relative">
            <button id="changelog-btn" class="absolute top-4 right-4 px-4 py-2 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-[var(--text-light)] rounded-lg action-button text-sm border-2 border-[#cc0000] overflow-visible z-10">æ›´æ–°æ—¥å¿—</button>
            <div id="developer-mode-toggle" class="absolute top-16 right-4 px-4 py-2 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-[var(--text-light)] rounded-lg action-button text-sm border-2 border-[#cc0000] overflow-visible z-10 cursor-pointer">
                <span>å¼€å‘è€…æ¨¡å¼</span>
            </div>
            <h1 class="text-6xl md:text-8xl font-bold text-center title-font text-[var(--text-gold)] mb-2 animate-[glow_3s_ease-in-out_infinite,float_6s_ease-in-out_infinite]">ç‹¼äººæ€</h1>
            <h2 class="text-2xl md:text-4xl font-bold text-center title-font text-[var(--text-gold)] mb-8 animate-[glow_3s_ease-in-out_infinite,float_6s_ease-in-out_infinite_0.5s]">Werewolf Game</h2>
            <div class="flex flex-col items-center space-y-8">
                <div class="text-center">
                    <p class="text-2xl mb-6 title-font text-[var(--text-gold)] animate-[glow_3s_ease-in-out_infinite]">é€‰æ‹©æ¸¸æˆäººæ•°</p>
                    <div id="player-count-options" class="flex flex-col items-center space-y-4">
                        <div class="text-center">
                            <button data-count="6" class="px-8 py-4 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-[var(--text-light)] rounded-lg action-button text-xl border-2 border-[#cc0000]">
                                6äººå±€
                            </button>
                            <div class="mt-2 text-[var(--text-light)] text-sm">
                                ğŸºÃ—2 ğŸ”®Ã—1 ğŸŒ¿Ã—1 ğŸ§‘â€ğŸŒ¾Ã—2
                            </div>
                        </div>
                        <div class="text-center">
                            <button data-count="9" class="px-8 py-4 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-[var(--text-light)] rounded-lg action-button text-xl border-2 border-[#cc0000]">
                                9äººå±€
                            </button>
                            <div class="mt-2 text-[var(--text-light)] text-sm">
                                ğŸºÃ—3 ğŸ”®Ã—1 ğŸŒ¿Ã—1 ğŸ”«Ã—1 ğŸ§‘â€ğŸŒ¾Ã—3
                            </div>
                        </div>
                        <div class="text-center">
                            <button data-count="12" class="px-8 py-4 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-[var(--text-light)] rounded-lg action-button text-xl border-2 border-[#cc0000]">
                                12äººå±€
                            </button>
                            <div class="mt-2 text-[var(--text-light)] text-sm">
                                ğŸºÃ—4 ğŸ”®Ã—1 ğŸŒ¿Ã—1 ğŸ”«Ã—1 ğŸ˜Ã—1 ğŸ§‘â€ğŸŒ¾Ã—4
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full flex justify-center space-x-6">
                    <button id="start-game-btn" class="px-10 py-5 bg-[var(--secondary)] text-white font-bold rounded-lg action-button text-2xl border-2 border-[#cc0000] disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        å¼€å§‹æ¸¸æˆ
                    </button>
                    <button id="rules-btn" class="px-10 py-5 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-[var(--text-light)] rounded-lg action-button text-2xl border-2 border-[#cc0000]">
                        è§„åˆ™ä»‹ç»
                    </button>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="w-full max-w-6xl hidden">
            <!-- Time Bar -->
            <div id="time-bar" class="w-full text-center py-4 glass-morphism rounded-lg mb-6 border-2 border-[var(--accent)]">
                <p class="text-2xl font-bold">ç¬¬ <span id="day-counter">1</span> å¤© Â· <span id="day-night">å¤œæ™š</span> <span id="phase-indicator" class="phase-indicator"></span></p>
                <div class="timer-container">
                    <div id="timer-bar" class="timer-bar w-full"></div>
                </div>
            </div>

            <!-- Player Avatars -->
            <div id="status-bar" class="w-full flex justify-center flex-wrap gap-6 mb-8">
                <!-- Player avatars will be injected here -->
            </div>

            <!-- Main Game Area -->
            <div id="main-area" class="w-full flex flex-col lg:flex-row gap-6">
                <!-- Chat Area -->
                <div id="chat-area" class="flex-1 h-[500px] glass-morphism rounded-lg p-6 overflow-y-auto border-2 border-[var(--accent)]">
                    <!-- Chat messages will be injected here -->
                </div>

                <!-- Action Area -->
                <div id="action-area" class="w-full lg:w-1/3 glass-morphism rounded-lg p-6 border-2 border-[var(--accent)]">
                    <!-- Action buttons will be injected here -->
                </div>
            </div>
        </div>

        <!-- Rules Modal -->
        <div id="rules-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
            <div class="glass-morphism rounded-lg p-8 max-w-3xl w-full max-h-[80vh] overflow-y-auto border-4 border-[var(--accent)]">
                <h2 class="text-3xl font-bold text-[var(--text-gold)] mb-6 title-font">æ¸¸æˆè§„åˆ™</h2>
                <div id="rules-content" class="dialogue-font text-lg space-y-4">
                    <!-- Rules content will be injected here -->
                </div>
                <button id="close-rules-btn" class="mt-8 px-8 py-3 bg-[var(--secondary)] rounded-lg action-button text-xl border-2 border-[var(--accent)]">å…³é—­</button>
            </div>
        </div>
        
        <!-- Changelog Modal -->
        <div id="changelog-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
            <div class="glass-morphism rounded-lg p-8 max-w-3xl w-full max-h-[80vh] overflow-y-auto border-4 border-[var(--accent)]">
                <h2 class="text-3xl font-bold text-[var(--text-gold)] mb-6 title-font">æ›´æ–°æ—¥å¿—</h2>
                <div id="changelog-content" class="dialogue-font text-lg space-y-4">
                    <!-- Changelog content will be injected here -->
                </div>
                <button id="close-changelog-btn" class="mt-8 px-8 py-3 bg-[var(--secondary)] rounded-lg action-button text-xl border-2 border-[var(--accent)]">å…³é—­</button>
            </div>
        </div>
        
        <!-- Game Over Modal -->
        <div id="game-over-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
            <div class="glass-morphism rounded-lg p-8 max-w-3xl w-full max-h-[80vh] overflow-y-auto border-4 border-[var(--accent)]">
                <h2 class="text-4xl font-bold text-[var(--text-gold)] mb-6 title-font">æ¸¸æˆç»“æŸ</h2>
                <p id="game-over-message" class="text-3xl mb-8 dialogue-font text-center"></p>
                <div id="stats-container" class="mb-8 dialogue-font">
                    <!-- Stats will be injected here -->
                </div>
                <button id="game-statistics-btn" class="w-full py-4 mb-4 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-[var(--text-light)] rounded-lg action-button text-2xl border-2 border-[var(--accent)]">æœ¬å±€ç»Ÿè®¡</button>
                <button id="back-to-menu-btn" class="w-full py-4 bg-[var(--secondary)] rounded-lg action-button text-2xl border-2 border-[var(--accent)]">è¿”å›ä¸»èœå•</button>
            </div>
        </div>

        <!-- Game Statistics Modal -->
        <div id="game-statistics-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
            <div class="glass-morphism rounded-lg p-8 max-w-4xl w-full max-h-[80vh] overflow-y-auto border-4 border-[var(--accent)]">
                <h2 class="text-4xl font-bold text-[var(--text-gold)] mb-6 title-font">æœ¬å±€ç»Ÿè®¡</h2>
                <div id="statistics-content" class="dialogue-font text-lg space-y-6">
                    <!-- Statistics content will be injected here -->
                </div>
                <button id="close-statistics-btn" class="mt-8 w-full py-4 bg-[var(--secondary)] rounded-lg action-button text-2xl border-2 border-[var(--accent)]">å…³é—­</button>
            </div>
        </div>

        <!-- Voting Modal -->
        <div id="voting-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
            <div class="glass-morphism rounded-lg p-6 max-w-3xl w-full max-h-[80vh] border-4 border-[var(--accent)] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-[var(--text-gold)] title-font">æŠ•ç¥¨ç¯èŠ‚</h2>
                    <button id="minimize-voting-btn" class="bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-[var(--text-light)] rounded-full p-2 w-10 h-10 flex items-center justify-center">
                        <span>âˆ’</span>
                    </button>
                </div>
                
                <div id="voting-targets-container" class="flex-1 overflow-y-auto mb-6 max-h-[50vh]">
                    <!-- Voting targets will be injected here -->
                </div>
                
                <div id="voting-confirmation" class="hidden mb-4">
                    <p class="text-lg text-center" id="vote-confirm-text">ç¡®è®¤æŠ•ç¥¨ç»™XXX</p>
                    <div class="flex justify-center space-x-4">
                        <button id="confirm-vote-btn" class="px-6 py-2 bg-[var(--secondary)] rounded-lg action-button border-2 border-[var(--accent)]">ç¡®è®¤</button>
                        <button id="cancel-vote-btn" class="px-6 py-2 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-[var(--text-light)] rounded-lg action-button border-2 border-[var(--accent)]">å–æ¶ˆ</button>
                    </div>
                </div>
                
                <div id="abstain-container" class="flex justify-center">
                    <!-- Abstain button will be injected here -->
                </div>
            </div>
        </div>
        
        <!-- Minimized Voting Button -->
        <div id="minimized-voting-btn" class="fixed bottom-6 right-6 bg-gray-700 hover:bg-gray-600 text-white rounded-full w-16 h-16 flex items-center justify-center cursor-move z-50 hidden" style="cursor: move;">
            <span class="text-2xl">âš–ï¸</span>
        </div>
        

    </div>

    <script>
        class WerewolfGame {
            constructor() {
                this.players = [];
                this.currentPlayer = null;
                this.gamePhase = 'menu';
                this.currentDay = 0;
                this.currentPhase = '';
                this.playerCount = null;
                this.timer = null;
                this.timerDuration = 0;
                this.votes = {};
                this.actionInProgress = false;
                this.deathsThisNight = [];
                this.usedItems = { 'potion': false, 'poison': false, 'reportedPoison': false, 'reportedHeal': false };
                this.werewolfTarget = null;
                this.seerResults = {};
                this.witchHealTarget = null;
                this.witchPoisonTarget = null;
                this.speechOrder = [];
                this.currentSpeakerIndex = 0;
                this.gameOver = false;
                this.currentSpeechStep = 'main'; // 'main', 'claim', 'choose-target', 'choose-result'
                this.speechState = {};
                // å¼€å‘è€…æ¨¡å¼ç›¸å…³
                this.developerModeEnabled = false;
            }

            init() {
                // è·å–UIå…ƒç´ 
                this.getUIElements();
                this.bindMenuEvents();
                this.loadRules();
            }

            getUIElements() {
                // ä¸»èœå•UIå…ƒç´ 
                this.menuScreen = document.getElementById('menu-screen');
                this.gameScreen = document.getElementById('game-screen');
                this.rulesModal = document.getElementById('rules-modal');
                // å¼€å‘è€…æ¨¡å¼UIå…ƒç´ å·²ç§»é™¤ï¼Œæ”¹ä¸ºæŒ‰é’®
                this.gameOverModal = document.getElementById('game-over-modal');
                this.startGameBtn = document.getElementById('start-game-btn');
                this.rulesBtn = document.getElementById('rules-btn');
                this.closeRulesBtn = document.getElementById('close-rules-btn');
                this.backToMenuBtn = document.getElementById('back-to-menu-btn');
                this.playerCountOptions = document.getElementById('player-count-options');
                this.changelogBtn = document.getElementById('changelog-btn');
                
                // è°ƒè¯•ï¼šæ£€æŸ¥æ˜¯å¦è·å–åˆ°å…³é”®å…ƒç´ 
                console.log('UI Elements:', {
                    menuScreen: !!this.menuScreen,
                    startGameBtn: !!this.startGameBtn,
                    rulesBtn: !!this.rulesBtn,
                    playerCountOptions: !!this.playerCountOptions,
                    changelogBtn: !!this.changelogBtn
                });
                this.dayCounter = document.getElementById('day-counter');
                this.dayNightIndicator = document.getElementById('day-night');
                this.phaseIndicator = document.getElementById('phase-indicator');
                this.statusBar = document.getElementById('status-bar');
                this.chatArea = document.getElementById('chat-area');
                this.actionArea = document.getElementById('action-area');
                this.timerBar = document.getElementById('timer-bar');
                this.rulesContent = document.getElementById('rules-content');
                this.gameOverMessage = document.getElementById('game-over-message');
                this.statsContainer = document.getElementById('stats-container');
                this.changelogBtn = document.getElementById('changelog-btn');
                this.changelogModal = document.getElementById('changelog-modal');
                this.closeChangelogBtn = document.getElementById('close-changelog-btn');
                this.changelogContent = document.getElementById('changelog-content');
                this.gameStatisticsBtn = document.getElementById('game-statistics-btn');
                this.gameStatisticsModal = document.getElementById('game-statistics-modal');
                this.closeStatisticsBtn = document.getElementById('close-statistics-btn');
                // Voting UI Elements
                this.votingModal = document.getElementById('voting-modal');
                this.votingTargetsContainer = document.getElementById('voting-targets-container');
                this.votingConfirmation = document.getElementById('voting-confirmation');
                this.voteConfirmText = document.getElementById('vote-confirm-text');
                this.confirmVoteBtn = document.getElementById('confirm-vote-btn');
                this.cancelVoteBtn = document.getElementById('cancel-vote-btn');
                this.abstainContainer = document.getElementById('abstain-container');
                this.minimizeVotingBtn = document.getElementById('minimize-voting-btn');
                this.minimizedVotingBtn = document.getElementById('minimized-voting-btn');
                this.statisticsContent = document.getElementById('statistics-content');
            }

            bindMenuEvents() {
                console.log('Binding menu events...');
                
                // ä¸ºæ¯ä¸ªç©å®¶æ•°é‡é€‰æ‹©æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                const countButtons = this.playerCountOptions.querySelectorAll('button');
                console.log('Player count buttons found:', countButtons.length);
                
                countButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        console.log('Player count button clicked:', e.currentTarget.dataset.count);
                        
                        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                        countButtons.forEach(b => b.classList.remove('selected'));
                        
                        // æ·»åŠ é€‰ä¸­æ•ˆæœ
                        e.currentTarget.classList.add('selected');
                        
                        // æ·»åŠ è¡€çˆªå°åŠ¨ç”»æ•ˆæœ
                        e.currentTarget.classList.add('claw-effect');
                        setTimeout(() => {
                            e.currentTarget.classList.remove('claw-effect');
                        }, 600);
                        
                        this.playerCount = parseInt(e.currentTarget.dataset.count);
                        this.startGameBtn.disabled = false;
                        console.log('Start game button enabled:', !this.startGameBtn.disabled);
                    });
                });

                // ç»‘å®šå…¶ä»–èœå•æŒ‰é’®äº‹ä»¶
                if (this.startGameBtn) {
                    this.startGameBtn.addEventListener('click', () => {
                        console.log('Start game button clicked');
                        this.startGame();
                    });
                }
                
                if (this.rulesBtn) {
                    this.rulesBtn.addEventListener('click', () => {
                        console.log('Rules button clicked');
                        this.rulesModal.classList.remove('hidden');
                    });
                }
                
                if (this.closeRulesBtn) {
                    this.closeRulesBtn.addEventListener('click', () => {
                        console.log('Close rules button clicked');
                        this.rulesModal.classList.add('hidden');
                    });
                }
                
                if (this.backToMenuBtn) {
                    this.backToMenuBtn.addEventListener('click', () => {
                        console.log('Back to menu button clicked');
                        this.resetGame();
                    });
                }
                
                if (this.changelogBtn) {
                    this.changelogBtn.addEventListener('click', () => {
                        console.log('Changelog button clicked');
                        this.showChangelog();
                    });
                }
                
                if (this.closeChangelogBtn) {
                    this.closeChangelogBtn.addEventListener('click', () => {
                        console.log('Close changelog button clicked');
                        this.changelogModal.classList.add('hidden');
                    });
                }
                
                if (this.gameStatisticsBtn) {
                    this.gameStatisticsBtn.addEventListener('click', () => {
                        console.log('Game statistics button clicked');
                        this.showGameStatistics();
                    });
                }
                
                if (this.closeStatisticsBtn) {
                    this.closeStatisticsBtn.addEventListener('click', () => {
                        console.log('Close statistics button clicked');
                        this.gameStatisticsModal.classList.add('hidden');
                    });
                }
                
                // å¼€å‘è€…æ¨¡å¼æŒ‰é’®äº‹ä»¶
                const developerModeToggle = document.getElementById('developer-mode-toggle');
                if (developerModeToggle) {
                    // åŠ è½½ä¿å­˜çš„è®¾ç½®
                    const savedMode = localStorage.getItem('developerMode');
                    if (savedMode) {
                        this.developerModeEnabled = savedMode === 'true';
                    }
                    
                    developerModeToggle.addEventListener('click', () => {
                        if (this.developerModeEnabled) {
                            // å¦‚æœå·²ç»å¼€å¯ï¼Œç›´æ¥å…³é—­
                            this.developerModeEnabled = false;
                            localStorage.setItem('developerMode', this.developerModeEnabled);
                            console.log('Developer mode disabled');
                            alert('å¼€å‘è€…æ¨¡å¼å·²å…³é—­');
                        } else {
                            // å¦‚æœæœªå¼€å¯ï¼Œè¦æ±‚è¾“å…¥å¯†ç 
                            const password = prompt('è¯·è¾“å…¥å¼€å‘è€…æ¨¡å¼å¯†ç :');
                            if (password === 'mbbesy') {
                                this.developerModeEnabled = true;
                                localStorage.setItem('developerMode', this.developerModeEnabled);
                                console.log('Developer mode enabled');
                                alert('å¼€å‘è€…æ¨¡å¼å·²å¼€å¯');
                            } else {
                                alert('å¯†ç é”™è¯¯ï¼Œå¼€å‘è€…æ¨¡å¼æœªå¼€å¯');
                            }
                        }
                    });
                }
                

                
                console.log('Menu events bound successfully');
            }

            async showGameStatistics() {
            // æ¸…ç©ºç»Ÿè®¡å†…å®¹
            this.statisticsContent.innerHTML = '';
            
            // æ·»åŠ ç©å®¶ç»Ÿè®¡
            const userPlayer = this.players.find(p => p.isUser);
            if (userPlayer) {
                const userStats = document.createElement('div');
                userStats.className = 'player-stats bg-white bg-opacity-10 p-4 rounded-lg mb-6';
                userStats.innerHTML = `
                    <h3 class="text-2xl font-bold text-[var(--text-gold)] mb-2">ç©å®¶ç»Ÿè®¡</h3>
                    <div class="mb-2">æœ¬å±€æ­»å› ï¼š${this.getCauseOfDeathText(userPlayer.causeOfDeath)}</div>
                    <div>è¢«äººæŠ•è¿‡ ${userPlayer.voteCount} ç¥¨</div>
                `;
                this.statisticsContent.appendChild(userStats);
            }
            
            // æ·»åŠ AIç»Ÿè®¡
            const aiPlayers = this.players.filter(p => !p.isUser);
            const aiStatsSection = document.createElement('div');
            aiStatsSection.className = 'ai-stats mt-8';
            aiStatsSection.innerHTML = '<h3 class="text-2xl font-bold text-[var(--text-gold)] mb-4">AIç»Ÿè®¡</h3>';
            
            aiPlayers.forEach(ai => {
                const aiStatCard = document.createElement('div');
                aiStatCard.className = 'ai-stat-card bg-white bg-opacity-10 p-4 rounded-lg mb-4';
                
                let statsText = '';
                
                if (ai.role === 'werewolf') {
                    // å¦‚æœæ˜¯ç‹¼äººï¼Œæ˜¾ç¤ºé’ˆå¯¹å€¼ç»Ÿè®¡
                    const sortedTargeting = Object.entries(ai.ai.targetingLevels)
                        .map(([id, level]) => {
                            const targetPlayer = this.players.find(p => p.id === id);
                            return { id, name: targetPlayer ? targetPlayer.name : 'æœªçŸ¥', level };
                        })
                        .sort((a, b) => b.level - a.level);
                    
                    statsText = '<div class="mb-2">é’ˆå¯¹å€¼ç»Ÿè®¡ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š<br>';
                    sortedTargeting.forEach(({ name, level }, index) => {
                        statsText += `${index + 1}. ${name}: ${level.toFixed(1)}<br>`;
                    });
                    statsText += '</div>';
                } else {
                    // å¦‚æœä¸æ˜¯ç‹¼äººï¼Œæ˜¾ç¤ºæ€€ç–‘åº¦ç»Ÿè®¡
                    const sortedSuspicions = Object.entries(ai.ai.suspicionLevels)
                        .map(([id, level]) => {
                            const targetPlayer = this.players.find(p => p.id === id);
                            return { id, name: targetPlayer ? targetPlayer.name : 'æœªçŸ¥', level };
                        })
                        .sort((a, b) => b.level - a.level);
                    
                    statsText = '<div class="mb-2">æ€€ç–‘åº¦ç»Ÿè®¡ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š<br>';
                    sortedSuspicions.forEach(({ name, level }, index) => {
                        statsText += `${index + 1}. ${name}: ${level.toFixed(1)}<br>`;
                    });
                    statsText += '</div>';
                }
                
                aiStatCard.innerHTML = `
                    <h4 class="text-xl font-bold mb-2">${ai.name}ï¼ˆ${this.getRoleName(ai.role)}ï¼‰</h4>
                    ${statsText}
                    <div class="mb-2">æœ¬å±€æ­»å› ï¼š${this.getCauseOfDeathText(ai.causeOfDeath)}</div>
                    <div>è¢«äººæŠ•è¿‡ ${ai.voteCount} ç¥¨</div>
                `;
                
                aiStatsSection.appendChild(aiStatCard);
            });
            
            this.statisticsContent.appendChild(aiStatsSection);
            
            // æ˜¾ç¤ºç»Ÿè®¡æ¨¡æ€æ¡†
            this.gameStatisticsModal.classList.remove('hidden');
        }

        getCauseOfDeathText(causeOfDeath) {
            const causeTextMap = {
                'vote': 'è¢«æŠ•ç¥¨å¤„å†³',
                'werewolf': 'è¢«ç‹¼äººæ€å®³',
                'poison': 'è¢«å¥³å·«æ¯’æ­»',
                'shoot': 'è¢«çŒäººæªæ€'
            };
            return causeOfDeath ? causeTextMap[causeOfDeath] || 'æœªçŸ¥' : 'å­˜æ´»';
        }

        getRoleName(role) {
            const roleNameMap = {
                'werewolf': 'ç‹¼äºº',
                'seer': 'é¢„è¨€å®¶',
                'witch': 'å¥³å·«',
                'hunter': 'çŒäºº',
                'idiot': 'ç™½ç—´',
                'villager': 'å¹³æ°‘'
            };
            return roleNameMap[role] || 'æœªçŸ¥èº«ä»½';
        }

        showChangelog() {
            const changelog = `
                <div>
                    <h3 class="text-2xl font-bold text-[var(--text-gold)] mb-2">2025-12-16</h3>
                    <ul class="list-decimal pl-6 mb-6 space-y-2">
                        <li>ä¿®å¤å¥½äººAIä¸å¯¹å‡é¢„è¨€å®¶å¢åŠ æ€€ç–‘åº¦çš„é—®é¢˜ï¼šåœ¨å‡é¢„è¨€å®¶å‘è¨€é€»è¾‘ä¸­æ·»åŠ äº†handleSeerCheckInfoå‡½æ•°è°ƒç”¨</li>
                        <li>è°ƒæ•´è¢«é”™è¯¯æŸ¥éªŒçš„å¥½äººå¯¹å‡é¢„è¨€å®¶çš„æ€€ç–‘åº¦æœºåˆ¶ï¼šå½“æœ‰é¢„è¨€å®¶æ­»äº¡æ—¶ï¼Œè¢«é”™è¯¯æŸ¥éªŒä¸ºç‹¼äººçš„å¥½äººAIå¯¹å­˜æ´»å‡é¢„è¨€å®¶çš„æ€€ç–‘åº¦å¢åŠ é‡ä»0.25å€æ”¹ä¸º2å€</li>
                        <li>å…¶ä»–ç©å®¶å¯¹å‡é¢„è¨€å®¶ä¿¡æ¯çš„ååº”ä»ä¿æŒåŸæœ‰é€»è¾‘ï¼ˆå½“æœ‰é¢„è¨€å®¶æ­»äº¡æ—¶å‡å°‘75%çš„å½±å“ï¼‰</li>
                        <li>ä¿®æ”¹AIå¥³å·«æ¯’è¯å‘è¨€é€»è¾‘ï¼šæ¯’è¯ä½¿ç”¨åï¼ŒçœŸå®å¥³å·«å’Œä¼ªè£…å¥³å·«100%åœ¨ä¸‹ä¸€ä¸ªå‘è¨€ç¯èŠ‚å‡†ç¡®æ±‡æŠ¥æ¯’è¯ä½¿ç”¨æƒ…å†µ</li>
                        <li>é™åˆ¶åç»­æåŠåœºæ™¯ï¼šæ¯’è¯æ±‡æŠ¥åï¼ŒAIå¥³å·«å’Œä¼ªè£…å¥³å·«ä»…ä¼šå¶å°”æåŠè¯ç‰©å­˜é‡ï¼ˆå¦‚ä¸¤ç§è¯å‰‚å‡ä½¿ç”¨è¿‡ã€æ¯’è¯å·²ç”¨å®Œä½†è¿˜æœ‰è§£è¯ã€è§£è¯å·²ç”¨å®Œä½†è¿˜æœ‰æ¯’è¯ç­‰æƒ…å†µï¼‰</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-[var(--text-gold)] mb-2">2025-12-15</h3>
                    <ul class="list-decimal pl-6 mb-6 space-y-2">
                        <li>å¥³å·«æ•‘äººæ€€ç–‘åº¦å‡å°‘é€»è¾‘ä¿®æ­£ï¼šç§»é™¤å¤œé—´è‡ªåŠ¨å‡å°‘æœºåˆ¶ï¼Œä»…åœ¨å¹³å®‰å¤œå¥³å·«æ±‡æŠ¥æ—¶è§¦å‘</li>
                        <li>ä¿®æ”¹å¥³å·«å‘è¨€è§„åˆ™ï¼šçœŸå®å¥³å·«å’Œä¼ªè£…å¥³å·«ä»…åœ¨å¹³å®‰å¤œæ‰ä¼šæ±‡æŠ¥è‡ªå·±ä½¿ç”¨è§£è¯æ•‘äº†è°è°</li>
                        <li>å®Œå–„è¢«æ•‘ç©å®¶ååº”ï¼šè¢«æ•‘ç©å®¶åªæœ‰åœ¨å¥³å·«ç™½å¤©æ±‡æŠ¥æ—¶æ‰ä¼šå¯¹æ±‡æŠ¥è€…å‡å°‘30-40ç‚¹æ€€ç–‘åº¦</li>
                        <li>é™åˆ¶æ±‡æŠ¥åœºæ™¯ï¼šå¥³å·«åœ¨å…¶ä»–å¤©æ•°ä¸å†æåŠè§£æ•‘ä¿¡æ¯ï¼Œåªä¼šæœ‰æ¦‚ç‡æåŠè§£è¯å·²ç”¨å®Œ</li>
                        <li>æ›´æ–°äº†æŠ•ç¥¨UIï¼ŒæŠ•ç¥¨å°†ä¸å†åªåœ¨å…¬å±å’ŒçŠ¶æ€æ å±•ç¤ºï¼Œè€Œæ˜¯é€šè¿‡æ–°çª—å£ç»Ÿè®¡</li>
                        <li>ä¼˜åŒ–äº†ç‹¼äººçš„é’ˆå¯¹æ€§é€»è¾‘</li>
                        <li>å¦‚æœç™½ç—´è¢«æŠ•ç¥¨å‡ºå±€ä½†æ˜¯å› å…¶æŠ€èƒ½æ— æ³•å¤„å†³ï¼Œä¹‹åçš„æ¸¸æˆä¸­AIå°†ä¸å†ä»¥ç™½ç—´ä¸ºæŠ•ç¥¨ç›®æ ‡</li>
                        <li>å‡ç¥èŒæ±‡æŠ¥çš„ä¿¡æ¯å°†æ— æ³•å†å½±å“å¯¹åº”çœŸç¥èŒçš„åˆ¤æ–­</li>
                        <li>å‡å°‘äº†å‘è¨€è¡¨ç¤ºæ€€ç–‘æ—¶æ‰€å¸¦æ¥å…¶ä»–äººçš„æ€€ç–‘åº¦å½±å“ï¼Œé˜²æ­¢ç‹¼äººå¼ºåŠ¿å¸¦èŠ‚å¥</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-[var(--text-gold)] mb-2">2025-12-14</h3>
                    <ul class="list-decimal pl-6 mb-6 space-y-2">
                        <li>ä¼˜åŒ–æ¸¸æˆç»“æŸåçš„ç»“ç®—ç”»é¢ï¼šé™åˆ¶é«˜åº¦å¹¶æ·»åŠ æ»šåŠ¨åŠŸèƒ½</li>
                        <li>æ–°å¢ã€æœ¬å±€ç»Ÿè®¡ã€‘æŒ‰é’®ï¼Œç‚¹å‡»åå±•å¼€è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯</li>
                        <li>ç»Ÿè®¡åŠŸèƒ½åŒ…æ‹¬ï¼šç©å®¶æ­»å› ã€è¢«æŠ•ç¥¨æ•°ï¼ŒAIæ€€ç–‘åº¦ç»Ÿè®¡ï¼ˆä»é«˜åˆ°ä½ï¼‰ã€æ­»å› å’Œè¢«æŠ•ç¥¨æ•°</li>
                        <li>ä¿®å¤çŒäººæŠ€èƒ½ç›®æ ‡IDè§£æé”™è¯¯ï¼Œæ”¯æŒå¸¦è¿å­—ç¬¦çš„AI IDï¼ˆå¦‚"ai-1"ï¼‰</li>
                        <li>æ–°å¢ç¬¬ä¸€è½®å¼ƒç¥¨åŠŸèƒ½ï¼Œç©å®¶å’ŒAIå‡å¯é€‰æ‹©å¼ƒç¥¨</li>
                        <li>æ–°å¢é—è¨€ç¯èŠ‚ï¼Œç™½å¤©è¢«å¤„å†³çš„ç©å®¶å¯å‘è¡¨é—è¨€ï¼ˆç™½ç—´é™¤å¤–ï¼‰</li>
                        <li>ä¼˜åŒ–å¥³å·«ç™½å¤©å‘è¨€é€‰é¡¹ï¼Œå¢åŠ æ€€ç–‘/ä¿¡ä»»é€‰æ‹©</li>
                        <li>å®Œå–„AIèŒä¸šå¯¹è·³é€»è¾‘ï¼Œæ‰€æœ‰çœŸèŒä¸šAIä¼šå¢åŠ å¯¹è·³è€…çš„æ€€ç–‘åº¦</li>
                        <li>ä¿®å¤AIé¢„è¨€å®¶æŸ¥éªŒåçš„æ€€ç–‘åº¦è®¾å®šï¼Œç‹¼äººå›ºå®šä¸ºæœ€é«˜ï¼Œå¥½äººå›ºå®šä¸ºæœ€ä½</li>
                        <li>12äººå±€ç™½ç—´æŠ€èƒ½ä¼˜åŒ–ï¼Œè¢«æŠ•ç¥¨å‡ºå±€åAIå¯¹å…¶æ€€ç–‘åº¦é™è‡³æœ€ä½</li>
                        <li>æ–°å¢æ›´æ–°æ—¥å¿—åŠŸèƒ½ï¼Œå¯åœ¨ä¸»èœå•æŸ¥çœ‹æ¸¸æˆæ›´æ–°è®°å½•</li>
                        <li>ä¿®å¤æ¸¸æˆç»“æŸç•Œé¢è¿”å›ä¸»èœå•æŒ‰é’®å¤±çµé—®é¢˜</li>
                        <li>ä¼˜åŒ–AIå‘è¨€é€»è¾‘ï¼šæ€€ç–‘åº¦ä¸º0æ—¶ä¸è¡¨è¾¾æ€€ç–‘</li>
                        <li>æ›´æ–°å¥³å·«æ¯’è¯ä½¿ç”¨é€»è¾‘ï¼šç›®æ ‡æ€€ç–‘åº¦éœ€é«˜äºå’Œè‡ªèº«èŒä¸šå¯¹è·³æ—¶ç›®æ ‡æ‰€å˜åŠ¨çš„å€¼æ—¶å‘åŠ¨</li>
                        <li>è°ƒæ•´å¥³å·«å‘è¨€é€‰é¡¹ï¼šæ¯’æ€å‰éšè—æ¯’è¯è¡¨è¿°ï¼Œæ¯’æ€åAIæœ‰80%æ¦‚ç‡å£°æ˜</li>
                        <li>ä¿®å¤ç‹¼äººä¼ªè£…é€»è¾‘ï¼šæ¯å±€å›ºå®šä¸€ç§èº«ä»½</li>
                        <li>åˆ é™¤ç‹¼äººç©å®¶è‡ªæ›é€‰é¡¹</li>
                        <li>æ›´æ–°é¢„è¨€å®¶æ€€ç–‘åº¦å¤„ç†ï¼šå¯¹æŸ¥éªŒåˆ°ç‹¼äººçš„å¢åŠ 100æ€€ç–‘åº¦ï¼Œå¯¹å¥½äººå‡å°‘100æ€€ç–‘åº¦ï¼ˆä¸å†ç›´æ¥è®¾ç½®ä¸ºå›ºå®šå€¼ï¼‰</li>
                        <li>æ–°å¢å…¶ä»–ç©å®¶å¯¹è¢«æŸ¥éªŒè€…çš„æ€€ç–‘åº¦å˜åŒ–ï¼šå¬åˆ°é¢„è¨€å®¶æ±‡æŠ¥å¥½äººæ—¶å‡å°‘20~30ï¼Œæ±‡æŠ¥ç‹¼äººæ—¶å¢åŠ 20~30</li>
                        <li>ä¼˜åŒ–é¢„è¨€å®¶å£°ç§°ä¿¡ä»»ç³»ç»Ÿï¼šç¬¬ä¸€ä¸ªå£°ç§°è€…è·å¾—-30~-40ä¿¡ä»»åº¦ï¼Œåç»­å£°ç§°è€…è·å¾—-15~-30ï¼Œä¸”æ¯å±€åªå˜åŒ–ä¸€æ¬¡</li>
                        <li>æ–°å¢é¢„è¨€å®¶å¤œé—´æ­»äº¡å½±å“ï¼šå­˜æ´»çš„äººç±»AIä¼šå¯¹å…¶ä»–å£°ç§°é¢„è¨€å®¶çš„ç©å®¶å¢åŠ 60~80æ€€ç–‘åº¦ï¼Œä¸”è¿™äº›ç©å®¶åç»­æ±‡æŠ¥çš„æŸ¥éªŒä¿¡æ¯æ•ˆæœå‡è‡³1/4</li>
                    </ul>
                </div>
            `;
            this.changelogContent.innerHTML = changelog;
            this.changelogModal.classList.remove('hidden');
        }

        loadRules() {
            const rules = `
                <div>
                        <h3 class="text-2xl font-bold text-[var(--text-gold)] mb-2">æ¸¸æˆæµç¨‹</h3>
                        <p class="mb-4">æ¸¸æˆä»å¤œæ™šå¼€å§‹ï¼Œç‹¼äººæ€äººï¼Œç¥èŒäººå‘˜ä½¿ç”¨æŠ€èƒ½ï¼›ç™½å¤©ï¼Œæ‰€æœ‰äººå‘è¨€å¹¶æŠ•ç¥¨å¤„å†³å«Œç–‘äººã€‚</p>
                    </div>
                    
                    <div>
                        <h3 class="text-2xl font-bold text-[var(--text-gold)] mb-2">èŒä¸šä»‹ç»</h3>
                        <ul class="list-disc pl-6 mb-4 space-y-2">
                            <li><span class="role-werewolf">ğŸº ç‹¼äºº</span>ï¼šæ¯æ™šæ€æ­»ä¸€åç©å®¶ã€‚</li>
                            <li><span class="role-seer">ğŸ”® é¢„è¨€å®¶</span>ï¼šæ¯æ™šå¯ä»¥æŸ¥éªŒä¸€åç©å®¶çš„èº«ä»½ã€‚</li>
                            <li><span class="role-witch">ğŸŒ¿ å¥³å·«</span>ï¼šæ‹¥æœ‰ä¸€ç“¶è§£è¯å’Œä¸€ç“¶æ¯’è¯ã€‚</li>
                            <li><span class="role-hunter">ğŸ”« çŒäºº</span>ï¼šæ­»äº¡æ—¶å¯ä»¥å¼€æªå¸¦èµ°ä¸€äººï¼ˆéå¥³å·«æ¯’æ€ï¼‰ã€‚</li>
                            <li><span class="role-idiot">ğŸ˜ ç™½ç—´</span>ï¼šè¢«æŠ•ç¥¨å‡ºå±€æ—¶ä¸ä¼šæ­»äº¡ã€‚</li>
                            <li><span class="role-villager">ğŸ§‘â€ğŸŒ¾ å¹³æ°‘</span>ï¼šæ²¡æœ‰ç‰¹æ®Šèƒ½åŠ›ã€‚</li>
                        </ul>
                    </div>

                    <div>
                        <h3 class="text-2xl font-bold text-[var(--text-gold)] mb-2">äººæ•°é…ç½®</h3>
                        <ul class="list-disc pl-6 mb-4 space-y-2">
                            <li>6äººå±€ï¼šç‹¼äººğŸºÃ—2ã€é¢„è¨€å®¶ğŸ”®Ã—1ã€å¥³å·«ğŸŒ¿Ã—1ã€å¹³æ°‘ğŸ§‘â€ğŸŒ¾Ã—2</li>
                            <li>9äººå±€ï¼šç‹¼äººğŸºÃ—3ã€é¢„è¨€å®¶ğŸ”®Ã—1ã€å¥³å·«ğŸŒ¿Ã—1ã€çŒäººğŸ”«Ã—1ã€å¹³æ°‘ğŸ§‘â€ğŸŒ¾Ã—3</li>
                            <li>12äººå±€ï¼šç‹¼äººğŸºÃ—4ã€é¢„è¨€å®¶ğŸ”®Ã—1ã€å¥³å·«ğŸŒ¿Ã—1ã€çŒäººğŸ”«Ã—1ã€ç™½ç—´ğŸ˜Ã—1ã€å¹³æ°‘ğŸ§‘â€ğŸŒ¾Ã—4</li>
                        </ul>
                    </div>

                    <div>
                        <h3 class="text-2xl font-bold text-[var(--text-gold)] mb-2">èƒœè´Ÿæ¡ä»¶</h3>
                        <ul class="list-disc pl-6 space-y-2">
                            <li>å¥½äººèƒœåˆ©ï¼šæ‰€æœ‰ç‹¼äººæ­»äº¡ã€‚</li>
                            <li>ç‹¼äººèƒœåˆ©ï¼šåœºä¸Šç‹¼äººæ•°é‡ä¸å¥½äººæ•°é‡ç›¸ç­‰ã€‚</li>
                        </ul>
                    </div>
                `;
                this.rulesContent.innerHTML = rules;
            }

            startGame() {
                this.menuScreen.classList.add('hidden');
                this.gameScreen.classList.remove('hidden');
                this.initializeGame();
                this.startNightPhase();
            }

            initializeGame() {
                this.players = this.generatePlayers();
                this.assignRoles();
                this.currentPlayer = this.players.find(p => p.isUser);
                this.speechOrder = [...this.players].sort(() => Math.random() - 0.5).map(p => p.id);
                this.updateUI();
                this.logMessage(`æ¸¸æˆå¼€å§‹ï¼ä½ æ˜¯ <span class="role-${this.currentPlayer.role}">${this.getRoleName(this.currentPlayer.role)}</span>ã€‚`);
                
                if (this.currentPlayer.role === 'werewolf') {
                    const werewolfTeammates = this.players.filter(p => p.role === 'werewolf' && p.id !== this.currentPlayer.id).map(p => p.name);
                    this.logMessage(`ä½ çš„ç‹¼äººğŸºé˜Ÿå‹æ˜¯: ${werewolfTeammates.join('ã€')}ã€‚`, true);
                }
                
                // æ˜¾ç¤ºåˆå§‹æ€€ç–‘åº¦å’Œé’ˆå¯¹å€¼ï¼ˆå¼€å‘è€…æ¨¡å¼ï¼‰
                this.showInitialSuspicionLevels();
            }

            generatePlayers() {
                const players = [];
                const aiNames = [
                    'è‹”ç—•ä¿¡ç®±', 'å¥¶å‡¶', 'è‹ç³¯å½', 'æ‘¸é±¼ ing', 'æœˆäº®è½è‚©å¤´', 'æš—ææ‘‡', 'é’æŸ æ°”æ³¡', 'é‡çœ ', 
                    'å°ç†Šè½¯', 'æ‘†çƒ‚ ing', 'é›¾å»å±±èŒ¶', 'å‡¶å·´', 'å¤æ˜Ÿæ²‰', 'è½¯å…”æ³¡èŠ™', 'ç©ºé­‚', 'è–„è·å†°', 
                    'å†…è€— er', 'æ ¸å¼¹ã®è€ä¸‰', 'ç”œæ —', 'é›ªç„Šå†»', 'é²¸è½ä¸ƒç§’', 'çŒ«è¯­æŸ ', 'è½¯é›¾å›¢', 'æ¸©ä¸€å£¶æœˆå…‰', 
                    'å†·é›¾', 'ç³¯å›¢', 'èŠå£«ç„—æœˆ', 'æ‡’æ‘¸é±¼', 'æ¨±èŠ±æ³ªè½', 'æˆ‘å”å¾—è¦å‘½', 'èŠ±é—´æ¢¦', 'æ¡ƒå½ er', 
                    'éœœæº¯é›¾', 'é›¨æ¥æœˆ', 'è–„è·æ’éœ', 'è½¯é±¼ er', 'ç™½èŒ¶æ¸…', 'é‡é£åŸ', 'å¥‡å¦™çš„é˜¿æ³½', 'å±±æ²³èµ´äººé—´'
                ];
                const avatarColors = [
                    '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', 
                    '#F7DC6F', '#BB8FCE', '#85C1E9', '#F8C471', '#82E0AA', '#F1948A', '#AED6F1', 
                    '#85C1E9', '#D7BDE2', '#A9DFBF', '#F9E79F', '#FADBD8', '#D6EAF8'
                ];
                
                players.push({
                    id: 'user', 
                    name: 'ä½ ', 
                    isUser: true, 
                    role: null, 
                    claimedRole: null, 
                    alive: true, 
                    avatarColor: avatarColors[Math.floor(Math.random() * avatarColors.length)],
                    causeOfDeath: null,
                    voteCount: 0
                });
                
                const shuffledNames = aiNames.sort(() => Math.random() - 0.5);
                const shuffledColors = avatarColors.sort(() => Math.random() - 0.5);
                
                for (let i = 1; i < this.playerCount; i++) {
                    players.push({ 
                        id: `ai-${i}`, 
                        name: shuffledNames[i - 1], 
                        isUser: false, 
                        role: null, 
                        claimedRole: null, 
                        alive: true, 
                        avatarColor: shuffledColors[i - 1],
                        causeOfDeath: null,
                        voteCount: 0,
                        ai: {
                            suspicionLevels: {},
                            targetingLevels: {},
                            reactedToSeerClaims: [], // è·Ÿè¸ªå·²ç»å¯¹å“ªäº›å£°ç§°é¢„è¨€å®¶çš„ç©å®¶åšå‡ºè¿‡ååº”
                            roleClaimCounts: {}, // è·Ÿè¸ªæ¯ç§è§’è‰²çš„å£°ç§°æ¬¡æ•°ï¼Œç”¨äºè®¡ç®—æ€€ç–‘åº¦é™ä½é‡
                            ignoredPlayers: [] // è·Ÿè¸ªå·²ç»è¢«å¿½ç•¥çš„ç©å®¶ï¼Œä¸å†ç›¸ä¿¡å…¶å‘è¨€
                        }
                    });
                }
                return players;
            }

            assignRoles() {
                let roles = [];
                switch (this.playerCount) {
                    case 6:
                        roles = ['werewolf', 'werewolf', 'seer', 'witch', 'villager', 'villager'];
                        break;
                    case 9:
                        roles = ['werewolf', 'werewolf', 'werewolf', 'seer', 'witch', 'hunter', 'villager', 'villager', 'villager'];
                        break;
                    case 12:
                        roles = ['werewolf', 'werewolf', 'werewolf', 'werewolf', 'seer', 'witch', 'hunter', 'idiot', 'villager', 'villager', 'villager', 'villager'];
                        break;
                }
                roles = roles.sort(() => Math.random() - 0.5);
                this.players.forEach((player, index) => {
                    player.role = roles[index];
                    if (!player.isUser) {
                        this.players.forEach(p => {
                            if (p.id !== player.id) {
                                player.ai.suspicionLevels[p.id] = 0;
                                player.ai.targetingLevels[p.id] = 0;
                            }
                        });
                    }
                });
                
                // ç‹¼é˜Ÿå‹é—´é”å®šé’ˆå¯¹å€¼ä¸º-1000ï¼Œä¸å†å˜åŒ–
                const werewolves = this.players.filter(p => p.role === 'werewolf');
                werewolves.forEach(wolf => {
                    werewolves.forEach(teammate => {
                        if (wolf.id !== teammate.id && !wolf.isUser) {
                            wolf.ai.targetingLevels[teammate.id] = -1000;
                        }
                    });
                });
            }

            startNightPhase() {
                this.gamePhase = 'night';
                this.dayNightIndicator.textContent = 'å¤œæ™š';
                this.phaseIndicator.textContent = '';
                // é‡ç½®å¤œæ™šç›¸å…³çš„çŠ¶æ€
                this.deathsThisNight = [];
                this.werewolfTarget = null;
                this.witchHealTarget = null;
                this.witchPoisonTarget = null;
                this.logMessage('ã€å¤œå¹•é™ä¸´ï¼Œå¤©é»‘è¯·é—­çœ¼ã€‘', 'system');
                this.processNightPhase();
            }

            async processNightPhase() {
                try {
                    await this.delay(2000);
                    
                    // Seer phase
                    this.currentPhase = 'seer';
                    this.phaseIndicator.textContent = '- é¢„è¨€å®¶ğŸ”®è¯·è¡ŒåŠ¨';
                    this.logMessage('ã€é¢„è¨€å®¶æ­£åœ¨é€‰æ‹©æŸ¥éªŒç›®æ ‡ã€‘', 'system');
                    const seer = this.players.find(p => p.role === 'seer' && p.alive);
                    if (seer) {
                        if (seer.isUser) {
                            await this.userSeerAction();
                        } else {
                            await this.aiSeerAction(seer);
                        }
                    }
                    await this.delay(1500);

                    // Werewolf phase - ç¡®ä¿ç‹¼äººæ€»æ˜¯é€‰æ‹©ç›®æ ‡
                    this.currentPhase = 'werewolf';
                    this.phaseIndicator.textContent = '- ç‹¼äººğŸºè¯·è¡ŒåŠ¨';
                    this.logMessage('ã€ç‹¼äººå¼€å§‹è¡ŒåŠ¨ï¼ã€‘', 'system');
                    const aliveWerewolves = this.players.filter(p => p.role === 'werewolf' && p.alive);
                    if (aliveWerewolves.length > 0) {
                        if (aliveWerewolves.some(w => w.isUser)) {
                            await this.userWerewolfAction();
                        } else {
                            await this.aiWerewolfAction(aliveWerewolves);
                        }
                        
                        // ç¡®ä¿ç‹¼äººæœ‰ç›®æ ‡ï¼Œé˜²æ­¢ç©ºåˆ€
                        if (!this.werewolfTarget && aliveWerewolves.length > 0) {
                            const validTargets = this.players.filter(p => p.alive && p.role !== 'werewolf');
                            if (validTargets.length > 0) {
                                this.werewolfTarget = validTargets[Math.floor(Math.random() * validTargets.length)].id;
                                this.logMessage(`ã€ç‹¼äººéšæœºé€‰æ‹©äº†ç›®æ ‡ï¼š${this.players.find(p => p.id === this.werewolfTarget).name}ã€‘`, 'system');
                            }
                        }
                    }
                    await this.delay(1500);

                    // Witch phase
                    this.currentPhase = 'witch';
                    this.phaseIndicator.textContent = '- å¥³å·«è¯·è¡ŒåŠ¨';
                    this.logMessage('ã€å¥³å·«æ­£åœ¨é€‰æ‹©ç”¨è¯ã€‘', 'system');
                    const witch = this.players.find(p => p.role === 'witch' && p.alive);
                    if (witch) {
                        if (witch.isUser) {
                            await this.userWitchAction();
                        } else {
                            await this.aiWitchAction(witch);
                        }
                    }
                    await this.delay(1500);

                    // ç»“æŸå¤œæ™šé˜¶æ®µ
                    this.endNightPhase();
                } catch (error) {
                    console.error('å¤œæ™šé˜¶æ®µå‡ºé”™:', error);
                    this.logMessage('ã€æ¸¸æˆå‡ºç°é”™è¯¯ï¼Œæ­£åœ¨æ¢å¤...ã€‘', 'system');
                    this.endNightPhase();
                }
            }

            async userSeerAction() {
                return new Promise((resolve) => {
                    // è·å–å·²ç»æŸ¥éªŒè¿‡çš„ç›®æ ‡IDåˆ—è¡¨
                    const checkedTargets = Object.values(this.seerResults).map(result => result.targetId);
                    // è¿‡æ»¤æ‰è‡ªå·±å’Œå·²ç»æŸ¥éªŒè¿‡çš„ç›®æ ‡
                    const targets = this.players.filter(p => p.alive && p.id !== 'user' && !checkedTargets.includes(p.id));
                    
                    if (targets.length === 0) {
                        this.logMessage('å·²ç»æ²¡æœ‰å¯æŸ¥éªŒçš„ç©å®¶äº†ã€‚', true);
                        resolve();
                        return;
                    }
                    
                    // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—ç›®æ ‡
                    const sortedTargets = [...targets].sort((a, b) => {
                        return this.speechOrder.indexOf(a.id) - this.speechOrder.indexOf(b.id);
                    });
                    
                    this.showActionButtons('é€‰æ‹©è¦æŸ¥éªŒçš„ç©å®¶', sortedTargets.map(p => ({id: p.id, text: p.name})), (targetId) => {
                        const target = this.players.find(p => p.id === targetId);
                        const result = target.role === 'werewolf' ? 'ç‹¼äºº' : 'å¥½äºº';
                        this.seerResults['user'] = {targetId, result};
                        this.logMessage(`ä½ æŸ¥éªŒäº† ${target.name}ï¼Œä»–æ˜¯ ${result}ã€‚`, true);
                        resolve();
                    }, 30);
                });
            }

            async aiSeerAction(seer) {
                return new Promise((resolve) => {
                    this.startTimer(5);
                    setTimeout(() => {
                        // è·å–å·²ç»æŸ¥éªŒè¿‡çš„ç›®æ ‡IDåˆ—è¡¨
                        const checkedTargets = Object.values(this.seerResults).map(result => result.targetId);
                        // è¿‡æ»¤æ‰è‡ªå·±å’Œå·²ç»æŸ¥éªŒè¿‡çš„ç›®æ ‡
                        const targets = this.players.filter(p => p.alive && p.id !== seer.id && !checkedTargets.includes(p.id));
                        
                        if (targets.length === 0) {
                            console.log('AIé¢„è¨€å®¶ï¼šå·²ç»æ²¡æœ‰å¯æŸ¥éªŒçš„ç©å®¶äº†');
                            resolve();
                            return;
                        }
                        
                        const target = targets[Math.floor(Math.random() * targets.length)];
                        const result = target.role === 'werewolf' ? 'ç‹¼äºº' : 'å¥½äºº';
                        this.seerResults[seer.id] = {targetId: target.id, result};
                        // å¤„ç†é¢„è¨€å®¶æŸ¥éªŒä¿¡æ¯å¯¹æ€€ç–‘åº¦çš„å½±å“
                        this.updateSeerSuspicion(seer.id, target.id, result);
                        console.log(`AIé¢„è¨€å®¶${seer.name}æŸ¥éªŒäº†${target.name}ï¼Œç»“æœæ˜¯${result}`);
                        resolve();
                }, 1000 + Math.random() * 4000);
            });
        }

            async userWerewolfAction() {
                return new Promise((resolve) => {
                    const targets = this.players.filter(p => p.alive && p.role !== 'werewolf');
                    
                    // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—ç›®æ ‡
                    const sortedTargets = [...targets].sort((a, b) => {
                        return this.speechOrder.indexOf(a.id) - this.speechOrder.indexOf(b.id);
                    });
                    
                    this.showActionButtons('é€‰æ‹©è¦å‡»æ€çš„ç©å®¶', sortedTargets.map(p => ({id: p.id, text: p.name})), (targetId) => {
                        this.werewolfTarget = targetId;
                        this.logMessage(`ä½ é€‰æ‹©å‡»æ€ ${this.players.find(p => p.id === targetId).name}ã€‚`, true);
                        resolve();
                    }, 30);
                });
            }

            async aiWerewolfAction(werewolves) {
                return new Promise((resolve) => {
                    this.startTimer(5);
                    setTimeout(() => {
                        // é¦–å…ˆåŠ¨æ€æ›´æ–°ç‹¼äººé’ˆå¯¹æ€§å€¼
                        this.updateWerewolfTargetingLevels();
                        
                        // è·å–å½“å‰æ¸¸æˆé˜¶æ®µ
                        const currentDay = parseInt(document.getElementById('day-counter').textContent);
                        const currentPhase = document.getElementById('day-night').textContent;
                        const isFirstNight = currentDay === 1 && currentPhase === 'å¤œæ™š';
                        
                        let targetScores = {};
                        werewolves.forEach(wolf => {
                            this.players.forEach(p => {
                                if (p.alive && p.role !== 'werewolf') {
                                    if (!targetScores[p.id]) targetScores[p.id] = 0;
                                    
                                    if (isFirstNight) {
                                        // ç¬¬ä¸€å¤œå®Œå…¨å¹³ç­‰ï¼Œåªä½¿ç”¨åŸºç¡€å€¼
                                        targetScores[p.id] += wolf.ai.targetingLevels[p.id];
                                    } else {
                                        // éç¬¬ä¸€å¤œåº”ç”¨å®Œæ•´é€»è¾‘
                                        if (wolf.ai.suspicionLevels[p.id] < -50) {
                                            targetScores[p.id] -= 20; // å‡å°‘é’ˆå¯¹å€¼ï¼Œä¿æŠ¤ä¿¡ä»»ç‹¼äººçš„è§’è‰²
                                        }
                                        // ç›´æ¥æ£€æŸ¥ç©å®¶å£°ç§°çš„èº«ä»½ï¼Œå¢åŠ é’ˆå¯¹æ€§å€¼
                                        if (p.claimedRole && ['seer', 'witch', 'hunter', 'idiot'].includes(p.claimedRole)) {
                                            targetScores[p.id] += 15; // é¢å¤–å¢åŠ é’ˆå¯¹å£°ç§°ç¥èŒçš„ç©å®¶
                                        }
                                        targetScores[p.id] += wolf.ai.targetingLevels[p.id];
                                    }
                                }
                            });
                        });
                        // æ‰¾å‡ºé’ˆå¯¹åº¦æœ€é«˜çš„ç›®æ ‡ï¼Œå¦‚æœæœ‰å¤šä¸ªç›¸åŒåˆ†æ•°çš„ç›®æ ‡åˆ™éšæœºé€‰æ‹©
                        const sortedTargets = Object.entries(targetScores)
                            .sort(([,a], [,b]) => b - a);
                        
                        const highestScore = sortedTargets[0][1];
                        const candidates = sortedTargets
                            .filter(([,score]) => score === highestScore)
                            .map(([id]) => id);
                        
                        // ä»å€™é€‰è€…ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªç›®æ ‡ï¼Œç¡®ä¿ä¸ä¼šç©ºåˆ€
                        let targetId = candidates[Math.floor(Math.random() * candidates.length)];
                        
                        // 30%çš„å‡ ç‡éšæœºé€‰æ‹©å…¶ä»–ç›®æ ‡
                        if (Math.random() < 0.3 && candidates.length > 1) {
                            const validTargets = this.players.filter(p => p.alive && p.role !== 'werewolf');
                            const otherTargets = validTargets.filter(p => !candidates.includes(p.id));
                            if (otherTargets.length > 0) {
                                targetId = otherTargets[Math.floor(Math.random() * otherTargets.length)].id;
                            }
                        }
                        this.werewolfTarget = targetId;
                        resolve();
                    }, 1000 + Math.random() * 4000);
                });
            }

            async userWitchAction() {
                return new Promise((resolve) => {
                    try {
                        console.log('ç”¨æˆ·å¥³å·«å¼€å§‹è¡ŒåŠ¨');
                        
                        // å‘ç”¨æˆ·æ±‡æŠ¥æ˜¨æ™šæ­»äº¡ä¿¡æ¯
                        if (this.werewolfTarget) {
                            const target = this.players.find(p => p.id === this.werewolfTarget);
                            if (target) {
                                this.logMessage(`æ˜¨æ™šç‹¼äººæ”»å‡»äº† ${target.name}ã€‚`, true);
                            }
                        }
                        
                        // è®¾ç½®å®‰å…¨è¶…æ—¶æœºåˆ¶ï¼Œç¡®ä¿æ— è®ºå¦‚ä½•éƒ½ä¼šå®Œæˆè¡ŒåŠ¨
                        const safetyTimeout = setTimeout(() => {
                            console.log('ç”¨æˆ·å¥³å·«è¡ŒåŠ¨è¶…æ—¶ï¼Œå¼ºåˆ¶å®Œæˆ');
                            resolve();
                        }, 60000); // 60ç§’è¶…æ—¶ï¼Œç»™ç”¨æˆ·è¶³å¤Ÿçš„æ€è€ƒæ—¶é—´
                        
                        const actions = [];
                        if (!this.usedItems.potion && this.werewolfTarget) {
                            const target = this.players.find(p => p.id === this.werewolfTarget);
                            if (target) {
                                actions.push({id: 'heal', text: `ğŸ’Š ä½¿ç”¨è§£è¯æ•‘ ${target.name}`});
                            }
                        }
                        actions.push({id: 'no-heal', text: 'ä¸ä½¿ç”¨è§£è¯'});
                        
                        this.showActionButtons('é€‰æ‹©æ˜¯å¦ä½¿ç”¨è§£è¯ğŸ’Š', actions, async (action) => {
                            try {
                                if (action === 'heal') {
                                    this.witchHealTarget = this.werewolfTarget;
                                    this.usedItems.potion = true;
                                    this.logMessage('ä½ ä½¿ç”¨äº†è§£è¯ã€‚', true);
                                    console.log('ç”¨æˆ·å¥³å·«ä½¿ç”¨äº†è§£è¯ï¼Œç›®æ ‡:', this.werewolfTarget);
                                    // è¢«æ•‘çš„äººå¯¹å¥³å·«å¢åŠ ä¿¡ä»»åº¦
                                if (this.werewolfTarget) {
                                    // ç”¨æˆ·å¥³å·«å¯¹è¢«æ•‘çš„äººå¢åŠ ä¿¡ä»»åº¦ï¼ˆé™ä½æ€€ç–‘åº¦ï¼‰
                                    const witch = this.players.find(p => p.isUser);
                                    const target = this.players.find(p => p.id === this.werewolfTarget);
                                    if (witch && target && witch.ai.suspicionLevels) {
                                        witch.ai.suspicionLevels[target.id] = Math.max(-1000, (witch.ai.suspicionLevels[target.id] || 0) - 50);
                                        console.log(`${witch.name}å¯¹${target.name}çš„æ€€ç–‘åº¦é™ä½äº†50ç‚¹`);
                                        this.logSuspicionChange(`${witch.name}å¯¹${target.name}çš„æ€€ç–‘åº¦å‡å°‘äº†50ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(witch.ai.suspicionLevels[target.id])}`);
                                    }
                                }
                                } else {
                                    console.log('ç”¨æˆ·å¥³å·«é€‰æ‹©ä¸ä½¿ç”¨è§£è¯');
                                }
                                
                                await this.delay(500);
                                
                                // å¤„ç†æ¯’è¯é€‰æ‹©
                                try {
                                    const poisonActions = [];
                                    if (!this.usedItems.poison) {
                                        const validTargets = this.players.filter(p => p.alive && p.id !== 'user');
                                        
                                        // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—ç›®æ ‡
                                        const sortedTargets = [...validTargets].sort((a, b) => {
                                            return this.speechOrder.indexOf(a.id) - this.speechOrder.indexOf(b.id);
                                        });
                                        
                                        poisonActions.push(...sortedTargets.map(p => ({id: `poison-${p.id}`, text: `ğŸŒ¿ ä½¿ç”¨æ¯’è¯æ¯’ ${p.name}`})));
                                    }
                                    poisonActions.push({id: 'no-poison', text: 'ä¸ä½¿ç”¨æ¯’è¯'});
                                    
                                    if (poisonActions.length === 0) {
                                        console.log('æ²¡æœ‰æ¯’è¯é€‰æ‹©é€‰é¡¹ï¼Œç›´æ¥å®Œæˆ');
                                        clearTimeout(safetyTimeout);
                                        resolve();
                                        return;
                                    }
                                    
                                    this.showActionButtons('é€‰æ‹©æ˜¯å¦ä½¿ç”¨æ¯’è¯ğŸŒ¿', poisonActions, (action) => {
                                        try {
                                            if (action.startsWith('poison-')) {
                                                const targetId = action.substring(7); // ç§»é™¤'poison-'å‰ç¼€
                                                this.witchPoisonTarget = targetId;
                                                this.usedItems.poison = true;
                                                const target = this.players.find(p => p.id === targetId);
                                                if (target) {
                                                    this.logMessage(`ä½ ä½¿ç”¨æ¯’è¯æ¯’äº† ${target.name}ã€‚`, true);
                                                    console.log('ç”¨æˆ·å¥³å·«ä½¿ç”¨äº†æ¯’è¯ï¼Œç›®æ ‡:', targetId);
                                                }
                                            } else {
                                                console.log('ç”¨æˆ·å¥³å·«é€‰æ‹©ä¸ä½¿ç”¨æ¯’è¯');
                                            }
                                            clearTimeout(safetyTimeout);
                                            resolve();
                                        } catch (error) {
                                            console.error('ç”¨æˆ·å¥³å·«æ¯’è¯é€‰æ‹©å‡ºé”™:', error);
                                            clearTimeout(safetyTimeout);
                                            resolve();
                                        }
                                    }, 30);
                                } catch (error) {
                                    console.error('ç”¨æˆ·å¥³å·«æ¯’è¯å¤„ç†å‡ºé”™:', error);
                                    clearTimeout(safetyTimeout);
                                    resolve();
                                }
                            } catch (error) {
                                console.error('ç”¨æˆ·å¥³å·«è§£è¯é€‰æ‹©å‡ºé”™:', error);
                                clearTimeout(safetyTimeout);
                                resolve();
                            }
                        }, 30);
                    } catch (error) {
                        console.error('ç”¨æˆ·å¥³å·«è¡ŒåŠ¨åˆå§‹åŒ–å‡ºé”™:', error);
                        resolve();
                    }
                });
            }

            async aiWitchAction(witch) {
                return new Promise((resolve) => {
                    try {
                        this.startTimer(5);
                        
                        // æ·»åŠ ç³»ç»Ÿæ—¥å¿—ï¼Œéšè—å¥³å·«èº«ä»½
                        this.logMessage(`ã€å¥³å·«æ­£åœ¨æ€è€ƒç”¨è¯ã€‘`, 'system');
                        
                        // ç«‹å³è®¾ç½®ä¸€ä¸ªå®‰å…¨çš„è¶…æ—¶æœºåˆ¶ï¼Œç¡®ä¿æ— è®ºå¦‚ä½•éƒ½ä¼šresolve
                        const safetyTimeout = setTimeout(() => {
                            console.log('AIå¥³å·«è¡ŒåŠ¨è¶…æ—¶ï¼Œå¼ºåˆ¶å®Œæˆ');
                            this.logMessage(`ã€å¥³å·«å®Œæˆäº†å¤œæ™šè¡ŒåŠ¨ã€‘`, 'system');
                            resolve();
                        }, 8000); // 8ç§’è¶…æ—¶ï¼Œç¡®ä¿è¶³å¤Ÿé•¿çš„æ—¶é—´
                        
                        setTimeout(() => {
                            try {
                                // å¤„ç†è§£è¯ä½¿ç”¨
                                if (!this.usedItems.potion && this.werewolfTarget) {
                                    const target = this.players.find(p => p.id === this.werewolfTarget);
                                    if (target) {
                                        console.log(`å¥³å·«${witch.name}æ£€æŸ¥è§£è¯ä½¿ç”¨: ç›®æ ‡=${target.name}, å¥³å·«ID=${witch.id}, ç›®æ ‡ID=${target.id}, æ˜¯å¦è‡ªå·±=${this.werewolfTarget === witch.id}`);
                                        
                                        // å¦‚æœå¥³å·«è‡ªå·±è¢«æ€ï¼Œ100%ä½¿ç”¨è§£è¯ - ä¼˜å…ˆçº§æœ€é«˜
                                        if (this.werewolfTarget === witch.id) {
                                            console.log(`å¥³å·«${witch.name}ä½¿ç”¨è§£è¯æ•‘è‡ªå·±`);
                                            this.witchHealTarget = witch.id;
                                            this.usedItems.potion = true;
                                        } else {
                                            // å…¶ä»–æƒ…å†µçš„æ²»ç–—é€»è¾‘ - æ ¹æ®å¤©æ•°è°ƒæ•´æ²»ç–—æ¦‚ç‡
                                            const isFirstDay = this.currentDay === 0; // ç¬¬ä¸€æ™š
                                            const isSecondDay = this.currentDay === 1; // ç¬¬äºŒæ™š
                                            
                                            // ç¬¬ä¸€æ™šï¼š80%æ¦‚ç‡æ²»ç–—ï¼ˆé™¤éç›®æ ‡éå¸¸å¯ç–‘ï¼‰
                                            // ç¬¬äºŒæ™šï¼š60%æ¦‚ç‡æ²»ç–—  
                                            // åç»­å¤œæ™šï¼š40%æ¦‚ç‡æ²»ç–—
                                            let healProbability = 0.4;
                                            if (isFirstDay) healProbability = 0.8;
                                            else if (isSecondDay) healProbability = 0.6;
                                            
                                            // ä¿¡ä»»çš„äººæœ‰æ›´é«˜çš„æ²»ç–—æ¦‚ç‡
                                            if (witch.ai.suspicionLevels[target.id] < -50) {
                                                healProbability = Math.min(0.9, healProbability + 0.3);
                                            }
                                            // æ€€ç–‘çš„äººæœ‰æ›´ä½çš„æ²»ç–—æ¦‚ç‡
                                            else if (witch.ai.suspicionLevels[target.id] > 50) {
                                                healProbability = Math.max(0.1, healProbability - 0.3);
                                            }
                                            
                                            console.log(`å¥³å·«${witch.name}æ²»ç–—æ¦‚ç‡: ${(healProbability * 100).toFixed(1)}%, å¤©æ•°=${this.currentDay}, ç›®æ ‡ä¿¡ä»»åº¦=${witch.ai.suspicionLevels[target.id]}`);
                                            
                                            if (Math.random() < healProbability) {
                                                console.log(`å¥³å·«${witch.name}ä½¿ç”¨è§£è¯æ•‘${target.name}`);
                                                this.witchHealTarget = this.werewolfTarget;
                                                this.usedItems.potion = true;
                                                // è¢«æ•‘çš„äººå¯¹å¥³å·«å¢åŠ ä¿¡ä»»åº¦
                                                // å¥³å·«å¯¹è¢«æ•‘çš„äººå¢åŠ ä¿¡ä»»åº¦ï¼ˆé™ä½æ€€ç–‘åº¦ï¼‰
                                                if (witch.ai.suspicionLevels) {
                                                    witch.ai.suspicionLevels[target.id] = Math.max(-1000, (witch.ai.suspicionLevels[target.id] || 0) - 50);
                                                    console.log(`${witch.name}å¯¹${target.name}çš„æ€€ç–‘åº¦é™ä½äº†50ç‚¹`);
                                                    this.logSuspicionChange(`${witch.name}å¯¹${target.name}çš„æ€€ç–‘åº¦å‡å°‘äº†50ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(witch.ai.suspicionLevels[target.id])}`);
                                                }
                                            } else {
                                                console.log(`å¥³å·«${witch.name}å†³å®šä¸ä½¿ç”¨è§£è¯`);
                                                // ç¡®ä¿æ²»ç–—ç›®æ ‡ä¸ºç©º
                                                this.witchHealTarget = null;
                                            }
                                        }
                                    } else {
                                        console.log(`å¥³å·«${witch.name}: ç›®æ ‡ä¸å­˜åœ¨`);
                                    }
                                } else {
                                    console.log(`å¥³å·«${witch.name}: æ²¡æœ‰è§£è¯æˆ–æ²¡æœ‰ç‹¼äººç›®æ ‡`);
                                }
                                
                                setTimeout(() => {
                                    try {
                                        // å¤„ç†æ¯’è¯ä½¿ç”¨
                                        if (!this.usedItems.poison) {
                                            // èŒä¸šå¯¹è·³æ—¶çš„æ€€ç–‘åº¦é˜ˆå€¼ï¼ˆ60-80ï¼‰ï¼Œå¥³å·«åªä¼šåœ¨ç›®æ ‡æ€€ç–‘åº¦é«˜äºè¿™ä¸ªé˜ˆå€¼æ—¶ä½¿ç”¨æ¯’è¯
                                            const roleConflictThreshold = 70; // ä½¿ç”¨å¹³å‡å€¼ä½œä¸ºé˜ˆå€¼
                                            const suspiciousPlayers = this.players.filter(p => p.alive && p.id !== witch.id && witch.ai.suspicionLevels[p.id] > roleConflictThreshold);
                                            if (suspiciousPlayers.length > 0 && Math.random() < 0.7) {
                                                const target = suspiciousPlayers.sort((a, b) => witch.ai.suspicionLevels[b.id] - witch.ai.suspicionLevels[a.id])[0];
                                                this.witchPoisonTarget = target.id;
                                                this.usedItems.poison = true;
                                                console.log(`å¥³å·«${witch.name}ä½¿ç”¨æ¯’è¯ï¼Œç›®æ ‡:`, target.name, `æ€€ç–‘åº¦:`, witch.ai.suspicionLevels[target.id]);
                                            }
                                        }
                                        
                                        // æ¸…é™¤å®‰å…¨è¶…æ—¶å¹¶æ­£å¸¸å®Œæˆ
                                        clearTimeout(safetyTimeout);
                                        this.logMessage(`ã€å¥³å·«å®Œæˆäº†å¤œæ™šè¡ŒåŠ¨ã€‘`, 'system');
                                        resolve();
                                    } catch (error) {
                                        console.error('AIå¥³å·«æ¯’è¯å¤„ç†å‡ºé”™:', error);
                                        clearTimeout(safetyTimeout);
                                        resolve();
                                    }
                                }, 1000 + Math.random() * 1000);
                            } catch (error) {
                                console.error('AIå¥³å·«è§£è¯å¤„ç†å‡ºé”™:', error);
                                clearTimeout(safetyTimeout);
                                resolve();
                            }
                        }, 2000 + Math.random() * 2000);
                    } catch (error) {
                        console.error('AIå¥³å·«è¡ŒåŠ¨åˆå§‹åŒ–å‡ºé”™:', error);
                        resolve();
                    }
                });
            }

            async endNightPhase() {
                // æ£€æŸ¥å¥³å·«æ˜¯å¦å­˜æ´»
                const witch = this.players.find(p => p.role === 'witch' && p.alive);
                
                // å¦‚æœç‹¼äººæœ‰ç›®æ ‡ï¼Œæ£€æŸ¥æ˜¯å¦è¢«å¥³å·«æ•‘æ´»
                if (this.werewolfTarget) {
                    // å…³é”®ï¼šæ£€æŸ¥å¥³å·«æ˜¯å¦å·²ç»ä½¿ç”¨è§£è¯æ¥æ•‘è¿™ä¸ªç›®æ ‡
                    const witchHealedTarget = this.witchHealTarget === this.werewolfTarget;
                    
                    console.log(`å¤œæ™šç»“æŸåˆ¤å®š: ç‹¼äººç›®æ ‡=${this.werewolfTarget}, å¥³å·«=${witch?.name}, å¥³å·«å­˜æ´»=${witch?.alive}, æ²»ç–—ç›®æ ‡=${this.witchHealTarget}, å¥³å·«æ˜¯å¦æ•‘äº†è¿™ä¸ªç›®æ ‡=${witchHealedTarget}`);
                    
                    // å¦‚æœå¥³å·«å·²ç»ä½¿ç”¨è§£è¯æ•‘äº†è¿™ä¸ªç›®æ ‡ï¼Œåˆ™ç›®æ ‡ä¸ä¼šæ­»äº¡
                    if (witchHealedTarget) {
                        console.log(`ç›®æ ‡${this.werewolfTarget}è¢«å¥³å·«æ•‘æ´»`);
                        // ç›®æ ‡è¢«æ•‘æ´»ï¼Œä¸åŠ å…¥æ­»äº¡åˆ—è¡¨
                    } else {
                        // ç›®æ ‡æ²¡æœ‰è¢«å¥³å·«æ•‘æ´»ï¼Œä¼šæ­»äº¡
                        console.log(`ç›®æ ‡${this.werewolfTarget}æ­»äº¡`);
                        this.deathsThisNight.push(this.werewolfTarget);
                    }
                }
                
                // å¤„ç†æ¯’è¯
                if (this.witchPoisonTarget) {
                    this.deathsThisNight.push(this.witchPoisonTarget);
                }
                
                // å»é‡
                this.deathsThisNight = [...new Set(this.deathsThisNight)];

                this.gamePhase = 'day';
                this.currentDay++;
                this.dayCounter.textContent = this.currentDay;
                this.dayNightIndicator.textContent = 'ç™½å¤©';
                this.phaseIndicator.textContent = '';

                if (this.deathsThisNight.length > 0) {
                    this.logMessage(`ã€å¤©äº®äº†ï¼Œæ˜¨æ™š ${this.deathsThisNight.map(id => this.players.find(p => p.id === id).name).join('ã€')} æ­»å»ã€‘`, 'system');
                    
                    // å…ˆæ ‡è®°æ­»äº¡ç©å®¶
                    this.deathsThisNight.forEach(id => {
                        const player = this.players.find(p => p.id === id);
                        player.alive = false;
                        player.causeOfDeath = this.witchPoisonTarget === id ? 'poison' : 'werewolf'; // å¥³å·«æ¯’æ€æˆ–ç‹¼äººæ€å®³
                    });
                    
                    // å¤„ç†é¢„è¨€å®¶æ­»äº¡åçš„æ€€ç–‘åº¦å˜åŒ–
                    const seersDiedThisNight = this.deathsThisNight.filter(id => {
                        const player = this.players.find(p => p.id === id);
                        return player.claimedRole === 'seer';
                    });
                    
                    // å¦‚æœæœ‰å£°ç§°é¢„è¨€å®¶çš„ç©å®¶åœ¨å¤œé—´æ­»äº¡
                    if (seersDiedThisNight.length > 0) {
                        this.handleSeerDeath();
                    }
                    
                    // å…ˆå¤„ç†çŒäººæŠ€èƒ½ï¼Œç¡®ä¿åœ¨ç™½å¤©æ’­æŠ¥å‰å®Œæˆ
                    const huntersToTrigger = this.deathsThisNight.filter(id => {
                        const player = this.players.find(p => p.id === id);
                        return player.role === 'hunter' && this.witchPoisonTarget !== id;
                    });
                    
                    // å¤„ç†çŒäººæŠ€èƒ½ï¼Œç¡®ä¿åœ¨ç™½å¤©æ’­æŠ¥å‰å®Œæˆ
                    for (const hunterId of huntersToTrigger) {
                        const hunter = this.players.find(p => p.id === hunterId);
                        await this.triggerHunterSkill(hunter);
                    }
                    
                    // é‡æ–°è·å–æ­»äº¡ç©å®¶åˆ—è¡¨ï¼ŒåŒ…å«çŒäººæªæ€çš„ç›®æ ‡
                    const finalDeaths = [...new Set(this.deathsThisNight)];
                    
                    // å¤„ç†å¤œæ™šæ­»äº¡çš„ç¥èŒå£°ç§°è€…å¯¹å…¶ä»–ç›¸åŒå£°ç§°è€…çš„å½±å“
                    finalDeaths.forEach(deadId => {
                        const deadPlayer = this.players.find(p => p.id === deadId);
                        const claimedRole = deadPlayer.claimedRole;
                        
                        // åªå¤„ç†å£°ç§°ç¥èŒèº«ä»½çš„æ­»äº¡ç©å®¶
                        if (claimedRole && ['seer', 'witch', 'hunter', 'idiot'].includes(claimedRole)) {
                            // æ‰¾å‡ºæ‰€æœ‰å­˜æ´»çš„å£°ç§°ç›¸åŒç¥èŒèº«ä»½çš„ç©å®¶
                            const sameRoleClaimants = this.players.filter(p => 
                                p.alive && 
                                p.id !== deadId && 
                                p.claimedRole === claimedRole
                            );
                            
                            // å¯¹æ¯ä¸ªå­˜æ´»çš„ç›¸åŒç¥èŒå£°ç§°è€…ï¼Œè°ƒæ•´å…¶ä»–å¥½äººAIçš„æ€€ç–‘åº¦
                            sameRoleClaimants.forEach(claimant => {
                                // éå†æ‰€æœ‰å¥½äººAIç©å®¶
                                this.players.forEach(p => {
                                    if (!p.isUser && p.alive && p.role !== 'werewolf') {
                                        // è°ƒæ•´æ€€ç–‘åº¦
                                        let suspicion = p.ai.suspicionLevels[claimant.id] || 0;
                                        if (suspicion < 0) {
                                            // å¦‚æœæ€€ç–‘åº¦å°äº0ï¼Œæ”¹ä¸º0ç„¶ååŠ 60
                                            p.ai.suspicionLevels[claimant.id] = 0 + 60;
                                        } else {
                                            // å¦‚æœæ€€ç–‘åº¦å¤§äº0ï¼Œç›´æ¥åŠ 60
                                            p.ai.suspicionLevels[claimant.id] = Math.min(1000, suspicion + 60);
                                        }
                                        console.log(`${p.name}å¯¹${claimant.name}çš„æ€€ç–‘åº¦è°ƒæ•´ä¸º${p.ai.suspicionLevels[claimant.id]}ï¼ˆå› è·³${claimedRole}çš„${deadPlayer.name}å¤œæ™šæ­»äº¡ï¼‰`);
                                        
                                        // ä¸å†ç›¸ä¿¡è¯¥å­˜æ´»ç›®æ ‡çš„ä»»ä½•å‘è¨€
                                        if (!p.ai.ignoredPlayers.includes(claimant.id)) {
                                            p.ai.ignoredPlayers.push(claimant.id);
                                            console.log(`${p.name}å¼€å§‹å¿½ç•¥${claimant.name}çš„å‘è¨€ï¼ˆå› è·³${claimedRole}çš„${deadPlayer.name}å¤œæ™šæ­»äº¡ï¼‰`);
                                        }
                                    }
                                });
                            });
                        }
                    });
                } else {
                    this.logMessage('ã€å¤©äº®äº†ï¼Œæ˜¨æ™šå¹³å®‰å¤œã€‘', 'system');
                }
                
                this.updateUI();
                this.checkGameOver();
                if (!this.gameOver) {
                    this.startDayPhase();
                }
            }

            async triggerHunterSkill(hunter) {
                await this.delay(1000);
                this.logMessage(`ã€${hunter.name}ï¼ˆçŒäººï¼‰å‘åŠ¨æŠ€èƒ½ï¼ã€‘`, 'system');
                
                if (hunter.isUser) {
                    return new Promise((resolve) => {
                        const targets = this.players.filter(p => p.alive);
                        
                        // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—ç›®æ ‡
                        const sortedTargets = [...targets].sort((a, b) => {
                            return this.speechOrder.indexOf(a.id) - this.speechOrder.indexOf(b.id);
                        });
                        
                        const actions = [
                            ...sortedTargets.map(p => ({id: `shoot-${p.id}`, text: `å¼€æªå¸¦èµ° ${p.name}`})),
                            {id: 'no-shoot', text: 'ä¸å¼€æª'}
                        ];
                        this.showActionButtons('ä½ å¯ä»¥å¼€æªå¸¦èµ°ä¸€äºº', actions, (action) => {
                            if (action.startsWith('shoot-')) {
                                const targetId = action.substring(6); // ä»ç¬¬6ä¸ªå­—ç¬¦å¼€å§‹ï¼ˆè·³è¿‡"shoot-"ï¼‰
                                const target = this.players.find(p => p.id === targetId);
                                if (target && target.alive) {
                                    // ç¡®ä¿ç›®æ ‡æ­»äº¡ï¼Œä½¿ç”¨ä¸æŠ•ç¥¨å¤„å†³ç›¸åŒçš„é€»è¾‘
                                    target.alive = false;
                                    target.causeOfDeath = 'shoot'; // çŒäººæªæ€
                                    
                                    // å°†ç›®æ ‡æ·»åŠ åˆ°æ­»äº¡åˆ—è¡¨ä¸­ï¼Œç¡®ä¿ä¸å¥³å·«æ¯’è¯é€»è¾‘ä¸€è‡´
                                    if (!this.deathsThisNight.includes(targetId)) {
                                        this.deathsThisNight.push(targetId);
                                    }
                                    
                                    console.log(`çŒäºº${hunter.name}å¼€æªå¸¦èµ°äº†${target.name}ï¼Œç›®æ ‡ID: ${targetId}ï¼Œæ­»äº¡å‰çŠ¶æ€: alive=${target.alive}`);
                                    
                                    // ç«‹å³ä»å­˜æ´»ç©å®¶åˆ—è¡¨ä¸­ç§»é™¤
                                    const targetIndex = this.players.findIndex(p => p.id === targetId);
                                    if (targetIndex !== -1) {
                                        this.players[targetIndex].alive = false;
                                        this.players[targetIndex].causeOfDeath = 'shoot'; // çŒäººæªæ€
                                        console.log(`ç¡®è®¤æ›´æ–°ç©å®¶åˆ—è¡¨ä¸­çš„çŠ¶æ€ï¼Œå½“å‰çŠ¶æ€: alive=${this.players[targetIndex].alive}`);
                                    }
                                    
                                    this.logMessage(`${hunter.name} å¼€æªå¸¦èµ°äº† ${target.name}ï¼`, 'system');
                                    
                                    // ç«‹å³æ›´æ–°UIï¼Œç¡®ä¿ç›®æ ‡æ­»äº¡çŠ¶æ€æ˜¾ç¤º
                                    this.updateUI();
                                    
                                    // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
                                    this.checkGameOver();
                                    
                                    // æ£€æŸ¥è¢«å¸¦èµ°çš„æ˜¯å¦ä¹Ÿæ˜¯çŒäºº
                                    if (target.role === 'hunter' && this.witchPoisonTarget !== targetId) {
                                        this.triggerHunterSkill(target).then(() => resolve());
                                    } else {
                                        resolve();
                                    }
                                } else {
                                    resolve();
                                }
                            } else {
                                this.logMessage(`${hunter.name} é€‰æ‹©ä¸å¼€æªã€‚`);
                                resolve();
                            }
                        }, 30);
                    });
                } else {
                    // AIçŒäººé€»è¾‘
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            // ç­›é€‰å‡ºæ‰€æœ‰å­˜æ´»ä¸”ä¸æ˜¯è‡ªå·±çš„ç©å®¶
                        const targets = this.players.filter(p => p.alive && p.id !== hunter.id);
                        if (targets.length > 0) {
                            // é€‰æ‹©æ€€ç–‘åº¦æœ€é«˜çš„ç©å®¶
                            const target = targets.sort((a, b) => 
                                hunter.ai.suspicionLevels[b.id] - hunter.ai.suspicionLevels[a.id]
                            )[0];
                                
                                // ç¡®ä¿ç›®æ ‡æ­»äº¡ï¼Œä½¿ç”¨ä¸æŠ•ç¥¨å¤„å†³ç›¸åŒçš„é€»è¾‘
                                target.alive = false;
                                target.causeOfDeath = 'shoot'; // çŒäººæªæ€
                                console.log(`AIçŒäºº${hunter.name}å¼€æªå¸¦èµ°äº†${target.name}ï¼Œç›®æ ‡ID: ${target.id}ï¼Œæ­»äº¡å‰çŠ¶æ€: alive=${target.alive}`);
                                
                                // ç«‹å³ä»å­˜æ´»ç©å®¶åˆ—è¡¨ä¸­ç§»é™¤
                                const targetIndex = this.players.findIndex(p => p.id === target.id);
                                if (targetIndex !== -1) {
                                    this.players[targetIndex].alive = false;
                                    this.players[targetIndex].causeOfDeath = 'shoot'; // çŒäººæªæ€
                                    console.log(`ç¡®è®¤æ›´æ–°ç©å®¶åˆ—è¡¨ä¸­çš„çŠ¶æ€ï¼Œå½“å‰çŠ¶æ€: alive=${this.players[targetIndex].alive}`);
                                }
                                
                                this.logMessage(`${hunter.name} å¼€æªå¸¦èµ°äº† ${target.name}ï¼`, 'system');
                                
                                // ç«‹å³æ›´æ–°UIï¼Œç¡®ä¿ç›®æ ‡æ­»äº¡çŠ¶æ€æ˜¾ç¤º
                                this.updateUI();
                                
                                // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
                                this.checkGameOver();
                                
                                // æ£€æŸ¥è¢«å¸¦èµ°çš„æ˜¯å¦ä¹Ÿæ˜¯çŒäºº
                                if (target.role === 'hunter' && this.witchPoisonTarget !== target.id) {
                                    this.triggerHunterSkill(target).then(() => resolve());
                                } else {
                                    resolve();
                                }
                            } else {
                                this.logMessage(`${hunter.name} æ²¡æœ‰å¯é€‰æ‹©çš„ç›®æ ‡ã€‚`);
                                resolve();
                            }
                        }, 2000 + Math.random() * 3000);
                    });
                }
            }

            startDayPhase() {
                this.currentSpeakerIndex = 0;
                this.conductSpeech();
            }

            async conductSpeech() {
                while (this.currentSpeakerIndex < this.speechOrder.length) {
                    const speakerId = this.speechOrder[this.currentSpeakerIndex];
                    const speaker = this.players.find(p => p.id === speakerId);
                    if (speaker.alive) {
                        this.logMessage(`ã€ç°åœ¨åˆ° ${speaker.name} å‘è¨€ã€‘`, 'system');
                        if (speaker.isUser) {
                            this.speechState = { step: 'main', role: null, target: null, result: null };
                            try {
                                await this.userSpeech();
                                console.log('ç”¨æˆ·å‘è¨€å®Œæˆ');
                            } catch (error) {
                                console.error('ç”¨æˆ·å‘è¨€å‡ºé”™:', error);
                            }
                        } else {
                            await this.aiSpeech(speaker);
                        }
                    } else {
                        this.logMessage(`ã€${speaker.name} å·²ç¦»å¼€ï¼Œè·³è¿‡å‘è¨€ã€‘`, 'system');
                    }
                    this.currentSpeakerIndex++;
                    await this.delay(1000);
                }
                this.startVotingPhase();
            }

            async userSpeech() {
                console.log('å¼€å§‹ç”¨æˆ·å‘è¨€');
                return new Promise((resolve) => {
                    // ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©è¦å£°ç§°çš„èº«ä»½
                    const showRoleSelection = () => {
                        const roleOptions = [];
                        
                        // æ ¹æ®çœŸå®èº«ä»½æä¾›ä¸åŒçš„é€‰æ‹©
                        if (this.currentPlayer.role === 'werewolf') {
                            roleOptions.push(
                                {id: 'claim-seer', text: 'é¢„è¨€å®¶ï¼ˆä¼ªè£…ï¼‰'},
                                {id: 'claim-witch', text: 'å¥³å·«ï¼ˆä¼ªè£…ï¼‰'},
                                {id: 'claim-hunter', text: 'çŒäººï¼ˆä¼ªè£…ï¼‰'},
                                ...(this.playerCount === 12 ? [{id: 'claim-idiot', text: 'ç™½ç—´ï¼ˆä¼ªè£…ï¼‰'}] : []),
                                {id: 'claim-villager', text: 'å¹³æ°‘ï¼ˆä¼ªè£…ï¼‰'}
                            );
                        } else {
                            roleOptions.push(
                                {id: `claim-${this.currentPlayer.role}`, text: `${this.getRoleName(this.currentPlayer.role)}ï¼ˆçœŸå®èº«ä»½ï¼‰`},
                                {id: 'claim-seer', text: 'é¢„è¨€å®¶ï¼ˆä¼ªè£…ï¼‰'},
                                {id: 'claim-witch', text: 'å¥³å·«ï¼ˆä¼ªè£…ï¼‰'},
                                {id: 'claim-hunter', text: 'çŒäººï¼ˆä¼ªè£…ï¼‰'},
                                ...(this.playerCount === 12 ? [{id: 'claim-idiot', text: 'ç™½ç—´ï¼ˆä¼ªè£…ï¼‰'}] : []),
                                {id: 'claim-villager', text: 'å¹³æ°‘ï¼ˆä¼ªè£…ï¼‰'}
                            );
                        }

                        this.showActionButtons('é€‰æ‹©ä½ è¦å£°ç§°çš„èº«ä»½', roleOptions, handleRoleClaim, 30);
                    };

                    // ç¬¬äºŒæ­¥ï¼šå¤„ç†èº«ä»½å£°ç§°
                    const handleRoleClaim = (roleClaimId) => {
                        console.log('ç”¨æˆ·é€‰æ‹©äº†èº«ä»½:', roleClaimId);
                        const claimedRole = roleClaimId.split('-')[1];
                        this.currentPlayer.claimedRole = claimedRole; // æ›´æ–°å£°ç§°çš„èº«ä»½
                        this.logMessage(`"æˆ‘æ˜¯ ${this.getRoleName(claimedRole)}ã€‚"`, 'normal', this.currentPlayer);
                        
                        // æ ¹æ®å£°ç§°çš„èº«ä»½æ˜¾ç¤ºä¸åŒçš„ä¿¡æ¯é€‰é¡¹
                        showRoleSpecificOptions(claimedRole);
                        
                        // å¤„ç†èŒä¸šå¯¹è·³çš„æ€€ç–‘åº¦å˜åŒ–
                        this.handleRoleCounterclaim(this.currentPlayer.id, claimedRole);
                    };

                    // ç¬¬ä¸‰æ­¥ï¼šæ˜¾ç¤ºèº«ä»½ç›¸å…³çš„ä¿¡æ¯é€‰é¡¹
                    const showRoleSpecificOptions = (claimedRole) => {
                        console.log('æ˜¾ç¤ºèº«ä»½ç›¸å…³é€‰é¡¹:', claimedRole);
                        const options = [];

                        // é¢„è¨€å®¶é€‰é¡¹
                        if (claimedRole === 'seer') {
                            options.push(
                                {id: 'seer-check', text: 'æŠ¥æŸ¥éªŒä¿¡æ¯'},
                                {id: 'no-info', text: 'ä¸æŠ¥æŸ¥éªŒä¿¡æ¯'}
                            );
                        }
                        // å¥³å·«é€‰é¡¹
                        else if (claimedRole === 'witch') {
                            options.push(
                                {id: 'witch-info', text: 'æŠ¥æ•‘è¯/æ¯’è¯ä¿¡æ¯'},
                                {id: 'no-info', text: 'ä¸æŠ¥ç”¨è¯ä¿¡æ¯'},
                                {id: 'suspect', text: 'æ€€ç–‘æŸäºº'},
                                {id: 'trust', text: 'ä¿¡ä»»æŸäºº'}
                            );
                        }
                        // çŒäººé€‰é¡¹
                        else if (claimedRole === 'hunter') {
                            options.push(
                                {id: 'hunter-claim', text: 'å¼ºåŠ¿å¸¦é˜Ÿ'},
                                {id: 'no-info', text: 'ä½è°ƒå‘è¨€'}
                            );
                        }
                        // ç™½ç—´é€‰é¡¹
                        else if (claimedRole === 'idiot') {
                            options.push(
                                {id: 'idiot-claim', text: 'å¼ºè°ƒå…æ­»èƒ½åŠ›'},
                                {id: 'no-info', text: 'ä½è°ƒå‘è¨€'}
                            );
                        }
                        // ç‹¼äººé€‰é¡¹
                        else if (claimedRole === 'werewolf') {
                            options.push(
                                {id: 'wolf-teammate', text: 'ä¿é˜Ÿå‹'},
                                {id: 'wolf-suspect', text: 'è¸©å¥½äºº'},
                                {id: 'no-info', text: 'å…¶ä»–å‘è¨€'}
                            );
                        }
                        // å¹³æ°‘é€‰é¡¹
                        else {
                            options.push(
                                {id: 'suspect', text: 'æ€€ç–‘æŸäºº'},
                                {id: 'trust', text: 'ä¿¡ä»»æŸäºº'},
                                {id: 'no-info', text: 'å…¶ä»–å‘è¨€'}
                            );
                        }

                        options.push({id: 'end-speech', text: 'ç»“æŸå‘è¨€'});

                        this.showActionButtons('é€‰æ‹©è¦æä¾›çš„ä¿¡æ¯', options, handleInfoOption, 30);
                    };

                    // ç¬¬å››æ­¥ï¼šå¤„ç†ä¿¡æ¯é€‰é¡¹
                    const handleInfoOption = (optionId) => {
                        console.log('ç”¨æˆ·é€‰æ‹©äº†ä¿¡æ¯é€‰é¡¹:', optionId);
                        switch (optionId) {
                            case 'seer-check':
                                // é¢„è¨€å®¶æŸ¥éªŒä¿¡æ¯ - å…è®¸é€‰æ‹©æ‰€æœ‰ç©å®¶ï¼ˆåŒ…æ‹¬å·²ç¦»å¼€ç©å®¶ï¼‰
                                const seerTargets = this.players;
                                
                                // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—ç›®æ ‡
                                const sortedSeerTargets = [...seerTargets].sort((a, b) => {
                                    return this.speechOrder.indexOf(a.id) - this.speechOrder.indexOf(b.id);
                                });
                                
                                this.showActionButtons('é€‰æ‹©æŸ¥éªŒç›®æ ‡', sortedSeerTargets.map(p => ({id: p.id, text: `${p.name}${!p.alive ? 'ï¼ˆå·²ç¦»å¼€ï¼‰' : ''}`})), (targetId) => {
                                    const results = [
                                        {id: 'werewolf', text: 'æŸ¥æ€ï¼ˆç‹¼äººï¼‰'},
                                        {id: 'villager', text: 'é‡‘æ°´ï¼ˆå¥½äººï¼‰'}
                                    ];
                                    this.showActionButtons('é€‰æ‹©æŸ¥éªŒç»“æœ', results, (resultId) => {
                                        const target = this.players.find(p => p.id === targetId);
                                        const resultText = resultId === 'werewolf' ? 'ç‹¼äºº' : 'å¥½äºº';
                                        this.logMessage(`"æˆ‘æ˜¯é¢„è¨€å®¶ï¼Œæ˜¨æ™šæŸ¥éªŒäº† ${target.name}ï¼Œä»–æ˜¯ ${resultText}ã€‚"`, 'normal', this.currentPlayer);
                                        // å¤„ç†é¢„è¨€å®¶æŸ¥éªŒä¿¡æ¯å¯¹æ€€ç–‘åº¦çš„å½±å“
                                        this.handleSeerCheckInfo('user', targetId, resultId === 'werewolf' ? 'ç‹¼äºº' : 'å¥½äºº');
                                        if (resultId === 'werewolf') {
                                            this.updateAISuspicion(targetId, this.currentPlayer.id);
                                        }
                                        hasMadeAdditionalSpeech = true;
                                        showAdditionalOptions();
                                    }, 30);
                                }, 30);
                                break;

                            case 'witch-info':
                                // å¥³å·«ç”¨è¯ä¿¡æ¯
                                const witchOptions = [
                                    {id: 'witch-save', text: 'æŠ¥æ•‘è¯ä½¿ç”¨æƒ…å†µ'},
                                    {id: 'witch-none', text: 'æŠ¥æ²¡ç”¨è¯'}
                                ];
                                // åªæœ‰åœ¨æœ‰äººè¢«æ¯’æ€åæ‰æ˜¾ç¤ºæ¯’è¯ä½¿ç”¨æƒ…å†µé€‰é¡¹
                                const hasPoisonedPlayer = this.players.some(p => p.causeOfDeath === 'poison' || this.witchPoisonTarget);
                                if (hasPoisonedPlayer) {
                                    witchOptions.push({id: 'witch-kill', text: 'æŠ¥æ¯’è¯ä½¿ç”¨æƒ…å†µ'});
                                }
                                this.showActionButtons('é€‰æ‹©è¦æŠ¥çš„ä¿¡æ¯', witchOptions, (witchOptionId) => {
                                    if (witchOptionId === 'witch-save') {
                                        // å…è®¸é€‰æ‹©æ‰€æœ‰ç©å®¶ï¼ˆåŒ…æ‹¬å·²ç¦»å¼€ç©å®¶ï¼‰
                                        const saveTargets = this.players;
                                        
                                        // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—ç›®æ ‡
                                    const sortedSaveTargets = [...saveTargets].sort((a, b) => {
                                        return this.speechOrder.indexOf(a.id) - this.speechOrder.indexOf(b.id);
                                    });
                                        
                                        this.showActionButtons('é€‰æ‹©æ•‘è¿‡çš„äºº', sortedSaveTargets.map(p => ({id: p.id, text: `${p.name}${!p.alive ? 'ï¼ˆå·²ç¦»å¼€ï¼‰' : ''}`})), (targetId) => {
                                            const target = this.players.find(p => p.id === targetId);
                                            this.logMessage(`"æˆ‘æ˜¯å¥³å·«ï¼Œæˆ‘æ•‘è¿‡ ${target.name}ï¼Œä»–æ˜¯å¥½äººã€‚"`, 'normal', this.currentPlayer);
                                            // å¤„ç†å¥³å·«æ•‘äººä¿¡æ¯å¯¹æ€€ç–‘åº¦çš„å½±å“
                                            this.handleWitchHealInfo('user', targetId);
                                            hasMadeAdditionalSpeech = true;
                                            showAdditionalOptions();
                                        }, 30);
                                    } else if (witchOptionId === 'witch-kill') {
                                        // å…è®¸é€‰æ‹©æ‰€æœ‰ç©å®¶ï¼ˆåŒ…æ‹¬å·²ç¦»å¼€ç©å®¶ï¼‰
                                        const killTargets = this.players;
                                        // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—ç›®æ ‡
                                    const sortedKillTargets = [...killTargets].sort((a, b) => {
                                        return this.speechOrder.indexOf(a.id) - this.speechOrder.indexOf(b.id);
                                    });
                                        this.showActionButtons('é€‰æ‹©å¤„ç†è¿‡çš„äºº', sortedKillTargets.map(p => ({id: p.id, text: `${p.name}${!p.alive ? 'ï¼ˆå·²ç¦»å¼€ï¼‰' : ''}`})), (targetId) => {
                                            const target = this.players.find(p => p.id === targetId);
                                            this.logMessage(`"æˆ‘æ˜¯å¥³å·«ï¼Œæˆ‘æ¯’æ­»äº† ${target.name}ï¼Œä»–æ˜¯ç‹¼äººã€‚"`, 'normal', this.currentPlayer);
                                            hasMadeAdditionalSpeech = true;
                                        showAdditionalOptions();
                                        }, 30);
                                    } else {
                                        this.logMessage(`"æˆ‘æ˜¯å¥³å·«ï¼Œç›®å‰è¿˜æ²¡æœ‰ä½¿ç”¨è¿‡æ•‘è¯å’Œæ¯’è¯ã€‚"`, 'normal', this.currentPlayer);
                                        hasMadeAdditionalSpeech = true;
                                        showAdditionalOptions();
                                    }
                                }, 30);
                                break;

                            case 'hunter-claim':
                                // çŒäººå¸¦é˜Ÿ
                                this.logMessage(`"æˆ‘æ˜¯çŒäººï¼Œå¦‚æœæˆ‘è¢«ç‹¼äººåˆ€äº†ï¼Œæˆ‘ä¼šå¸¦èµ°ä¸€ä¸ªæˆ‘æ€€ç–‘çš„äººï¼"`, 'normal', this.currentPlayer);
                                hasMadeAdditionalSpeech = true;
                                showAdditionalOptions();
                                break;

                            case 'idiot-claim':
                                // ç™½ç—´å¼ºè°ƒå…æ­»
                                this.logMessage(`"æˆ‘æ˜¯ç™½ç—´ï¼Œå³ä½¿è¢«å…¬æŠ•å‡ºå±€ä¹Ÿä¸ä¼šæ­»äº¡ï¼Œå¯ä»¥ç»§ç»­ç•™åœ¨åœºä¸Šå‘è¨€ã€‚"`, 'normal', this.currentPlayer);
                                hasMadeAdditionalSpeech = true;
                                showAdditionalOptions();
                                break;

                            case 'wolf-teammate':
                                // ç‹¼äººä¿é˜Ÿå‹
                                const wolfTeammates = this.players.filter(p => p.role === 'werewolf' && p.id !== this.currentPlayer.id);
                                if (wolfTeammates.length > 0) {
                                    // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—ç›®æ ‡
                                    const sortedWolfTeammates = [...wolfTeammates].sort((a, b) => {
                                        return this.speechOrder.indexOf(a.id) - this.speechOrder.indexOf(b.id);
                                    });
                                    this.showActionButtons('é€‰æ‹©è¦ä¿çš„é˜Ÿå‹', sortedWolfTeammates.map(p => ({id: p.id, text: `${p.name}${!p.alive ? 'ï¼ˆå·²ç¦»å¼€ï¼‰' : ''}`})), (targetId) => {
                                        const target = this.players.find(p => p.id === targetId);
                                        this.logMessage(`"æˆ‘ä¿¡ä»» ${target.name}ï¼Œä»–çš„å‘è¨€å¬èµ·æ¥åƒå¥½äººï¼Œé€»è¾‘æ¸…æ™°ã€‚"`, 'normal', this.currentPlayer);
                                        this.updateAITrustBySpeech(targetId, this.currentPlayer.id);
                                        hasMadeAdditionalSpeech = true;
                                        showAdditionalOptions();
                                    }, 30);
                                } else {
                                    hasMadeAdditionalSpeech = true;
                                    showAdditionalOptions();
                                }
                                break;

                            case 'wolf-suspect':
                                // ç‹¼äººè¸©å¥½äºº - å…è®¸é€‰æ‹©æ‰€æœ‰éç‹¼ç©å®¶ï¼ˆåŒ…æ‹¬å·²ç¦»å¼€ç©å®¶ï¼‰
                                const goodPlayers = this.players.filter(p => p.role !== 'werewolf');
                                // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—ç›®æ ‡
                                const sortedGoodPlayers = [...goodPlayers].sort((a, b) => {
                                    return this.speechOrder.indexOf(a.id) - this.speechOrder.indexOf(b.id);
                                });
                                this.showActionButtons('é€‰æ‹©è¦è¸©çš„å¥½äºº', sortedGoodPlayers.map(p => ({id: p.id, text: `${p.name}${!p.alive ? 'ï¼ˆå·²ç¦»å¼€ï¼‰' : ''}`})), (targetId) => {
                                    const target = this.players.find(p => p.id === targetId);
                                    this.logMessage(`"æˆ‘æ€€ç–‘ ${target.name} æ˜¯ç‹¼äººï¼Œä»–çš„å‘è¨€é€»è¾‘æœ‰é—®é¢˜ï¼Œè¡Œä¸ºä¹Ÿå¾ˆå¯ç–‘ã€‚"`, 'normal', this.currentPlayer);
                                    this.updateAISuspicion(targetId, this.currentPlayer.id);
                                    hasMadeAdditionalSpeech = true;
                                    showAdditionalOptions();
                                }, 30);
                                break;

                            case 'suspect':
                                // æ€€ç–‘æŸäºº - å…è®¸é€‰æ‹©æ‰€æœ‰ç©å®¶ï¼ˆåŒ…æ‹¬å·²ç¦»å¼€ç©å®¶ï¼‰
                                const suspectTargets = this.players;
                                // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—ç›®æ ‡
                                const sortedSuspectTargets = [...suspectTargets].sort((a, b) => {
                                    return this.speechOrder.indexOf(a.id) - this.speechOrder.indexOf(b.id);
                                });
                                this.showActionButtons('é€‰æ‹©ä½ æ€€ç–‘çš„äºº', sortedSuspectTargets.map(p => ({id: p.id, text: `${p.name}${!p.alive ? 'ï¼ˆå·²ç¦»å¼€ï¼‰' : ''}`})), (targetId) => {
                                    const target = this.players.find(p => p.id === targetId);
                                    this.logMessage(`"æˆ‘æ€€ç–‘ ${target.name} æ˜¯ç‹¼äººï¼Œä»–çš„å‘è¨€é€»è¾‘æœ‰é—®é¢˜ï¼Œè¡Œä¸ºä¹Ÿå¾ˆå¯ç–‘ã€‚"`, 'normal', this.currentPlayer);
                                    this.updateAISuspicion(targetId, this.currentPlayer.id);
                                    hasMadeAdditionalSpeech = true;
                                    showAdditionalOptions();
                                }, 30);
                                break;

                            case 'trust':
                                // ä¿¡ä»»æŸäºº - å…è®¸é€‰æ‹©æ‰€æœ‰ç©å®¶ï¼ˆåŒ…æ‹¬å·²ç¦»å¼€ç©å®¶ï¼‰
                                const trustTargets = this.players;
                                // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—ç›®æ ‡
                                const sortedTrustTargets = [...trustTargets].sort((a, b) => {
                                    return this.speechOrder.indexOf(a.id) - this.speechOrder.indexOf(b.id);
                                });
                                this.showActionButtons('é€‰æ‹©ä½ ä¿¡ä»»çš„äºº', sortedTrustTargets.map(p => ({id: p.id, text: `${p.name}${!p.alive ? 'ï¼ˆå·²ç¦»å¼€ï¼‰' : ''}`})), (targetId) => {
                                    const target = this.players.find(p => p.id === targetId);
                                    this.logMessage(`"æˆ‘ä¿¡ä»» ${target.name}ï¼Œä»–çš„å‘è¨€å¬èµ·æ¥åƒå¥½äººï¼Œé€»è¾‘æ¸…æ™°ã€‚"`, 'normal', this.currentPlayer);
                                    this.updateAITrustBySpeech(targetId, this.currentPlayer.id);
                                    hasMadeAdditionalSpeech = true;
                                    showAdditionalOptions();
                                }, 30);
                                break;

                            case 'no-info':
                            case 'end-speech':
                                // ç»“æŸå‘è¨€æˆ–å…¶ä»–å‘è¨€
                                const randomSpeeches = [
                                    '"ç›®å‰ä¿¡æ¯ä¸è¶³ï¼Œæˆ‘éœ€è¦å†å¬å¬å…¶ä»–äººçš„å‘è¨€ã€‚"',
                                    '"å¸Œæœ›é¢„è¨€å®¶èƒ½å¸¦é˜Ÿï¼Œç»™å‡ºæ›´å¤šçš„æŸ¥éªŒä¿¡æ¯ã€‚"',
                                    '"ç‹¼äººè¯·è‡ªè§‰å‡ºæ¥ï¼Œä¸è¦è—äº†ã€‚"',
                                    '"è¿‡ï¼Œæˆ‘æ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚"'
                                ];
                                const randomSpeech = randomSpeeches[Math.floor(Math.random() * randomSpeeches.length)];
                                this.logMessage(randomSpeech, 'normal', this.currentPlayer);
                                resolve();
                                break;
                        }
                    };

                    // æ˜¾ç¤ºé¢å¤–çš„å‘è¨€é€‰é¡¹
                    let hasMadeAdditionalSpeech = false; // æ ‡è®°æ˜¯å¦å·²ç»è¡¥å……è¿‡å‘è¨€
                    const showAdditionalOptions = () => {
                        console.log('æ˜¾ç¤ºé¢å¤–å‘è¨€é€‰é¡¹ï¼Œæ˜¯å¦å·²è¡¥å……:', hasMadeAdditionalSpeech);
                        
                        // å¦‚æœå·²ç»è¡¥å……è¿‡ä¸€æ¬¡å‘è¨€ï¼Œåªæ˜¾ç¤ºç»“æŸå‘è¨€é€‰é¡¹
                        if (hasMadeAdditionalSpeech) {
                            const finalOptions = [
                                {id: 'final-end', text: 'ç»“æŸå‘è¨€'}
                            ];
                            
                            this.showActionButtons('ä½ å·²ç»è¡¥å……è¿‡å‘è¨€äº†', finalOptions, (optionId) => {
                                if (optionId === 'final-end') {
                                    resolve();
                                }
                            }, 30);
                            return;
                        }
                        
                        const additionalOptions = [
                            {id: 'add-suspect', text: 'å†æ€€ç–‘ä¸€ä¸ªäºº'},
                            {id: 'add-trust', text: 'å†ä¿¡ä»»ä¸€ä¸ªäºº'},
                            {id: 'add-random', text: 'è¡¥å……å‘è¨€'},
                            {id: 'final-end', text: 'ç»“æŸå‘è¨€'}
                        ];

                        this.showActionButtons('æ˜¯å¦éœ€è¦è¡¥å……å‘è¨€ï¼Ÿ', additionalOptions, (optionId) => {
                            switch (optionId) {
                                case 'add-suspect':
                                    // å…è®¸é€‰æ‹©æ‰€æœ‰ç©å®¶ï¼ˆåŒ…æ‹¬å·²ç¦»å¼€ç©å®¶ï¼‰
                                    const addSuspectTargets = this.players;
                                    this.showActionButtons('é€‰æ‹©ä½ æ€€ç–‘çš„äºº', addSuspectTargets.map(p => ({id: p.id, text: `${p.name}${!p.alive ? 'ï¼ˆå·²ç¦»å¼€ï¼‰' : ''}`})), (targetId) => {
                                        const target = this.players.find(p => p.id === targetId);
                                        this.logMessage(`"æˆ‘è¿˜æ€€ç–‘ ${target.name} æ˜¯ç‹¼äººï¼Œä»–çš„å‘è¨€ä¹Ÿå¾ˆå¯ç–‘ã€‚"`, 'normal', this.currentPlayer);
                                        this.updateAISuspicion(targetId, this.currentPlayer.id);
                                        additionalSpeechCount++;
                                        hasMadeAdditionalSpeech = true;
                                        showAdditionalOptions();
                                    }, 30);
                                    break;

                                case 'add-trust':
                                    // å…è®¸é€‰æ‹©æ‰€æœ‰ç©å®¶ï¼ˆåŒ…æ‹¬å·²ç¦»å¼€ç©å®¶ï¼‰
                                    const addTrustTargets = this.players;
                                    this.showActionButtons('é€‰æ‹©ä½ ä¿¡ä»»çš„äºº', addTrustTargets.map(p => ({id: p.id, text: `${p.name}${!p.alive ? 'ï¼ˆå·²ç¦»å¼€ï¼‰' : ''}`})), (targetId) => {
                                        const target = this.players.find(p => p.id === targetId);
                                        this.logMessage(`"æˆ‘è¿˜ä¿¡ä»» ${target.name}ï¼Œä»–åº”è¯¥æ˜¯å¥½äººã€‚"`, 'normal', this.currentPlayer);
                                        hasMadeAdditionalSpeech = true;
                                        showAdditionalOptions();
                                    }, 30);
                                    break;

                                case 'add-random':
                                    const additionalSpeeches = [
                                        '"è¿™è½®æˆ‘å»ºè®®å‡ºç‹¼äººï¼Œå¸Œæœ›å¥½äººéƒ½èƒ½è·Ÿç¥¨ã€‚"',
                                        '"é¢„è¨€å®¶è¯·å¸¦é˜Ÿï¼Œæˆ‘è·Ÿä½ èµ°ã€‚"',
                                        '"å¥³å·«è¯·ä¿æŠ¤å¥½é¢„è¨€å®¶ã€‚"',
                                        '"çŒäººè¯·è—å¥½èº«ä»½ï¼Œä¸è¦è¢«ç‹¼äººå‘ç°ã€‚"'
                                    ];
                                    const additionalSpeech = additionalSpeeches[Math.floor(Math.random() * additionalSpeeches.length)];
                                    this.logMessage(additionalSpeech, 'normal', this.currentPlayer);
                                    hasMadeAdditionalSpeech = true;
                                    showAdditionalOptions();
                                    break;

                                case 'final-end':
                                    resolve();
                                    break;
                            }
                        }, 30);
                    };

                    // å¼€å§‹å‘è¨€æµç¨‹
                    console.log('æ˜¾ç¤ºèº«ä»½é€‰æ‹©');
                    showRoleSelection();
                });
            }

            async aiSpeech(speaker) {
                return new Promise((resolve) => {
                    this.startTimer(3);
                    setTimeout(() => {
                        try {
                            let speech = '';
                            let suspicionTargets = Object.entries(speaker.ai.suspicionLevels || {})
                                .filter(([id, level]) => {
                                    const player = this.players.find(p => p.id === id);
                                    return player && player.alive && id !== speaker.id && level > 0;
                                })
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 2)
                                .map(([id]) => this.players.find(p => p.id === id));
                        
                            const trustTargets = Object.entries(speaker.ai.trustLevels || {})
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 2)
                                .map(([id]) => this.players.find(p => p.id === id));

                            // ç‹¼äººé’ˆå¯¹å€¼æœ€é«˜çš„å­˜æ´»ç›®æ ‡
                            const werewolfTargetingTargets = Object.entries(speaker.ai.targetingLevels || {})
                                .filter(([id, level]) => {
                                    const player = this.players.find(p => p.id === id);
                                    return player && player.alive && id !== speaker.id && player.role !== 'werewolf';
                                })
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 2)
                                .map(([id]) => this.players.find(p => p.id === id));

                            let claimedRole = speaker.role;

                            // æ ¹æ®å¤©æ•°è°ƒæ•´å‘è¨€å†…å®¹
                            const isFirstDay = this.currentDay === 1;

                            // ç‹¼äººæœ‰å‡ ç‡ä¼ªè£…èº«ä»½å¹¶æä¾›è¯¦ç»†å‡ä¿¡æ¯
                            if (speaker.role === 'werewolf') {
                                if (Math.random() < 0.7) {
                                    // å¦‚æœAIç‹¼äººå·²ç»æœ‰ä¼ªè£…èº«ä»½ï¼Œå°±ä½¿ç”¨è¿™ä¸ªèº«ä»½ï¼›å¦åˆ™éšæœºé€‰æ‹©ä¸€ä¸ªæ–°èº«ä»½
                                    if (speaker.claimedRole) {
                                        claimedRole = speaker.claimedRole;
                                    } else {
                                        // åœ¨9äººã€12äººå±€ä¸­ä¸ºAIç‹¼äººæ–°å¢â€œçŒäººâ€ä¼ªè£…èº«ä»½
                                        const fakeRoles = this.playerCount === 12 ? ['seer', 'witch', 'hunter', 'idiot', 'villager'] : 
                                                        this.playerCount === 9 ? ['seer', 'witch', 'hunter', 'villager'] : 
                                                        ['seer', 'witch', 'villager'];
                                        
                                        // è·å–å…¶ä»–ç‹¼äººå·²ç»é€‰æ‹©çš„ä¼ªè£…èº«ä»½
                                        const otherWolves = this.players.filter(p => p.role === 'werewolf' && p.id !== speaker.id && p.claimedRole);
                                        const takenRoles = otherWolves.map(wolf => wolf.claimedRole);
                                        
                                        // ä»å¯ç”¨èº«ä»½ä¸­æ’é™¤å·²è¢«é€‰æ‹©çš„èº«ä»½
                                        const availableRoles = fakeRoles.filter(role => !takenRoles.includes(role) || role === 'villager');
                                        
                                        // å¦‚æœæ²¡æœ‰å¯ç”¨çš„éæ‘æ°‘èº«ä»½ï¼Œå°±é€‰æ‹©æ‘æ°‘
                                        claimedRole = availableRoles[Math.floor(Math.random() * availableRoles.length)] || 'villager';
                                    }
                                }
                                
                                speech += `"æˆ‘æ˜¯${this.getRoleName(claimedRole)}ã€‚"`;
                        
                                // æ›´æ–°AIå£°ç§°çš„èº«ä»½
                                speaker.claimedRole = claimedRole;
                                // å¤„ç†èŒä¸šå¯¹è·³çš„æ€€ç–‘åº¦å˜åŒ–
                                this.handleRoleCounterclaim(speaker.id, claimedRole);

                                // æä¾›è¯¦ç»†çš„å‡ä¿¡æ¯
                                if (claimedRole === 'seer') {
                                    // ä¼ªè£…é¢„è¨€å®¶æ—¶ï¼Œæ¯è½®ç»™å‡ºå‘è¨€æ—¶çš„æŸ¥éªŒä¿¡æ¯ä¸ä»¥å¾€ä¸åŒ
                                    // ä¼˜å…ˆæŒ‡è®¤é’ˆå¯¹æ€§å€¼æœ€é«˜çš„ç›®æ ‡ä¸ºâ€œç‹¼äººâ€
                                    let target;
                                    
                                    // è·å–é’ˆå¯¹æ€§å€¼æœ€é«˜çš„å‰å‡ ä¸ªç›®æ ‡
                                    const targetingTargets = Object.entries(speaker.ai.targetingLevels || {})
                                        .filter(([id]) => {
                                            const player = this.players.find(p => p.id === id);
                                            return player && player.alive && id !== speaker.id && player.role !== 'werewolf';
                                        })
                                        .sort(([,a], [,b]) => b - a)
                                        .slice(0, 3)
                                        .map(([id]) => this.players.find(p => p.id === id));
                                    
                                    // ç¡®ä¿æœ‰ç›®æ ‡å¯ä»¥é€‰æ‹©ï¼Œé¿å…targetä¸ºundefined
                                    if (targetingTargets.length > 0) {
                                        target = targetingTargets[0];
                                    } else if (suspicionTargets.length > 0) {
                                        target = suspicionTargets[0];
                                    } else if (trustTargets.length > 0) {
                                        target = trustTargets[0];
                                    } else {
                                        // å¦‚æœéƒ½æ²¡æœ‰ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªéç‹¼äººç©å®¶
                                        const nonWolfPlayers = this.players.filter(p => p.alive && p.id !== speaker.id && p.role !== 'werewolf');
                                        target = nonWolfPlayers.length > 0 ? nonWolfPlayers[Math.floor(Math.random() * nonWolfPlayers.length)] : null;
                                    }
                                    
                                    // å¦‚æœä»ç„¶æ²¡æœ‰æ‰¾åˆ°ç›®æ ‡ï¼Œè·³è¿‡ä¼ªè£…é¢„è¨€å®¶çš„è¯¦ç»†å‘è¨€
                                    if (!target) {
                                        speech += ` æ˜¨æ™šæˆ‘æ²¡æœ‰æŸ¥éªŒåˆ°ç‹¼äººä¿¡æ¯ã€‚`;
                                    } else {
                                    
                                    // ä¼˜å…ˆæŒ‡è®¤é’ˆå¯¹æ€§å€¼æœ€é«˜çš„ç›®æ ‡ä¸ºâ€œç‹¼äººâ€
                                    const isWolf = Math.random() < 0.8 ? 'ç‹¼äºº' : 'å¥½äºº'; // 80%å‡ ç‡æŒ‡è®¤ç›®æ ‡ä¸ºç‹¼äºº
                                    speech += ` æ˜¨æ™šæˆ‘æŸ¥éªŒäº†${target.name}ï¼Œä»–æ˜¯${isWolf}ã€‚`;
                                    // æ·»åŠ éªŒäººé€»è¾‘ï¼Œé¿å…æåˆ°ä¸Šä¸€è½®å‘è¨€
                                    if (Math.random() < 0.7) {
                                        if (isFirstDay) {
                                            speech += ` æˆ‘é€‰æ‹©éªŒä»–æ˜¯å› ä¸ºä»–çš„è¡¨ç°çœ‹èµ·æ¥ä¸å¤ªè‡ªç„¶ï¼Œ`;
                                        } else {
                                            speech += ` æˆ‘é€‰æ‹©éªŒä»–æ˜¯å› ä¸ºä»–ä¹‹å‰çš„è¡¨ç°æœ‰äº›å¯ç–‘ï¼Œ`;
                                        }
                                        speech += isWolf ? 'ç°åœ¨ç¡®å®šä»–å°±æ˜¯ç‹¼ï¼' : 'ç°åœ¨ç¡®å®šä»–æ˜¯å¥½äººã€‚';
                                    }
                                    // å¤„ç†é¢„è¨€å®¶æŸ¥éªŒä¿¡æ¯å¯¹å…¶ä»–AIçš„å½±å“
                                    this.handleSeerCheckInfo(speaker.id, target.id, isWolf);
                                    if (isWolf === 'ç‹¼äºº') {
                                        this.updateAISuspicion(target.id, speaker.id);
                                        // é‡æ–°ç”ŸæˆsuspicionTargetsæ•°ç»„ï¼Œä½¿ç”¨æœ€æ–°çš„æ€€ç–‘åº¦æ•°æ®
                                        suspicionTargets = Object.entries(speaker.ai.suspicionLevels || {})
                                            .filter(([id, level]) => {
                                                const player = this.players.find(p => p.id === id);
                                                return player && player.alive && id !== speaker.id && level > 0;
                                            })
                                            .sort((a, b) => b[1] - a[1])
                                            .slice(0, 2)
                                            .map(([id]) => this.players.find(p => p.id === id));
                                    }
                                    }
                                } else if (claimedRole === 'witch') {
                                    // æ£€æŸ¥å¥³å·«æ˜¯å¦çœŸçš„ä½¿ç”¨äº†è§£è¯
                                    const witchUsedPotion = this.usedItems.potion;
                                    
                                    // é€‰æ‹©ä¸€ä¸ªç›®æ ‡ç”¨äºå‘è¨€ï¼Œé¿å…åŒæ—¶ä¿¡ä»»å’Œæ€€ç–‘åŒä¸€ä¸ªäºº
                                    const chosenTarget = trustTargets[0] || suspicionTargets[0] || this.players.find(p => p.id !== speaker.id);
                                    
                                    // åªæœ‰åœ¨å¥³å·«ç¡®å®ä½¿ç”¨äº†è§£è¯çš„æƒ…å†µä¸‹ï¼Œç‹¼äººæ‰ä¼šä¼ªè£…ä½¿ç”¨è§£è¯
                                    if (witchUsedPotion && Math.random() < 0.8) {
                                        speech += ` æˆ‘æ•‘è¿‡${chosenTarget.name}ï¼Œä»–æ˜¯å¥½äººã€‚`;
                                        if (Math.random() < 0.6) {
                                            speech += ` æ˜¨æ™šç‹¼äººé€‰æ‹©äº†ä»–ï¼Œæˆ‘ç”¨æ•‘è¯æ•‘äº†å›æ¥ï¼Œ`;
                                            speech += `ç°åœ¨åœºä¸Šè¿˜æœ‰æ•‘è¯/æ¯’è¯ï¼Œæˆ‘ä¼šç»§ç»­ä¿æŠ¤å¥½äººã€‚`;
                                        }
                                    } else if (Math.random() < 0.3) {
                                        speech += ` æˆ‘å¤„ç†äº†${chosenTarget.name}ï¼Œä»–æ˜¯ç‹¼äººã€‚`;
                                        if (Math.random() < 0.6) {
                                            speech += ` æˆ‘è§‚å¯Ÿä»–çš„è¡¨ç°ï¼Œç¡®å®šä»–æ˜¯ç‹¼äººï¼Œ`;
                                            speech += `æ‰€ä»¥æ˜¨æ™šä½¿ç”¨äº†æ¯’è¯ï¼Œç°åœ¨å¥³å·«å·²ç»æ²¡æœ‰æ¯’è¯äº†ã€‚`;
                                        }
                                    } else if (Math.random() < 0.4) {
                                        speech += ` æˆ‘å·²ç»ä½¿ç”¨è¿‡æ•‘è¯äº†ï¼Œ`;
                                        speech += `ç°åœ¨åªæœ‰æ¯’è¯äº†ï¼Œæˆ‘ä¼šè°¨æ…ä½¿ç”¨ã€‚`;
                                    }
                                } else if (claimedRole === 'hunter') {
                                    speech += ` å¦‚æœæˆ‘è¢«ç‹¼äººé€‰æ‹©æˆ–è€…è¢«å¥½äººå…¬æŠ•å‡ºå±€ï¼Œ`;
                                    speech += `æˆ‘ä¼šå¸¦èµ°ä¸€ä¸ªæˆ‘æ€€ç–‘çš„äººï¼Œæ‰€ä»¥ç‹¼äººæœ€å¥½ä¸è¦é€‰æ‹©æˆ‘ã€‚`;
                                }
                                
                                // ç‹¼äººè¡¨è¿°å®Œèº«ä»½åï¼Œå¿…é¡»è¡¨è¿°è‡ªå·±æœ€æ€€ç–‘çš„ç›®æ ‡ï¼ˆå–è¯¥ç‹¼äººé’ˆå¯¹å€¼æœ€é«˜çš„å­˜æ´»ç›®æ ‡ï¼‰
                                if (werewolfTargetingTargets.length > 0) {
                                    const mostSuspected = werewolfTargetingTargets[0];
                                    speech += ` æˆ‘æ€€ç–‘${mostSuspected.name}ï¼Œ`;
                                    if (isFirstDay) {
                                        speech += `ä»–çœ‹èµ·æ¥å¾ˆç´§å¼ ï¼Œ`;
                                    } else {
                                        speech += `ä»–çš„è¡¨ç°ä¸å¤ªè‡ªç„¶ï¼Œ`;
                                    }
                                    speech += `å»ºè®®è¿™è½®å‡ºä»–ã€‚`;
                                    this.updateAISuspicion(mostSuspected.id, speaker.id);
                                }
                                
                                // ç‹¼äººä¸è·³èº«ä»½çš„æƒ…å†µï¼ˆä½œä¸ºelseæƒ…å†µï¼‰
                                if (!speaker.claimedRole || speaker.claimedRole === 'werewolf') {
                                    // è®¾ç½®claimedRoleä¸ºå¹³æ°‘
                                    claimedRole = 'villager';
                                    speaker.claimedRole = claimedRole;
                                    this.handleRoleCounterclaim(speaker.id, claimedRole);
                                    
                                    if (werewolfTargetingTargets.length > 0) {
                                        const target = werewolfTargetingTargets[0];
                                        speech = `"æˆ‘æ€€ç–‘${target.name}æ˜¯ç‹¼äººï¼Œ`;
                                        if (isFirstDay) {
                                            speech += `ä»–çœ‹èµ·æ¥å¾ˆç´§å¼ ï¼Œ`;
                                        } else {
                                            speech += `ä»–çš„è¡¨ç°é€»è¾‘æ··ä¹±ï¼Œ`;
                                        }
                                        speech += `æ„Ÿè§‰åƒæ˜¯åœ¨éšè—èº«ä»½ï¼Œå»ºè®®è¿™è½®å‡ºä»–ã€‚"`;
                                        this.updateAISuspicion(target.id, speaker.id);
                                    } else {
                                        // å½“æ²¡æœ‰æ˜ç¡®æ€€ç–‘ç›®æ ‡æ—¶ï¼Œåªé™ˆè¿°è‡ªå·±èº«ä»½
                                        speech = `"æˆ‘æ˜¯å¹³æ°‘ï¼Œæ˜¨æ™šæ²¡æœ‰ä»»ä½•ä¿¡æ¯ï¼Œå»ºè®®å¤§å®¶å…ˆè§‚å¯Ÿï¼Œ`;
                                        speech += `ä¸è¦è½»æ˜“æ€€ç–‘ä»–äººï¼Œé¿å…è¯¯å‡ºå¥½äººã€‚"`;
                                    }
                                }
                        } else {
                            // å¥½äººå‘è¨€
                            speech += `"æˆ‘æ˜¯${this.getRoleName(claimedRole)}ã€‚"`;

                            // é¢„è¨€å®¶çœŸå®ä¿¡æ¯
                            if (speaker.role === 'seer') {
                                const seerResult = this.seerResults[speaker.id];
                                if (seerResult) {
                                    // çœŸé¢„è¨€å®¶å¦‚æœæŸ¥æ€åˆ°ç‹¼äººæ°¸è¿œä¼šæ±‡æŠ¥æŸ¥éªŒä¿¡æ¯ï¼Œå¦‚æœæŸ¥éªŒåˆ°å¥½äººï¼Œåˆ™ä¼šæœ‰80%çš„å‡ ç‡æ±‡æŠ¥
                                    const shouldReport = seerResult.result === 'ç‹¼äºº' || Math.random() < 0.8;
                                    if (shouldReport) {
                                        const target = this.players.find(p => p.id === seerResult.targetId);
                                        speech += ` æ˜¨æ™šæˆ‘æŸ¥éªŒäº†${target.name}ï¼Œä»–æ˜¯${seerResult.result}ã€‚`;
                                        if (Math.random() < 0.7) {
                                            if (isFirstDay) {
                                                speech += ` æˆ‘é€‰æ‹©éªŒä»–æ˜¯å› ä¸ºéšæœºé€‰æ‹©ï¼Œ`;
                                            } else {
                                                speech += ` æˆ‘é€‰æ‹©éªŒä»–æ˜¯å› ä¸ºä»–çš„è¡¨ç°ï¼Œ`;
                                            }
                                            speech += seerResult.result === 'ç‹¼äºº' ? 'ç°åœ¨ç¡®å®šä»–å°±æ˜¯ç‹¼ï¼' : 'ç°åœ¨ç¡®å®šä»–æ˜¯å¥½äººã€‚';
                                        }
                                        // é¢„è¨€å®¶æŸ¥éªŒåçš„æ€€ç–‘åº¦æ›´æ–°
                                        this.updateSeerSuspicion(speaker.id, seerResult.targetId, seerResult.result);
                                        // å¤„ç†é¢„è¨€å®¶æŸ¥éªŒä¿¡æ¯å¯¹å…¶ä»–AIçš„å½±å“
                                        this.handleSeerCheckInfo(speaker.id, seerResult.targetId, seerResult.result);
                                        if (seerResult.result === 'ç‹¼äºº') {
                                            this.updateAISuspicion(seerResult.targetId, speaker.id);
                                            // é‡æ–°ç”ŸæˆsuspicionTargetsæ•°ç»„ï¼Œä½¿ç”¨æœ€æ–°çš„æ€€ç–‘åº¦æ•°æ®
                                            suspicionTargets = Object.entries(speaker.ai.suspicionLevels || {})
                                                .filter(([id, level]) => {
                                                    const player = this.players.find(p => p.id === id);
                                                    return player && player.alive && id !== speaker.id && level > 0;
                                                })
                                                .sort((a, b) => b[1] - a[1])
                                                .slice(0, 2)
                                                .map(([id]) => this.players.find(p => p.id === id));
                                        }
                                    }
                                }
                            }
                            // å¥³å·«å‘è¨€
                            else if ((speaker.role === 'witch' || (speaker.role !== 'witch' && speaker.ai.claimedRole === 'witch'))) {
                                const hasPoisonedPlayer = this.players.some(p => p.causeOfDeath === 'poison' || this.witchPoisonTarget);
                                const isRealWitch = speaker.role === 'witch';
                                const isPeacefulNight = !this.deathsThisNight || this.deathsThisNight.length === 0;
                                const hasUsedPoison = this.usedItems.poison;
                                const hasUsedPotion = this.usedItems.potion;
                                const hasReportedPoison = this.usedItems.reportedPoison;
                                const hasReportedHeal = this.usedItems.reportedHeal;
                                
                                // ä¼˜å…ˆå¤„ç†ï¼šå¦‚æœæ¯’è¯å·²ä½¿ç”¨ä¸”å°šæœªæ±‡æŠ¥ï¼Œ100%åœ¨ä¸‹ä¸€ä¸ªå‘è¨€ç¯èŠ‚æ±‡æŠ¥
                                if (hasUsedPoison && !hasReportedPoison) {
                                    const poisonedPlayer = this.players.find(p => p.causeOfDeath === 'poison');
                                    if (poisonedPlayer) {
                                        speech += ` æˆ‘æ˜¯å¥³å·«ï¼Œ`;
                                        speech += `æˆ‘æ˜¨æ™šæ¯’æ€äº†${poisonedPlayer.name}ï¼Œä»–æ˜¯ç‹¼äººã€‚`;
                                        this.usedItems.reportedPoison = true; // æ ‡è®°ä¸ºå·²æ±‡æŠ¥
                                    }
                                }
                                // å¦‚æœè§£è¯å·²ä½¿ç”¨ä¸”å°šæœªæ±‡æŠ¥ï¼Œ100%åœ¨ä¸‹ä¸€ä¸ªå‘è¨€ç¯èŠ‚æ±‡æŠ¥
                                else if (isRealWitch && hasUsedPotion && !hasReportedHeal) {
                                    const healedPlayer = this.players.find(p => p.id === this.witchHealTarget);
                                    if (healedPlayer) {
                                        speech += ` æˆ‘æ˜¯å¥³å·«ï¼Œ`;
                                        speech += `æˆ‘æ•‘è¿‡${healedPlayer.name}ï¼Œä»–æ˜¯å¥½äººã€‚`;
                                        this.usedItems.reportedHeal = true; // æ ‡è®°ä¸ºå·²æ±‡æŠ¥
                                        // å¤„ç†å¥³å·«æ•‘äººä¿¡æ¯å¯¹æ€€ç–‘åº¦çš„å½±å“
                                        this.handleWitchHealInfo(speaker.id, this.witchHealTarget);
                                    }
                                }
                                // å¤„ç†è¯ç‰©å­˜é‡çš„æåŠï¼ˆä»…åœ¨æœªæ±‡æŠ¥æ¯’è¯æ—¶æˆ–ä¹‹åçš„å‘è¨€ä¸­ï¼‰
                                else if (Math.random() < 0.8) {
                                    if (hasUsedPoison && hasUsedPotion) {
                                        speech += ` æˆ‘æ˜¯å¥³å·«ï¼Œ`;
                                        speech += `æˆ‘çš„è§£è¯å’Œæ¯’è¯å·²ç»å…¨éƒ¨ç”¨å®Œäº†ã€‚`;
                                    } else if (hasUsedPoison && !hasUsedPotion) {
                                        speech += ` æˆ‘æ˜¯å¥³å·«ï¼Œ`;
                                        speech += `æˆ‘çš„æ¯’è¯å·²ç»ç”¨å®Œäº†ï¼Œä½†æˆ‘è¿˜æœ‰ä¸€ç“¶è§£è¯ã€‚`;
                                    } else if (!hasUsedPoison && hasUsedPotion) {
                                        speech += ` æˆ‘æ˜¯å¥³å·«ï¼Œ`;
                                        speech += `æˆ‘çš„è§£è¯å·²ç»ç”¨å®Œäº†ï¼Œä½†æˆ‘è¿˜æœ‰ä¸€ç“¶æ¯’è¯ã€‚`;
                                    } else if (isRealWitch) {
                                        speech += ` æˆ‘æ˜¯å¥³å·«ï¼Œ`;
                                        speech += `æˆ‘è¿˜æœ‰æ•‘è¯å’Œæ¯’è¯ï¼Œ`;
                                        speech += `ç‹¼äººæœ€å¥½ä¸è¦é€‰æ‹©æˆ‘ï¼Œå¦åˆ™æˆ‘ä¼šå¸¦èµ°ä¸€ä¸ªã€‚`;
                                    }
                                }
                            }
                            // çŒäººå‘è¨€
                            else if (speaker.role === 'hunter' && Math.random() < 0.5) {
                                speech += ` å¦‚æœæˆ‘è¢«ç‹¼äººé€‰æ‹©ï¼Œæˆ‘ä¼šå¸¦èµ°ä¸€ä¸ªæˆ‘æ€€ç–‘çš„äººã€‚`;
                                if (suspicionTargets.length > 0) {
                                    speech += ` æˆ‘ç°åœ¨æ€€ç–‘${suspicionTargets[0].name}ã€‚`;
                                }
                            }
                            // ç™½ç—´å‘è¨€
                            else if (speaker.role === 'idiot' && Math.random() < 0.4) {
                                speech += ` æˆ‘æ˜¯ç™½ç—´ï¼Œå³ä½¿è¢«å…¬æŠ•å‡ºå±€ä¹Ÿä¸ä¼šæ­»äº¡ï¼Œ`;
                                speech += `å¯ä»¥ç»§ç»­ç•™åœ¨åœºä¸Šå‘è¨€ï¼Œæ‰€ä»¥å¤§å®¶å¯ä»¥æ”¾å¿ƒæŠ•æˆ‘æ¥éªŒè¯èº«ä»½ã€‚`;
                            }

                            // æ·»åŠ æ€€ç–‘æˆ–ä¿¡ä»»çš„è¯¦ç»†ä¿¡æ¯
                            // å¦‚æœæ˜¯å¥³å·«ä¸”åœ¨å‘è¨€ä¸­æåˆ°æ•‘è¿‡æŸäººï¼Œå°±ä¸è¦æ€€ç–‘åŒä¸€ä¸ªäºº
                            const hasSavedSomeone = speech.includes('æ•‘è¿‡');
                            let savedTarget = null;
                            if (hasSavedSomeone) {
                                // æå–è¢«æ•‘çš„ç›®æ ‡åå­—
                                const match = speech.match(/æ•‘è¿‡(\S+)ï¼Œ/);
                                if (match) {
                                    savedTarget = match[1];
                                }
                            }
                            
                            // è¿‡æ»¤æ‰è¢«æ•‘çš„ç›®æ ‡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                            const filteredSuspicionTargets = hasSavedSomeone && savedTarget 
                                ? suspicionTargets.filter(target => target.name !== savedTarget)
                                : suspicionTargets;
                            
                            if (filteredSuspicionTargets.length > 0 && Math.random() < 0.8) {
                                const topSuspicion = filteredSuspicionTargets[0];
                                const suspicionLevel = speaker.ai.suspicionLevels[topSuspicion.id];
                                
                                // å½“æ€€ç–‘åº¦ä¸º0æ—¶ä¸è¡¨è¾¾æ€€ç–‘
                                if (suspicionLevel === 0) {
                                    // æ€€ç–‘åº¦ä¸º0æ—¶ï¼Œä¸ä¸»åŠ¨æ€€ç–‘ä»–äºº
                                } else {
                                    speech += ` æˆ‘æ€€ç–‘${topSuspicion.name}ï¼Œ`;
                                    if (isFirstDay) {
                                        speech += `ä»–çœ‹èµ·æ¥å¾ˆç´§å¼ ï¼Œ`;
                                        speech += `å¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡å½“ç‹¼äººï¼Œ`;
                                    } else {
                                        speech += `ä»–çš„è¡¨ç°ä¸å¤ªè‡ªç„¶ï¼Œ`;
                                        speech += `é€»è¾‘æœ‰äº›æ··ä¹±ï¼Œ`;
                                    }
                                    speech += `å»ºè®®è¿™è½®å‡ºä»–ã€‚`;
                                }
                            }
                            if (trustTargets.length > 0 && Math.random() < 0.6) {
                                speech += ` æˆ‘ä¿¡ä»»${trustTargets[0].name}ï¼Œ`;
                                speech += `ä»–çœ‹èµ·æ¥å¾ˆçœŸè¯šï¼Œ`;
                                speech += `åº”è¯¥æ˜¯å¥½äººé˜µè¥çš„ã€‚`;
                            }

                            // æ·»åŠ æ€»ç»“æ€§å‘è¨€
                            if (Math.random() < 0.5) {
                                if (filteredSuspicionTargets.length > 0) {
                                    speech += ` è¿™è½®æˆ‘å»ºè®®å‡º${filteredSuspicionTargets[0].name}ï¼Œ`;
                                    speech += `å¸Œæœ›å¥½äººéƒ½èƒ½è·Ÿç¥¨ï¼Œä¸è¦åˆ†ç¥¨ã€‚`;
                                } else {
                                    speech += ` è¿™è½®æˆ‘è¿˜æ²¡æœ‰æ˜ç¡®çš„æ€€ç–‘å¯¹è±¡ï¼Œ`;
                                    speech += `å»ºè®®å¤§å®¶å¤šå‘è¨€ï¼Œå†å†³å®šæŠ•ç¥¨å¯¹è±¡ã€‚`;
                                }
                            }
                        }

                        // AIæœ‰æ¦‚ç‡åœ¨å‘è¨€ç¯èŠ‚è¡¨è¿°è‡ªå·±æœ€ä¿¡ä»»çš„ç›®æ ‡
                        if (Math.random() < 0.4) { // 40%çš„æ¦‚ç‡è¡¨è¿°æœ€ä¿¡ä»»çš„ç›®æ ‡
                            let trustedTarget;
                            
                            if (speaker.role === 'werewolf') {
                                // ç‹¼äººä¼˜å…ˆé€‰æ‹©é˜Ÿå‹ï¼Œ40%çš„å‡ ç‡é€‰æ‹©å…¶ä»–äºº
                                const chooseTeammate = Math.random() > 0.4;
                                
                                if (chooseTeammate) {
                                    // é€‰æ‹©å­˜æ´»çš„é˜Ÿå‹
                                    const aliveTeammates = this.players.filter(p => p.role === 'werewolf' && p.id !== speaker.id && p.alive);
                                    if (aliveTeammates.length > 0) {
                                        // é€‰æ‹©æ€€ç–‘åº¦æœ€ä½çš„é˜Ÿå‹ï¼ˆæœ€ä¿¡ä»»ï¼‰
                                        trustedTarget = aliveTeammates.sort((a, b) => 
                                            ((speaker.ai.suspicionLevels || {})[a.id] || 0) - ((speaker.ai.suspicionLevels || {})[b.id] || 0)
                                        )[0];
                                    }
                                } else {
                                    // é€‰æ‹©å…¶ä»–äººä¸­æœ€ä¿¡ä»»çš„ç›®æ ‡
                                    if (trustTargets.length > 0) {
                                        trustedTarget = trustTargets[0];
                                    }
                                }
                            } else {
                                // å¥½äººé€‰æ‹©æœ€ä¿¡ä»»çš„ç›®æ ‡ï¼ˆæ— è®ºæ˜¯å¦å­˜æ´»ï¼‰
                                const allTrustTargets = Object.entries(speaker.ai.trustLevels || {})
                                    .sort((a, b) => b[1] - a[1])
                                    .slice(0, 1)
                                    .map(([id]) => this.players.find(p => p.id === id));
                                
                                if (allTrustTargets.length > 0) {
                                    trustedTarget = allTrustTargets[0];
                                }
                            }
                            
                            if (trustedTarget) {
                                speech += ` æˆ‘ä¿¡ä»»${trustedTarget.name}ï¼Œä»–åº”è¯¥æ˜¯å¥½äººã€‚`;
                                this.updateAITrustBySpeech(trustedTarget.id, speaker.id);
                            }
                        }
                        
                        this.logMessage(speech, 'normal', speaker);
                        resolve();
                    } catch (error) {
                        console.error('AIå‘è¨€å‡ºé”™:', error);
                        // å‡ºé”™æ—¶ç”Ÿæˆä¸€ä¸ªé»˜è®¤å‘è¨€ï¼Œé¿å…æ¸¸æˆå¡ä½
                        let fallbackSpeech = `"æˆ‘æ˜¯${this.getRoleName(claimedRole || 'å¹³æ°‘')}ï¼Œç°åœ¨æœ‰äº›æ··ä¹±ï¼Œå…ˆè·³è¿‡è¿™æ¬¡å‘è¨€ã€‚"`;
                        this.logMessage(fallbackSpeech, 'normal', speaker);
                        resolve();
                    }
                }, 1000 + Math.random() * 2000);
            });
        }

        async startVotingPhase(isRevote = false) {
            this.logMessage(`ã€${isRevote ? 'é‡æ–°' : ''}è¿›å…¥æŠ•ç¥¨ç¯èŠ‚ã€‘`, 'system');
            this.votes = {};
            this.hasUserVoted = false;
            this.isRevotePhase = isRevote;
                
                // æŒ‰ç…§å‘è¨€é¡ºåºè·å–å­˜æ´»ç©å®¶
                const votingOrder = this.speechOrder.filter(playerId => {
                    const player = this.players.find(p => p.id === playerId);
                    return player && player.alive;
                });
                
                // è·å–æ‰€æœ‰å­˜æ´»çš„æŠ•ç¥¨ç›®æ ‡ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼Œä½†ä¸èƒ½æŠ•ç¥¨ç»™è‡ªå·±ï¼‰
                const allAlivePlayers = this.players.filter(p => p.alive);
                
                // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—ç›®æ ‡
                const sortedTargets = [...allAlivePlayers].sort((a, b) => {
                    return this.speechOrder.indexOf(a.id) - this.speechOrder.indexOf(b.id);
                });
                
                // åœ¨æŠ•ç¥¨ç¯èŠ‚å¼€å§‹æ—¶æ˜¾ç¤ºæŠ•ç¥¨çª—å£ï¼Œæ— è®ºç”¨æˆ·æ˜¯å¦å­˜æ´»
                const userPlayer = this.players.find(p => p.isUser);
                if (userPlayer) {
                    // å…ˆæ˜¾ç¤ºæŠ•ç¥¨çª—å£ï¼Œä½†ä¸é˜»å¡æµç¨‹
                    // æŠ•ç¥¨çª—å£åˆå§‹çŠ¶æ€ä¸ºä¸å¯äº¤äº’ï¼Œåªæœ‰å½“è½®åˆ°ç”¨æˆ·æŠ•ç¥¨æ—¶æ‰å˜ä¸ºå¯äº¤äº’
                    this.showVotingModal(sortedTargets, () => {
                        // æŠ•ç¥¨å®Œæˆåçš„å›è°ƒ
                        // è¿™ä¸ªå›è°ƒä¼šåœ¨ç”¨æˆ·å®ŒæˆæŠ•ç¥¨æ—¶è¢«è°ƒç”¨
                    }, false);
                }
                
                for (const playerId of votingOrder) {
                    const player = this.players.find(p => p.id === playerId);
                    if (player) {
                        if (player.isUser) {
                            await this.userVote();
                        } else {
                            await this.aiVote(player);
                        }
                        await this.delay(500);
                    }
                }

                await this.resolveVoting();
            }

        async userVote() {
            return new Promise((resolve) => {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»æŠ•ç¥¨
                if (this.hasUserVoted) {
                    resolve();
                    return;
                }
                
                // è·å–æ‰€æœ‰å­˜æ´»ç©å®¶ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼Œä½†ä¸èƒ½æŠ•ç¥¨ç»™è‡ªå·±ï¼‰
                const targets = this.players.filter(p => p.alive);
                
                // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—ç›®æ ‡
                const sortedTargets = [...targets].sort((a, b) => {
                    return this.speechOrder.indexOf(a.id) - this.speechOrder.indexOf(b.id);
                });
                
                // è·å–å½“å‰ç”¨æˆ·
                const userPlayer = this.players.find(p => p.id === 'user');
                
                // å¦‚æœç”¨æˆ·å·²æ­»äº¡ï¼Œè®¾ç½®ä¸ºå·²æŠ•ç¥¨çŠ¶æ€å¹¶æ˜¾ç¤ºçª—å£
                if (!userPlayer.alive) {
                    this.hasUserVoted = true;
                    // æ˜¾ç¤ºæŠ•ç¥¨çª—å£ï¼Œä½†ä¸èƒ½è¿›è¡ŒæŠ•ç¥¨
                    this.showVotingModal(sortedTargets, resolve, false);
                    return;
                }
                
                // æ˜¾ç¤ºæŠ•ç¥¨çª—å£ï¼Œå¹¶æ·»åŠ æ–‡å­—æé†’
                this.showVotingModal(sortedTargets, resolve, true);
            });
        }

        async aiVote(ai) {
            return new Promise((resolve) => {
                this.startTimer(5);
                setTimeout(() => {
                    let voteTarget;
                    if (ai.role === 'werewolf') {
                            const targets = this.players.filter(p => p.alive && p.role !== 'werewolf');
                            const targetScores = targets.map(t => ({id: t.id, score: ai.ai.targetingLevels[t.id] || 0}));
                            targetScores.sort((a, b) => b.score - a.score);
                            
                            // å¹³ç¥¨é‡æ–°æŠ•ç¥¨æ—¶ï¼Œæœ‰30%å‡ ç‡é€‰æ‹©ç¬¬äºŒç›®æ ‡
                            if (this.isRevotePhase && Math.random() < 0.3 && targetScores.length > 1) {
                                voteTarget = targetScores[1].id;
                            } else {
                                voteTarget = targetScores[0].id;
                            }
                        } else {
                            // è¿‡æ»¤æ‰è‡ªå·±ï¼Œä¸èƒ½æŠ•ç¥¨ç»™è‡ªå·±
                            const targets = this.players.filter(p => p.alive && p.id !== ai.id);
                            const targetScores = targets.map(t => ({id: t.id, score: ai.ai.suspicionLevels[t.id] || 0}));
                            targetScores.sort((a, b) => b.score - a.score);
                            
                            // ç¬¬ä¸€è½®ä¸”æ€€ç–‘åº¦æœ€é«˜çš„ç›®æ ‡æœ‰ä¸¤ä¸ªä¸”æ€€ç–‘åº¦ç›¸åŒæ—¶é€‰æ‹©å¼ƒç¥¨
                            if (this.currentDay === 1 && targetScores.length >= 2 && targetScores[0].score === targetScores[1].score) {
                                voteTarget = 'abstain';
                            } else {
                                // å¹³ç¥¨é‡æ–°æŠ•ç¥¨æ—¶ï¼Œæœ‰30%å‡ ç‡é€‰æ‹©ç¬¬äºŒç›®æ ‡
                                if (this.isRevotePhase && Math.random() < 0.3 && targetScores.length > 1) {
                                    voteTarget = targetScores[1].id;
                                } else {
                                    voteTarget = targetScores[0].id;
                                }
                            }
                        }
                    this.votes[ai.id] = voteTarget;
                    if (voteTarget === 'abstain') {
                        this.logMessage(`${ai.name} é€‰æ‹©äº†å¼ƒç¥¨ã€‚`);
                    } else {
                        this.logMessage(`${ai.name} æŠ•ç¥¨ç»™äº† ${this.players.find(p => p.id === voteTarget).name}ã€‚`);
                    }
                        this.updateUI();
                        this.updateVotingModal(); // æ›´æ–°æŠ•ç¥¨çª—å£ä¸­çš„æŠ•ç¥¨è€…åˆ—è¡¨
                        resolve();
                    }, 1000 + Math.random() * 4000);
                });
            }

        showVotingModal(targets, resolve, isUserTurn = false) {
                // æ¸…ç©ºå®¹å™¨
                this.votingTargetsContainer.innerHTML = '';
                this.abstainContainer.innerHTML = '';
                this.votingConfirmation.classList.add('hidden');
                
                // æ·»åŠ æ–‡å­—æé†’
                if (isUserTurn) {
                    const reminderDiv = document.createElement('div');
                    reminderDiv.className = 'text-center text-lg font-bold mb-4 text-[var(--text-gold)]';
                    reminderDiv.textContent = 'è¯·é€‰æ‹©ä½ æƒ³è¦å¤„å†³çš„ç©å®¶ï¼š';
                    this.votingTargetsContainer.appendChild(reminderDiv);
                }
                
                // åˆ›å»ºæŠ•ç¥¨ç›®æ ‡åˆ—è¡¨
                targets.forEach(target => {
                    const targetElement = document.createElement('div');
                    // æ ¹æ®æ˜¯å¦æ˜¯ç”¨æˆ·å›åˆæ·»åŠ ä¸åŒçš„æ ·å¼
                    if (isUserTurn && target.id !== 'user') {
                        targetElement.className = 'flex items-center justify-between p-3 mb-2 bg-[var(--primary-dark)] rounded-lg hover:bg-[var(--primary)] transition-colors cursor-pointer';
                    } else {
                        targetElement.className = 'flex items-center justify-between p-3 mb-2 bg-[var(--primary-dark)] rounded-lg transition-colors cursor-not-allowed';
                    }
                    
                    // ç›®æ ‡å¤´åƒå’Œåå­—
                    const targetInfo = document.createElement('div');
                    targetInfo.className = 'flex items-center';
                    targetInfo.innerHTML = `
                        <div class="avatar-frame w-12 h-12 mr-3">
                            <div class="w-full h-full rounded-full flex items-center justify-center filter brightness-75 contrast-125" style="background-color: ${target.avatarColor};">
                                <span class="text-white text-xs font-bold text-center leading-tight drop-shadow-[0_0_4px_rgba(0,0,0,0.8)]">${target.name}</span>
                            </div>
                        </div>
                        <span class="text-lg">${target.name}</span>
                    `;
                    
                    // æŠ•ç¥¨ç»™è¯¥ç›®æ ‡çš„ç©å®¶åˆ—è¡¨
                    const votersList = document.createElement('div');
                    votersList.className = 'flex flex-wrap items-center gap-2 max-w-md ml-4';
                    votersList.id = `voters-for-${target.id}`;
                    
                    // åˆå§‹åŒ–æ˜¾ç¤ºå½“å‰å·²ç»æŠ•ç¥¨ç»™è¯¥ç›®æ ‡çš„ç©å®¶
                    const currentVoters = this.players.filter(player => 
                        player.id !== target.id && 
                        player.alive && 
                        this.votes[player.id] === target.id
                    );
                    
                    currentVoters.forEach(voter => {
                        const voterContainer = document.createElement('div');
                        voterContainer.className = 'flex flex-col items-center gap-1';
                        
                        const voterAvatar = document.createElement('div');
                        voterAvatar.className = 'w-8 h-8 rounded-full flex items-center justify-center filter brightness-75 contrast-125 cursor-help';
                        voterAvatar.style.backgroundColor = voter.avatarColor;
                        voterAvatar.textContent = voter.name.charAt(0);
                        voterAvatar.title = voter.name;
                        
                        const voterName = document.createElement('span');
                        voterName.className = 'text-xs text-center';
                        voterName.textContent = voter.name;
                        
                        voterContainer.appendChild(voterAvatar);
                        voterContainer.appendChild(voterName);
                        votersList.appendChild(voterContainer);
                    });
                    
                    targetElement.appendChild(targetInfo);
                    targetElement.appendChild(votersList);
                    
                    // ä»…åœ¨ç”¨æˆ·å›åˆä¸”ä¸æ˜¯è‡ªå·±æ—¶æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    if (isUserTurn && target.id !== 'user') {
                        targetElement.addEventListener('click', () => {
                            this.showVoteConfirmation(target, () => {
                                // ç¡®ä¿åªè®°å½•ä¸€æ¬¡æŠ•ç¥¨
                                if (!this.hasUserVoted) {
                                    this.votes['user'] = target.id;
                                    this.hasUserVoted = true; // æ ‡è®°ç”¨æˆ·å·²ç»æŠ•ç¥¨
                                    this.logMessage(`ä½ æŠ•ç¥¨ç»™äº† ${target.name}ã€‚`);
                                    this.updateUI();
                                    this.updateVotingModal(); // æ›´æ–°æŠ•ç¥¨çª—å£ä¸­çš„æŠ•ç¥¨è€…åˆ—è¡¨
                                    
                                    // å°†æŠ•ç¥¨çª—å£å˜ä¸ºä¸å¯äº¤äº’çŠ¶æ€
                                    this.votingTargetsContainer.querySelectorAll('.cursor-pointer').forEach(element => {
                                        element.classList.remove('cursor-pointer', 'hover:bg-[var(--primary)]');
                                        element.classList.add('cursor-not-allowed');
                                    });
                                    
                                    // å¦‚æœæœ‰å¼ƒç¥¨æŒ‰é’®ï¼Œä¹Ÿå°†å…¶å˜ä¸ºä¸å¯äº¤äº’çŠ¶æ€
                                    const abstainBtn = this.abstainContainer.querySelector('button');
                                    if (abstainBtn) {
                                        abstainBtn.classList.remove('cursor-pointer', 'hover:bg-[var(--primary-dark)]');
                                        abstainBtn.classList.add('cursor-not-allowed');
                                    }
                                    
                                    // éšè—æŠ•ç¥¨ç¡®è®¤å¼¹çª—å’Œå¼ƒç¥¨æŒ‰é’®
                                    this.votingConfirmation.classList.add('hidden');
                                    this.abstainContainer.classList.add('hidden');
                                    
                                    // ä¸ç«‹å³éšè—çª—å£ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å…¶ä»–AIæŠ•ç¥¨æƒ…å†µ
                                    resolve();
                                }
                            });
                        });
                    }
                    
                    this.votingTargetsContainer.appendChild(targetElement);
                });
                
                // æ·»åŠ å¼ƒç¥¨æŒ‰é’®ï¼ˆä»…ç¬¬ä¸€å¤©ï¼‰
                if (this.currentDay === 1) {
                    const abstainBtn = document.createElement('button');
                    if (isUserTurn) {
                        abstainBtn.className = 'px-8 py-2 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-[var(--text-light)] rounded-lg action-button border-2 border-[var(--accent)]';
                    } else {
                        abstainBtn.className = 'px-8 py-2 bg-[var(--primary)] text-[var(--text-light)] rounded-lg action-button border-2 border-[var(--accent)] cursor-not-allowed';
                    }
                    abstainBtn.textContent = 'å¼ƒç¥¨';
                    
                    // ä»…åœ¨ç”¨æˆ·å›åˆæ·»åŠ ç‚¹å‡»äº‹ä»¶
                    if (isUserTurn) {
                        abstainBtn.addEventListener('click', () => {
                            this.showAbstainConfirmation(() => {
                                // ç¡®ä¿åªè®°å½•ä¸€æ¬¡æŠ•ç¥¨
                                if (!this.hasUserVoted) {
                                    this.votes['user'] = 'abstain';
                                    this.hasUserVoted = true; // æ ‡è®°ç”¨æˆ·å·²ç»æŠ•ç¥¨
                                    this.logMessage(`ä½ é€‰æ‹©äº†å¼ƒç¥¨ã€‚`);
                                    this.updateUI();
                                    this.updateVotingModal(); // æ›´æ–°æŠ•ç¥¨çª—å£ä¸­çš„æŠ•ç¥¨è€…åˆ—è¡¨å’Œå¼ƒç¥¨ç»Ÿè®¡
                                    
                                    // å°†æŠ•ç¥¨çª—å£å˜ä¸ºä¸å¯äº¤äº’çŠ¶æ€
                                    this.votingTargetsContainer.querySelectorAll('.cursor-pointer').forEach(element => {
                                        element.classList.remove('cursor-pointer', 'hover:bg-[var(--primary)]');
                                        element.classList.add('cursor-not-allowed');
                                    });
                                    
                                    // å¦‚æœæœ‰å¼ƒç¥¨æŒ‰é’®ï¼Œä¹Ÿå°†å…¶å˜ä¸ºä¸å¯äº¤äº’çŠ¶æ€
                                    const abstainBtn = this.abstainContainer.querySelector('button');
                                    if (abstainBtn) {
                                        abstainBtn.classList.remove('cursor-pointer', 'hover:bg-[var(--primary-dark)]');
                                        abstainBtn.classList.add('cursor-not-allowed');
                                    }
                                    
                                    // éšè—æŠ•ç¥¨ç¡®è®¤å¼¹çª—å’Œå¼ƒç¥¨æŒ‰é’®
                                    this.votingConfirmation.classList.add('hidden');
                                    this.abstainContainer.classList.add('hidden');
                                    
                                    // ä¸ç«‹å³éšè—çª—å£ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å…¶ä»–AIæŠ•ç¥¨æƒ…å†µ
                                    resolve();
                                }
                            });
                        });
                    }
                    
                    this.abstainContainer.appendChild(abstainBtn);
                }
                
                // ç»‘å®šçª—å£æœ€å°åŒ–äº‹ä»¶
                this.minimizeVotingBtn.addEventListener('click', () => {
                    this.minimizeVotingModal();
                });
                
                // ç»‘å®šç¡®è®¤å’Œå–æ¶ˆäº‹ä»¶
                this.currentConfirmCallback = null;
                
                this.confirmVoteBtn.addEventListener('click', () => {
                    if (this.currentConfirmCallback) {
                        this.currentConfirmCallback();
                    }
                });
                
                this.cancelVoteBtn.addEventListener('click', () => {
                    this.votingConfirmation.classList.add('hidden');
                });
                
                // æ˜¾ç¤ºçª—å£
                this.votingModal.classList.remove('hidden');
                
                // å¯ç”¨æœ€å°åŒ–æŒ‰é’®çš„æ‹–æ‹½åŠŸèƒ½
                this.enableMinimizedBtnDrag();
            }

            showVoteConfirmation(target, confirmCallback) {
                this.voteConfirmText.textContent = `ç¡®è®¤æŠ•ç¥¨ç»™${target.name}`;
                this.votingConfirmation.classList.remove('hidden');
                this.currentConfirmCallback = confirmCallback;
            }
            
            showAbstainConfirmation(confirmCallback) {
                this.voteConfirmText.textContent = `ç¡®è®¤å¼ƒç¥¨`;
                this.votingConfirmation.classList.remove('hidden');
                this.currentConfirmCallback = confirmCallback;
            }
            
            hideVotingModal() {
                this.votingModal.classList.add('hidden');
                // åŒæ—¶éšè—æœ€å°åŒ–æµ®æ ‡
                this.minimizedVotingBtn.classList.add('hidden');
            }
            
            minimizeVotingModal() {
                this.votingModal.classList.add('hidden');
                this.minimizedVotingBtn.classList.remove('hidden');
            }
            
            restoreVotingModal() {
                this.minimizedVotingBtn.classList.add('hidden');
                this.votingModal.classList.remove('hidden');
            }
            
            enableMinimizedBtnDrag() {
                let isDragging = false;
                let offsetX, offsetY;

                const startDrag = (e) => {
                    isDragging = true;
                    offsetX = e.clientX - this.minimizedVotingBtn.getBoundingClientRect().left;
                    offsetY = e.clientY - this.minimizedVotingBtn.getBoundingClientRect().top;
                    this.minimizedVotingBtn.style.cursor = 'grabbing';
                };

                const drag = (e) => {
                    if (!isDragging) return;
                    
                    const newX = e.clientX - offsetX;
                    const newY = e.clientY - offsetY;
                    
                    // ç¡®ä¿æŒ‰é’®ä¸ä¼šè¶…å‡ºçª—å£è¾¹ç•Œ
                    const maxX = window.innerWidth - this.minimizedVotingBtn.offsetWidth;
                    const maxY = window.innerHeight - this.minimizedVotingBtn.offsetHeight;
                    
                    const clampedX = Math.max(0, Math.min(maxX, newX));
                    const clampedY = Math.max(0, Math.min(maxY, newY));
                    
                    this.minimizedVotingBtn.style.left = `${clampedX}px`;
                    this.minimizedVotingBtn.style.top = `${clampedY}px`;
                };

                const endDrag = () => {
                    isDragging = false;
                    this.minimizedVotingBtn.style.cursor = 'grab';
                };

                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                this.minimizedVotingBtn.addEventListener('mousedown', startDrag);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', endDrag);
                
                // ç‚¹å‡»æœ€å°åŒ–æŒ‰é’®æ¢å¤æŠ•ç¥¨çª—å£
                this.minimizedVotingBtn.addEventListener('click', () => {
                    this.restoreVotingModal();
                });
            }

            updateVotingModal() {
                // éå†æ‰€æœ‰æŠ•ç¥¨ç›®æ ‡ï¼ˆåŒ…æ‹¬ç”¨æˆ·è‡ªå·±ï¼‰
                const targets = this.players.filter(p => p.alive);
                targets.forEach(target => {
                    const votersList = document.getElementById(`voters-for-${target.id}`);
                    if (votersList) {
                        // æ¸…ç©ºå½“å‰çš„æŠ•ç¥¨è€…åˆ—è¡¨
                        votersList.innerHTML = '';
                        
                        // æ‰¾åˆ°æ‰€æœ‰æŠ•ç¥¨ç»™è¿™ä¸ªç›®æ ‡çš„ç©å®¶
                        const voters = this.players.filter(p => 
                            p.id !== target.id && 
                            p.alive && 
                            this.votes[p.id] === target.id
                        );
                        
                        // æ·»åŠ æ¯ä¸ªæŠ•ç¥¨è€…çš„å¤´åƒ
                        voters.forEach(voter => {
                            const voterContainer = document.createElement('div');
                            voterContainer.className = 'flex flex-col items-center gap-1';
                            
                            const voterAvatar = document.createElement('div');
                            voterAvatar.className = 'w-8 h-8 rounded-full flex items-center justify-center filter brightness-75 contrast-125 cursor-help';
                            voterAvatar.style.backgroundColor = voter.avatarColor;
                            voterAvatar.textContent = voter.name.charAt(0);
                            voterAvatar.title = voter.name;
                            
                            const voterName = document.createElement('span');
                            voterName.className = 'text-xs text-center';
                            voterName.textContent = voter.name;
                            
                            voterContainer.appendChild(voterAvatar);
                            voterContainer.appendChild(voterName);
                            votersList.appendChild(voterContainer);
                        });
                    }
                });
                
                // æ›´æ–°å¼ƒç¥¨ç»Ÿè®¡ï¼ˆå¦‚æœéœ€è¦ï¼‰
                const abstainers = this.players.filter(p => p.alive && this.votes[p.id] === 'abstain');
                const abstainBtn = this.abstainContainer.querySelector('button');
                if (abstainBtn) {
                    abstainBtn.textContent = `å¼ƒç¥¨ (${abstainers.length})`;
                }
            }

            async resolveVoting() {
                // éšè—æœ€å°åŒ–æŠ•ç¥¨å›¾æ ‡
                this.minimizedVotingBtn.classList.add('hidden');
                const voteCounts = {};
                // è¿‡æ»¤æ‰å¼ƒç¥¨çš„æŠ•ç¥¨
                const validVotes = Object.values(this.votes).filter(vote => vote !== 'abstain');
                
                // å¦‚æœæ‰€æœ‰ç©å®¶éƒ½å¼ƒç¥¨
                if (validVotes.length === 0) {
                    this.logMessage(`ã€æ‰€æœ‰äººéƒ½é€‰æ‹©äº†å¼ƒç¥¨ï¼Œæœ¬è½®æ²¡æœ‰ç©å®¶è¢«å¤„å†³ã€‘`, 'system');
                    this.updateUI();
                    this.checkGameOver();
                    if (!this.gameOver) {
                        this.startNightPhase();
                    }
                    return;
                }
                
                // ç»Ÿè®¡æŠ•ç¥¨æ•°å¹¶æ›´æ–°ç©å®¶çš„voteCount
                validVotes.forEach(vote => {
                    voteCounts[vote] = (voteCounts[vote] || 0) + 1;
                    // æ›´æ–°ç©å®¶çš„voteCount
                    const player = this.players.find(p => p.id === vote);
                    if (player) {
                        player.voteCount += 1;
                    }
                });

                const sortedVotes = Object.entries(voteCounts).sort((a, b) => b[1] - a[1]);
                if (sortedVotes.length > 1 && sortedVotes[0][1] === sortedVotes[1][1]) {
                    this.logMessage(`ã€${this.players.find(p => p.id === sortedVotes[0][0]).name} ä¸ ${this.players.find(p => p.id === sortedVotes[1][0]).name} ç¥¨æ•°ç›¸åŒï¼Œè¿›å…¥é‡æ–°æŠ•ç¥¨ç¯èŠ‚ã€‘`, 'system');
                    this.startVotingPhase(true);
                } else {
                    const executedPlayer = this.players.find(p => p.id === sortedVotes[0][0]);
                    if (executedPlayer.role === 'idiot') {
                        this.logMessage(`ã€${executedPlayer.name} æ˜¯ç™½ç—´ï¼Œè¢«æŠ•ç¥¨å‡ºå±€ä½†ä¸ä¼šæ­»äº¡ã€‘`, 'system');
                        // å¤„ç†ç™½ç—´è¢«æŠ•ç¥¨å‡ºå±€åçš„æ€€ç–‘åº¦å˜åŒ–ï¼ˆ12äººå±€ï¼‰
                        if (this.playerCount === 12) {
                            this.handleIdiotSurvival(executedPlayer.id);
                        }
                    } else {
                        executedPlayer.alive = false;
                        executedPlayer.causeOfDeath = 'vote'; // æŠ•ç¥¨å¤„å†³
                        this.logMessage(`ã€${executedPlayer.name} ç¥¨æ•°æœ€å¤šï¼Œè¢«å¤„æ­»ã€‘`, 'system');
                        
                        // å¤„ç†é—è¨€ç¯èŠ‚
                        await this.handleLastWords(executedPlayer);
                        
                        // æ£€æŸ¥çŒäººæŠ€èƒ½ï¼Œç¡®ä¿åœ¨è¿›å…¥å¤œæ™šå‰å®Œæˆ
                        if (executedPlayer.role === 'hunter' && this.witchPoisonTarget !== executedPlayer.id) {
                            await this.triggerHunterSkill(executedPlayer);
                        }
                    }
                    
                    this.updateUI();
                    this.checkGameOver();
                    if (!this.gameOver) {
                        this.startNightPhase();
                    }
                }
            }

            async handleLastWords(player) {
                // é—è¨€ç¯èŠ‚
                this.logMessage('ã€é—è¨€ç¯èŠ‚ã€‘', 'system');
                
                if (player.isUser) {
                    // ç©å®¶å‘è¡¨é—è¨€
                    await this.userLastWords(player);
                } else {
                    // AIå‘è¡¨é—è¨€
                    await this.aiLastWords(player);
                }
            }

            async userLastWords(player) {
                return new Promise((resolve) => {
                    this.logMessage(`ã€è½®åˆ°ä½ å‘è¡¨é—è¨€ã€‘`, 'system');
                    
                    // ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©æ˜¯å¦å£°ç§°èº«ä»½
                    const roleOptions = [
                        {id: `claim-${player.role}`, text: `${this.getRoleName(player.role)}ï¼ˆçœŸå®èº«ä»½ï¼‰`},
                        {id: 'claim-seer', text: 'é¢„è¨€å®¶ï¼ˆä¼ªè£…ï¼‰'},
                        {id: 'claim-witch', text: 'å¥³å·«ï¼ˆä¼ªè£…ï¼‰'},
                        {id: 'claim-hunter', text: 'çŒäººï¼ˆä¼ªè£…ï¼‰'},
                        ...(this.playerCount === 12 ? [{id: 'claim-idiot', text: 'ç™½ç—´ï¼ˆä¼ªè£…ï¼‰'}] : []),
                        {id: 'claim-villager', text: 'å¹³æ°‘ï¼ˆä¼ªè£…ï¼‰'}
                    ];
                    
                    this.showActionButtons('é€‰æ‹©ä½ è¦å£°ç§°çš„èº«ä»½', roleOptions, handleRoleClaim.bind(this), 30);
                    
                    // å¤„ç†èº«ä»½å£°ç§°
                    function handleRoleClaim(roleClaimId) {
                        const claimedRole = roleClaimId.split('-')[1];
                        this.logMessage(`"æˆ‘æ˜¯ ${this.getRoleName(claimedRole)}ã€‚"`, 'normal', player);
                        
                        // ç¬¬äºŒæ­¥ï¼šé€‰æ‹©æ˜¯å¦è¡¨è¾¾æ€€ç–‘/ä¿¡ä»»
                        const nextOptions = [
                            {id: 'suspect', text: 'è¡¨ç¤ºæ€€ç–‘è°'},
                            {id: 'trust', text: 'è¡¨ç¤ºä¿¡ä»»è°'},
                            {id: 'end-lastwords', text: 'ç»“æŸé—è¨€'}
                        ];
                        
                        this.showActionButtons('é€‰æ‹©ä½ è¦è¡¨è¾¾çš„å†…å®¹', nextOptions, handleNextStep.bind(this), 30);
                    }
                    
                    // å¤„ç†ä¸‹ä¸€æ­¥é€‰æ‹©
                    function handleNextStep(optionId) {
                        switch (optionId) {
                            case 'suspect':
                                // é€‰æ‹©æ€€ç–‘çš„äºº
                                const suspectTargets = this.players.filter(p => p.alive && p.id !== player.id);
                                if (suspectTargets.length > 0) {
                                    // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—ç›®æ ‡ï¼Œå¦‚æœspeechOrderä¸ºç©ºåˆ™æŒ‰ç©å®¶IDæ’åº
                                    const sortedSuspectTargets = [...suspectTargets].sort((a, b) => {
                                        const aIndex = this.speechOrder.indexOf(a.id);
                                        const bIndex = this.speechOrder.indexOf(b.id);
                                        if (aIndex === -1 || bIndex === -1) {
                                            // å¦‚æœspeechOrderä¸­æ²¡æœ‰æ‰¾åˆ°ç©å®¶IDï¼ŒæŒ‰ç©å®¶IDæ’åº
                                            return a.id.localeCompare(b.id);
                                        }
                                        return aIndex - bIndex;
                                    });
                                    this.showActionButtons('é€‰æ‹©ä½ æ€€ç–‘çš„äºº', sortedSuspectTargets.map(p => ({id: p.id, text: p.name})), (targetId) => {
                                        const target = this.players.find(p => p.id === targetId);
                                        this.logMessage(`"æˆ‘æ€€ç–‘ ${target.name} æ˜¯ç‹¼äººï¼Œä»–çš„è¡Œä¸ºå¾ˆå¯ç–‘ã€‚"`, 'normal', player);
                                        // å½±å“å…¶ä»–AIçš„æ€€ç–‘åº¦
                                        this.updateAISuspicion(targetId, player.id);
                                        resolve();
                                    }, 30);
                                } else {
                                    resolve();
                                }
                                break;
                            
                            case 'trust':
                                // é€‰æ‹©ä¿¡ä»»çš„äºº
                                const trustTargets = this.players.filter(p => p.alive && p.id !== player.id);
                                if (trustTargets.length > 0) {
                                    // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—ç›®æ ‡ï¼Œå¦‚æœspeechOrderä¸ºç©ºåˆ™æŒ‰ç©å®¶IDæ’åº
                                    const sortedTrustTargets = [...trustTargets].sort((a, b) => {
                                        const aIndex = this.speechOrder.indexOf(a.id);
                                        const bIndex = this.speechOrder.indexOf(b.id);
                                        if (aIndex === -1 || bIndex === -1) {
                                            // å¦‚æœspeechOrderä¸­æ²¡æœ‰æ‰¾åˆ°ç©å®¶IDï¼ŒæŒ‰ç©å®¶IDæ’åº
                                            return a.id.localeCompare(b.id);
                                        }
                                        return aIndex - bIndex;
                                    });
                                    this.showActionButtons('é€‰æ‹©ä½ ä¿¡ä»»çš„äºº', sortedTrustTargets.map(p => ({id: p.id, text: p.name})), (targetId) => {
                                        const target = this.players.find(p => p.id === targetId);
                                        this.logMessage(`"æˆ‘ä¿¡ä»» ${target.name}ï¼Œä»–åº”è¯¥æ˜¯å¥½äººã€‚"`, 'normal', player);
                                        this.updateAITrustBySpeech(targetId, player.id);
                                        resolve();
                                    }, 30);
                                } else {
                                    resolve();
                                }
                                break;
                            
                            case 'end-lastwords':
                                // ç»“æŸé—è¨€
                                resolve();
                                break;
                        }
                    }
                });
            }

            async aiLastWords(player) {
                return new Promise((resolve) => {
                    this.startTimer(3);
                    setTimeout(() => {
                        let speech = `ã€${player.name} çš„é—è¨€ã€‘`;
                        
                        // 80%æ¦‚ç‡å£°ç§°èº«ä»½
                        if (Math.random() < 0.8) {
                            let claimedRole;
                            if (player.role === 'werewolf') {
                                // ç‹¼äººå§‹ç»ˆä½¿ç”¨æœ¬å±€æ¸¸æˆä¸­ä¼ªè£…çš„èº«ä»½
                                if (player.claimedRole) {
                                    claimedRole = player.claimedRole;
                                } else {
                                    // å¦‚æœæ²¡æœ‰ä¼ªè£…èº«ä»½ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªéç‹¼äººçš„èº«ä»½
                                    const fakeRoles = this.playerCount === 12 ? ['seer', 'witch', 'idiot', 'villager'] : ['seer', 'witch', 'villager'];
                                    
                                    // è·å–å…¶ä»–ç‹¼äººå·²ç»é€‰æ‹©çš„ä¼ªè£…èº«ä»½
                                    const otherWolves = this.players.filter(p => p.role === 'werewolf' && p.id !== player.id && p.claimedRole);
                                    const takenRoles = otherWolves.map(wolf => wolf.claimedRole);
                                    
                                    // ä»å¯ç”¨èº«ä»½ä¸­æ’é™¤å·²è¢«é€‰æ‹©çš„èº«ä»½
                                    const availableRoles = fakeRoles.filter(role => !takenRoles.includes(role) || role === 'villager');
                                    
                                    // å¦‚æœæ²¡æœ‰å¯ç”¨çš„éæ‘æ°‘èº«ä»½ï¼Œå°±é€‰æ‹©æ‘æ°‘
                                    claimedRole = availableRoles[Math.floor(Math.random() * availableRoles.length)] || 'villager';
                                }
                            } else {
                                // å¥½äººä¼˜å…ˆä½¿ç”¨å·²å£°ç§°çš„èº«ä»½ï¼Œå¦åˆ™ä½¿ç”¨çœŸå®èº«ä»½
                                if (player.claimedRole) {
                                    claimedRole = player.claimedRole;
                                } else {
                                    claimedRole = player.role;
                                }
                            }
                            speech += ` æˆ‘æ˜¯ ${this.getRoleName(claimedRole)}ã€‚`;
                        }
                        
                        // ä¼˜å…ˆè¡¨è¿°è‡ªå·±æœ€æ€€ç–‘çš„äºº
                        const suspicionLevels = {...player.ai.suspicionLevels};
                        // è¿‡æ»¤æ‰å·²æ­»äº¡çš„ç©å®¶
                        Object.keys(suspicionLevels).forEach(id => {
                            const target = this.players.find(p => p.id === id);
                            if (!target || !target.alive) {
                                delete suspicionLevels[id];
                            }
                        });
                        
                        const sortedSuspicion = Object.entries(suspicionLevels).sort((a, b) => b[1] - a[1]);
                        if (sortedSuspicion.length > 0) {
                            const mostSuspicious = this.players.find(p => p.id === sortedSuspicion[0][0]);
                            speech += ` æˆ‘æœ€æ€€ç–‘ ${mostSuspicious.name}ï¼Œä»–è‚¯å®šæ˜¯ç‹¼äººã€‚`;
                            // å½±å“å…¶ä»–AIçš„æ€€ç–‘åº¦
                            this.updateAISuspicion(mostSuspicious.id, player.id);
                        }
                        
                        this.logMessage(speech, 'normal', player);
                        resolve();
                    }, 1000 + Math.random() * 2000);
                });
            }

            checkGameOver() {
                // è®¡ç®—å­˜æ´»çš„ç‹¼äººå’Œå¥½äººæ•°é‡
                const aliveWerewolves = this.players.filter(p => p.alive && p.role === 'werewolf').length;
                
                // è®¡ç®—å­˜æ´»çš„å¹³æ°‘å’Œç¥èŒæ•°é‡
                const aliveVillagers = this.players.filter(p => p.alive && p.role === 'villager').length;
                const aliveSpecialRoles = this.players.filter(p => p.alive && ['seer', 'witch', 'hunter', 'idiot'].includes(p.role)).length;
                
                // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
                if (aliveWerewolves === 0) {
                    this.gameOver = true;
                    this.showGameOver('å¥½äººé˜µè¥è·èƒœï¼æ‰€æœ‰ç‹¼äººå·²è¢«æ¶ˆç­ã€‚');
                } else if (aliveVillagers === 0 || aliveSpecialRoles === 0) {
                    this.gameOver = true;
                    this.showGameOver('ç‹¼äººé˜µè¥è·èƒœï¼åœºä¸Šå¹³æ°‘å·²å…¨ç­æˆ–ç¥èŒå·²å…¨ç­ã€‚');
                }
            }

            showGameOver(message) {
                this.gameOverMessage.textContent = message;
                let statsHTML = '<h3 class="text-2xl font-bold text-[var(--text-gold)] mb-4">èº«ä»½ä¸çŠ¶æ€</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">';
                this.players.forEach(p => {
                    statsHTML += `
                        <div class="flex items-center space-x-3 p-3 bg-[rgba(255,255,255,0.1)] rounded-lg">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background-color: ${p.avatarColor}">
                                <span class="text-white font-bold">${p.name.charAt(0)}</span>
                            </div>
                            <div>
                                <p class="font-bold">${p.name}</p>
                                <p class="role-${p.role}">${this.getRoleName(p.role)} - ${p.alive ? 'å­˜æ´»' : 'æ­»äº¡'}</p>
                            </div>
                        </div>
                    `;
                });
                statsHTML += '</div>';

                statsHTML += '<h3 class="text-2xl font-bold text-[var(--text-gold)] mb-4">AI æ€€ç–‘åº¦</h3><div class="space-y-2">';
                this.players.filter(p => !p.isUser).forEach(ai => {
                    const maxSuspicion = Object.entries(ai.ai.suspicionLevels).sort((a, b) => b[1] - a[1])[0];
                    if (maxSuspicion) {
                        const target = this.players.find(p => p.id === maxSuspicion[0]);
                        statsHTML += `
                            <div class="flex items-center justify-between p-3 bg-[rgba(255,255,255,0.1)] rounded-lg">
                                <span>${ai.name} æœ€æ€€ç–‘</span>
                                <span class="font-bold">${target.name}</span>
                                <span class="text-[var(--secondary)] font-bold">${Math.round(maxSuspicion[1])}%</span>
                            </div>
                        `;
                    }
                });
                statsHTML += '</div>';

                this.statsContainer.innerHTML = statsHTML;
                this.gameOverModal.classList.remove('hidden');
            }

            resetGame() {
                this.gameOverModal.classList.add('hidden');
                this.gameScreen.classList.add('hidden');
                this.menuScreen.classList.remove('hidden');
                this.players = [];
                this.currentPlayer = null;
                this.gamePhase = 'menu';
                this.currentDay = 0;
                this.currentPhase = '';
                this.playerCount = null;
                this.timer = null;
                this.timerDuration = 0;
                this.votes = {};
                this.actionInProgress = false;
                this.deathsThisNight = [];
                this.usedItems = { 'potion': false, 'poison': false, 'reportedPoison': false, 'reportedHeal': false };
                this.werewolfTarget = null;
                this.seerResults = {};
                this.witchHealTarget = null;
                this.witchPoisonTarget = null;
                this.speechOrder = [];
                this.currentSpeakerIndex = 0;
                this.gameOver = false;
                this.playerCountOptions.querySelectorAll('button').forEach(b => {
                    b.classList.remove('bg-[var(--secondary)]');
                    b.classList.add('bg-[var(--primary)]');
                });
                this.startGameBtn.disabled = true;
                this.chatArea.innerHTML = '';
                this.statusBar.innerHTML = '';
                this.actionArea.innerHTML = '';
            }

            updateUI() {
                this.statusBar.innerHTML = '';
                // æŒ‰ç…§å‘è¨€é¡ºåºæ’åˆ—æ‰€æœ‰ç©å®¶å¤´åƒï¼ˆåŒ…æ‹¬å·²ç¦»å¼€ç©å®¶ï¼‰
                const allPlayers = [...this.players];
                const sortedPlayers = [...this.speechOrder, ...allPlayers.filter(p => !this.speechOrder.includes(p.id))];
                
                sortedPlayers.forEach(speakerId => {
                    const player = this.players.find(p => p.id === speakerId);
                    if (player) {
                        const voteCount = Object.values(this.votes).filter(v => v === player.id).length;
                        const isSpeaking = this.currentPlayer && this.currentPlayer.id === player.id;
                        const isDead = !player.alive;
                        const avatarDiv = document.createElement('div');
                        avatarDiv.className = `player-avatar flex flex-col items-center ${isSpeaking ? 'ring-4 ring-[var(--text-gold)] ring-offset-2 ring-offset-[var(--background)]' : ''} ${isDead ? 'opacity-60' : ''}`;
                        avatarDiv.innerHTML = `
                            <div class="avatar-frame ${isDead ? 'dead' : ''} relative">
                                <div class="w-20 h-20 rounded-full flex items-center justify-center filter brightness-75 contrast-125" style="background-color: ${player.avatarColor}">
                                    <span class="text-white text-sm font-bold text-center leading-tight drop-shadow-[0_0_4px_rgba(0,0,0,0.8)]">${player.name}</span>
                                </div>
                                ${isDead ? `<div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 z-10">${this.getDeathEmoji(player.causeOfDeath)}</div>` : ''}
                                ${voteCount > 0 ? `<div class="vote-count-center">${voteCount}</div>` : ''}
                            </div>
                            <p class="mt-2 font-bold text-center ${isDead ? 'line-through text-gray-400' : ''}">${player.name}</p>
                            ${player.isUser && player.alive ? `<p class="text-sm role-${player.role}">${this.getRoleName(player.role)}</p>` : ''}
                            ${this.currentPlayer && this.currentPlayer.role === 'werewolf' && player.role === 'werewolf' && !player.isUser && player.alive ? 
                                `<p class="text-xs text-red-500 font-bold">ç‹¼äºº</p>` : ''}
                            ${isDead ? '<p class="text-xs text-gray-400">å·²ç¦»å¼€</p>' : ''}
                        `;
                        this.statusBar.appendChild(avatarDiv);
                    }
                });
                lucide.createIcons();
            }

            logMessage(message, type = 'normal', speaker = null) {
                const msgElement = document.createElement('div');
                msgElement.className = `chat-message ${type}`;
                
                if (speaker && !type.includes('system') && !type.includes('private')) {
                    const speakerAvatar = document.createElement('div');
                    speakerAvatar.className = 'flex items-center gap-3';
                    speakerAvatar.innerHTML = `
                        <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center" style="background-color: ${speaker.avatarColor}">
                            <span class="text-white text-sm font-bold">${speaker.name.charAt(0)}</span>
                        </div>
                        <div>${message}</div>
                    `;
                    msgElement.appendChild(speakerAvatar);
                } else {
                    msgElement.innerHTML = message;
                }
                
                this.chatArea.appendChild(msgElement);
                this.chatArea.scrollTop = this.chatArea.scrollHeight;
            }

            showActionButtons(title, buttons, callback, timerDuration) {
                this.actionInProgress = true;
                this.actionArea.innerHTML = `<h3 class="text-xl font-bold mb-6 text-center">${title}</h3>`;
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'grid grid-cols-1 gap-4 w-full';
                buttons.forEach(btn => {
                    const button = document.createElement('button');
                    button.className = 'px-6 py-3 bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-[var(--text-light)] rounded-lg action-button text-lg border-2 border-[var(--accent)]';
                    button.textContent = btn.text;
                    button.addEventListener('click', () => {
                        this.actionArea.innerHTML = '';
                        this.actionInProgress = false;
                        this.clearTimer();
                        callback(btn.id);
                    });
                    buttonContainer.appendChild(button);
                });
                this.actionArea.appendChild(buttonContainer);
                if (timerDuration) {
                    this.startTimer(timerDuration, () => {
                        if (this.actionInProgress) {
                            const randomBtn = buttons[Math.floor(Math.random() * buttons.length)];
                            this.actionArea.innerHTML = '';
                            this.actionInProgress = false;
                            callback(randomBtn.id);
                        }
                    });
                }
            }

            startTimer(duration, onTimeout) {
                this.clearTimer();
                this.timerDuration = duration;
                this.timerBar.style.width = '100%';
                this.timer = setInterval(() => {
                    this.timerDuration--;
                    if (this.timerDuration <= 0) {
                        this.clearTimer();
                        if (onTimeout) onTimeout();
                    } else {
                        this.timerBar.style.width = `${(this.timerDuration / duration) * 100}%`;
                    }
                }, 1000);
            }

            clearTimer() {
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
                this.timerBar.style.width = '100%';
            }

            updateAISuspicion(targetId, speakerId = 'unknown') {
                if (!targetId) return;
                const targetPlayer = this.players.find(p => p.id === targetId);
                const speaker = this.players.find(p => p.id === speakerId);
                // ä¸ä¸ºæ­»äº¡ç©å®¶å¢åŠ æ€€ç–‘åº¦
                if (!targetPlayer || !targetPlayer.alive) return;
                
                this.players.forEach(p => {
                    if (!p.isUser && p.alive) {
                        // è§„åˆ™3ï¼šçœŸå®ç¥èŒæ— è§†å†’ç‰Œè€…çš„ä¿¡æ¯
                        // æ£€æŸ¥å½“å‰AIæ˜¯å¦æ˜¯çœŸå®ç¥èŒï¼Œä»¥åŠç›®æ ‡æ˜¯å¦æ˜¯å£°ç§°ç›¸åŒç¥èŒçš„å†’ç‰Œè€…
                        if (p.role !== 'villager' && p.role !== 'werewolf' && 
                            targetPlayer.claimedRole === p.role && targetPlayer.id !== p.id) {
                            // çœŸå®ç¥èŒæ— è§†å†’ç‰Œè€…çš„ä¿¡æ¯ï¼Œä¸ä¿®æ”¹æ€€ç–‘åº¦
                            return;
                        }
                        
                        // æ£€æŸ¥å½“å‰AIæ˜¯å¦æ˜¯é¢„è¨€å®¶ï¼Œä»¥åŠç›®æ ‡æ˜¯å¦å·²ç»è¢«ä»–ä»¬æŸ¥éªŒè¿‡
                        if (p.role === 'seer') {
                            const seerResult = this.seerResults[p.id];
                            if (seerResult && seerResult.targetId === targetId) {
                                // å¦‚æœæ˜¯é¢„è¨€å®¶ä¸”ç›®æ ‡å·²ç»è¢«æŸ¥éªŒè¿‡ï¼Œä¸ä¿®æ”¹æ€€ç–‘åº¦
                                return;
                            }
                        }
                        // æ ¹æ®æ¸¸æˆäººæ•°è°ƒæ•´æ€€ç–‘åº¦å¢åŠ èŒƒå›´ï¼Œé˜²æ­¢ç‹¼äººè¿…é€Ÿå¸¦èŠ‚å¥
                        let suspicionIncrease = 0;
                        if (this.playerCount === 6) {
                            // 6äººå±€ï¼šæ€€ç–‘åº¦å¢åŠ 1~6
                            suspicionIncrease = Math.floor(Math.random() * 6) + 1;
                        } else if (this.playerCount === 9) {
                            // 9äººå±€ï¼šæ€€ç–‘åº¦å¢åŠ 2~11
                            suspicionIncrease = Math.floor(Math.random() * 10) + 2;
                        } else if (this.playerCount === 12) {
                            // 12äººå±€ï¼šæ€€ç–‘åº¦å¢åŠ 3~16
                            suspicionIncrease = Math.floor(Math.random() * 14) + 3;
                        }
                        // ç¡®ä¿suspicionLevelså­˜åœ¨
                        if (!p.ai.suspicionLevels) {
                            p.ai.suspicionLevels = {};
                        }
                        const oldLevel = p.ai.suspicionLevels[targetId] || 0;
                        p.ai.suspicionLevels[targetId] = Math.min(1000, Math.max(-1000, oldLevel + suspicionIncrease));
                        const newLevel = p.ai.suspicionLevels[targetId];
                        console.log(`${p.name}å¯¹${targetPlayer.name}çš„æ€€ç–‘åº¦å¢åŠ äº†${Math.round(suspicionIncrease)}ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(newLevel)}`);
                        
                        // è®°å½•æ€€ç–‘åº¦å˜åŒ–
                        this.logSuspicionChange(`${p.name}å¯¹${targetPlayer.name}çš„æ€€ç–‘åº¦å¢åŠ äº†${Math.round(suspicionIncrease)}ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(newLevel)}`);
                    }
                });
                
                // å½“AIè¢«æ€€ç–‘æ—¶ï¼Œå¯¹å‘è¨€è€…äº§ç”Ÿç­‰é‡çš„æ€€ç–‘åº¦å˜åŒ–ï¼ˆå¦‚æœå‘è¨€è€…ä¸æ˜¯unknownï¼‰
                if (speakerId !== 'unknown' && targetPlayer && !targetPlayer.isUser && targetPlayer.alive) {
                    // è¢«æ€€ç–‘çš„AIå¯¹å‘è¨€è€…çš„æ€€ç–‘åº¦å¢åŠ ç›¸åŒçš„é‡
                    // é¦–å…ˆéœ€è¦è®¡ç®—æœ¬æ¬¡çš„æ€€ç–‘åº¦å¢åŠ é‡
                    let suspicionIncrease = 0;
                    if (this.playerCount === 6) {
                        suspicionIncrease = Math.floor(Math.random() * 6) + 1;
                    } else if (this.playerCount === 9) {
                        suspicionIncrease = Math.floor(Math.random() * 10) + 2;
                    } else if (this.playerCount === 12) {
                        suspicionIncrease = Math.floor(Math.random() * 14) + 3;
                    }
                    
                    if (!targetPlayer.ai.suspicionLevels) {
                        targetPlayer.ai.suspicionLevels = {};
                    }
                    targetPlayer.ai.suspicionLevels[speakerId] = Math.min(1000, Math.max(-1000, (targetPlayer.ai.suspicionLevels[speakerId] || 0) + suspicionIncrease));
                    console.log(`${targetPlayer.name}è¢«${speaker?.name || speakerId}æ€€ç–‘ï¼Œå¯¹å…¶æ€€ç–‘åº¦å¢åŠ äº†${Math.round(suspicionIncrease)}ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(targetPlayer.ai.suspicionLevels[speakerId])}`);
                    
                    // å¦‚æœè¢«æ€€ç–‘çš„ç›®æ ‡æ˜¯ç‹¼äººï¼Œç‹¼äººå¢åŠ å¯¹å‘è¨€è€…çš„é’ˆå¯¹å€¼
                    if (targetPlayer.role === 'werewolf') {
                            // å¢åŠ é’ˆå¯¹å€¼ï¼Œå¹…åº¦ç­‰åŒäºæ€€ç–‘åº¦å˜åŒ–å€¼
                            if (!targetPlayer.ai.targetingLevels) {
                                targetPlayer.ai.targetingLevels = {};
                            }
                            targetPlayer.ai.targetingLevels[speakerId] = Math.min(1000, Math.max(-1000, (targetPlayer.ai.targetingLevels[speakerId] || 0) + suspicionIncrease));
                            console.log(`${targetPlayer.name}è¢«${speaker?.name || speakerId}æ€€ç–‘ï¼Œå¢åŠ å¯¹å…¶é’ˆå¯¹å€¼${Math.round(suspicionIncrease)}ï¼Œå½“å‰é’ˆå¯¹å€¼ï¼š${Math.round(targetPlayer.ai.targetingLevels[speakerId])}`);
                            // è®°å½•é’ˆå¯¹å€¼å˜åŒ–åˆ°å…¬å±
                            this.logSuspicionChange(`${targetPlayer.name}å¯¹${speaker?.name || speakerId}çš„é’ˆå¯¹å€¼å¢åŠ äº†${Math.round(suspicionIncrease)}ï¼Œå½“å‰é’ˆå¯¹å€¼ï¼š${Math.round(targetPlayer.ai.targetingLevels[speakerId])}`);
                        }
                }
            }

            // æ›´æ–°AIå¯¹æŒ‡å®šç©å®¶çš„ä¿¡ä»»åº¦ï¼ˆé€šè¿‡å‘è¨€è¡¨è¾¾ä¿¡ä»»ï¼Œä¸updateAISuspicionç›¸åï¼‰
            updateAITrustBySpeech(targetId, speakerId = 'unknown') {
                if (!targetId) return;
                const targetPlayer = this.players.find(p => p.id === targetId);
                const speaker = this.players.find(p => p.id === speakerId);
                // ä¸ä¸ºæ­»äº¡ç©å®¶å‡å°‘æ€€ç–‘åº¦
                if (!targetPlayer || !targetPlayer.alive) return;
                
                this.players.forEach(p => {
                    if (!p.isUser && p.alive) {
                        // è§„åˆ™3ï¼šçœŸå®ç¥èŒæ— è§†å†’ç‰Œè€…çš„ä¿¡æ¯
                        // æ£€æŸ¥å½“å‰AIæ˜¯å¦æ˜¯çœŸå®ç¥èŒï¼Œä»¥åŠç›®æ ‡æ˜¯å¦æ˜¯å£°ç§°ç›¸åŒç¥èŒçš„å†’ç‰Œè€…
                        if (p.role !== 'villager' && p.role !== 'werewolf' && 
                            targetPlayer.claimedRole === p.role && targetPlayer.id !== p.id) {
                            // çœŸå®ç¥èŒæ— è§†å†’ç‰Œè€…çš„ä¿¡æ¯ï¼Œä¸ä¿®æ”¹æ€€ç–‘åº¦
                            return;
                        }
                        
                        // æ£€æŸ¥å½“å‰AIæ˜¯å¦æ˜¯é¢„è¨€å®¶ï¼Œä»¥åŠç›®æ ‡æ˜¯å¦å·²ç»è¢«ä»–ä»¬æŸ¥éªŒè¿‡
                        if (p.role === 'seer') {
                            const seerResult = this.seerResults[p.id];
                            if (seerResult && seerResult.targetId === targetId) {
                                // å¦‚æœæ˜¯é¢„è¨€å®¶ä¸”ç›®æ ‡å·²ç»è¢«æŸ¥éªŒè¿‡ï¼Œä¸ä¿®æ”¹æ€€ç–‘åº¦
                                return;
                            }
                        }
                        // æ ¹æ®æ¸¸æˆäººæ•°è°ƒæ•´æ€€ç–‘åº¦å‡å°‘èŒƒå›´ï¼Œä¸æ€€ç–‘åº¦å¢åŠ èŒƒå›´å¯¹ç§°
                        let suspicionDecrease = 0;
                        if (this.playerCount === 6) {
                            // 6äººå±€ï¼šæ€€ç–‘åº¦å‡å°‘1~6
                            suspicionDecrease = Math.floor(Math.random() * 6) + 1;
                        } else if (this.playerCount === 9) {
                            // 9äººå±€ï¼šæ€€ç–‘åº¦å‡å°‘2~11
                            suspicionDecrease = Math.floor(Math.random() * 10) + 2;
                        } else if (this.playerCount === 12) {
                            // 12äººå±€ï¼šæ€€ç–‘åº¦å‡å°‘3~16
                            suspicionDecrease = Math.floor(Math.random() * 14) + 3;
                        }
                        // ç¡®ä¿suspicionLevelså­˜åœ¨
                        if (!p.ai.suspicionLevels) {
                            p.ai.suspicionLevels = {};
                        }
                        const oldLevel = p.ai.suspicionLevels[targetId] || 0;
                        p.ai.suspicionLevels[targetId] = Math.min(1000, Math.max(-1000, oldLevel - suspicionDecrease));
                        const newLevel = p.ai.suspicionLevels[targetId];
                        console.log(`${p.name}å¯¹${targetPlayer.name}çš„æ€€ç–‘åº¦å‡å°‘äº†${Math.round(suspicionDecrease)}ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(newLevel)}`);
                        
                        // è®°å½•æ€€ç–‘åº¦å˜åŒ–
                        this.logSuspicionChange(`${p.name}å¯¹${targetPlayer.name}çš„æ€€ç–‘åº¦å‡å°‘äº†${Math.round(suspicionDecrease)}ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(newLevel)}`);
                    }
                });
                
                // å½“AIè¢«ä¿¡ä»»æ—¶ï¼Œå¯¹å‘è¨€è€…äº§ç”Ÿç­‰é‡çš„ä¿¡ä»»åº¦å˜åŒ–ï¼ˆå¦‚æœå‘è¨€è€…ä¸æ˜¯unknownï¼‰
                if (speakerId !== 'unknown' && targetPlayer && !targetPlayer.isUser && targetPlayer.alive) {
                    // è¢«ä¿¡ä»»çš„AIå¯¹å‘è¨€è€…çš„æ€€ç–‘åº¦å‡å°‘ç›¸åŒçš„é‡
                    // é¦–å…ˆéœ€è¦è®¡ç®—æœ¬æ¬¡çš„æ€€ç–‘åº¦å‡å°‘é‡
                    let suspicionDecrease = 0;
                    if (this.playerCount === 6) {
                        suspicionDecrease = Math.floor(Math.random() * 6) + 1;
                    } else if (this.playerCount === 9) {
                        suspicionDecrease = Math.floor(Math.random() * 10) + 2;
                    } else if (this.playerCount === 12) {
                        suspicionDecrease = Math.floor(Math.random() * 14) + 3;
                    }
                    
                    if (!targetPlayer.ai.suspicionLevels) {
                        targetPlayer.ai.suspicionLevels = {};
                    }
                    targetPlayer.ai.suspicionLevels[speakerId] = Math.min(1000, Math.max(-1000, (targetPlayer.ai.suspicionLevels[speakerId] || 0) - suspicionDecrease));
                    console.log(`${targetPlayer.name}è¢«${speaker?.name || speakerId}ä¿¡ä»»ï¼Œå¯¹å…¶æ€€ç–‘åº¦å‡å°‘äº†${Math.round(suspicionDecrease)}ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(targetPlayer.ai.suspicionLevels[speakerId])}`);
                    
                    // å¦‚æœè¢«ä¿¡ä»»çš„ç›®æ ‡æ˜¯ç‹¼äººï¼Œç‹¼äººå‡å°‘å¯¹å‘è¨€è€…çš„é’ˆå¯¹å€¼
                    if (targetPlayer.role === 'werewolf') {
                            // å‡å°‘é’ˆå¯¹å€¼ï¼Œå¹…åº¦ç­‰åŒäºä¿¡ä»»åº¦å˜åŒ–å€¼
                            if (!targetPlayer.ai.targetingLevels) {
                                targetPlayer.ai.targetingLevels = {};
                            }
                            targetPlayer.ai.targetingLevels[speakerId] = Math.min(1000, Math.max(-1000, (targetPlayer.ai.targetingLevels[speakerId] || 0) - suspicionDecrease));
                            console.log(`${targetPlayer.name}è¢«${speaker?.name || speakerId}ä¿¡ä»»ï¼Œå‡å°‘å¯¹å…¶é’ˆå¯¹å€¼${Math.round(suspicionDecrease)}ï¼Œå½“å‰é’ˆå¯¹å€¼ï¼š${Math.round(targetPlayer.ai.targetingLevels[speakerId])}`);
                            // è®°å½•é’ˆå¯¹å€¼å˜åŒ–åˆ°å…¬å±
                            this.logSuspicionChange(`${targetPlayer.name}å¯¹${speaker?.name || speakerId}çš„é’ˆå¯¹å€¼å‡å°‘äº†${Math.round(suspicionDecrease)}ï¼Œå½“å‰é’ˆå¯¹å€¼ï¼š${Math.round(targetPlayer.ai.targetingLevels[speakerId])}`);
                        }
                }
            }

            // è®°å½•æ€€ç–‘åº¦å˜åŒ–
            logSuspicionChange(message) {
                if (!this.developerModeEnabled) return;
                
                // å°†æ€€ç–‘åº¦å˜åŒ–ç›´æ¥è¾“å‡ºåˆ°å…¬å±
                this.logMessage(message, 'system');
            }
            
            // æ˜¾ç¤ºåˆå§‹æ€€ç–‘åº¦å’Œé’ˆå¯¹å€¼
            showInitialSuspicionLevels() {
                if (!this.developerModeEnabled) return;
                
                // è®°å½•åˆå§‹æ€€ç–‘åº¦å’Œé’ˆå¯¹å€¼
                this.logSuspicionChange('=== æ¸¸æˆå¼€å§‹ - åˆå§‹æ€€ç–‘åº¦å’Œé’ˆå¯¹å€¼ ===');
                
                this.players.forEach(player => {
                    if (!player.isUser) {
                        this.logSuspicionChange(`${player.name}çš„åˆå§‹æ€€ç–‘åº¦:`);
                        
                        Object.entries(player.ai.suspicionLevels).forEach(([targetId, level]) => {
                            const target = this.players.find(p => p.id === targetId);
                            if (target) {
                                this.logSuspicionChange(`  ${target.name}: ${level}`);
                            }
                        });
                        
                        this.logSuspicionChange(`${player.name}çš„åˆå§‹é’ˆå¯¹å€¼:`);
                        
                        Object.entries(player.ai.targetingLevels).forEach(([targetId, level]) => {
                            const target = this.players.find(p => p.id === targetId);
                            if (target) {
                                this.logSuspicionChange(`  ${target.name}: ${level}`);
                            }
                        });
                        
                        this.logSuspicionChange('------------------------------');
                    }
                });
            }
            
            // æ›´æ–°AIå¯¹æŒ‡å®šç©å®¶çš„ä¿¡ä»»åº¦ï¼ˆå‡å°‘æ€€ç–‘åº¦ï¼‰
            updateAITrust(targetId, healerId, amount) {
                if (!targetId || !healerId || !amount) return;
                
                this.players.forEach(p => {
                    if (!p.isUser && p.alive && p.id === targetId) {
                        const oldLevel = p.ai.suspicionLevels[healerId] || 0;
                        // è¢«æ•‘çš„äººå¯¹å¥³å·«å‡å°‘æ€€ç–‘åº¦ï¼ˆæå‡ä¿¡ä»»ï¼‰
                        p.ai.suspicionLevels[healerId] = Math.max(-1000, oldLevel - amount);
                        const newLevel = p.ai.suspicionLevels[healerId];
                        console.log(`${p.name}å¯¹${this.players.find(h => h.id === healerId)?.name}çš„ä¿¡ä»»åº¦å¢åŠ äº†${amount}ç‚¹`);
                        
                        // è®°å½•æ€€ç–‘åº¦å˜åŒ–
                        const healer = this.players.find(h => h.id === healerId);
                        if (healer) {
                            this.logSuspicionChange(`${p.name}å¯¹${healer.name}çš„æ€€ç–‘åº¦å‡å°‘äº†${amount}ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${newLevel}`);
                        }
                    }
                });
            }

            // å¤„ç†å¥³å·«æ•‘äººä¿¡æ¯å¯¹æ€€ç–‘åº¦çš„å½±å“
            handleWitchHealInfo(healerId, targetId) {
                if (!healerId || !targetId) return;
                
                this.players.forEach(p => {
                    if (!p.isUser && p.alive && p.id === targetId) {
                        // è¢«æ•‘çš„äººå¯¹å¥³å·«å‡å°‘å¤§é‡æ€€ç–‘åº¦ï¼ˆæå‡ä¿¡ä»»ï¼‰
                        const amount = 30 + Math.random() * 10;
                        const oldLevel = p.ai.suspicionLevels[healerId] || 0;
                        p.ai.suspicionLevels[healerId] = Math.max(-1000, oldLevel - amount);
                        const newLevel = p.ai.suspicionLevels[healerId];
                        const healer = this.players.find(h => h.id === healerId);
                        console.log(`${p.name}è¢«${healer?.name}æ•‘äº†ï¼Œå¯¹å…¶ä¿¡ä»»åº¦æå‡${Math.round(amount)}`);
                        
                        // è®°å½•æ€€ç–‘åº¦å˜åŒ–
                        if (healer) {
                            this.logSuspicionChange(`${p.name}è¢«${healer.name}æ•‘äº†ï¼Œå¯¹${healer.name}çš„æ€€ç–‘åº¦å‡å°‘äº†${Math.round(amount)}ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(newLevel)}`);
                        }
                    }
                });
            }

            // å¤„ç†é¢„è¨€å®¶æŸ¥éªŒä¿¡æ¯å¯¹æ€€ç–‘åº¦çš„å½±å“
            handleSeerCheckInfo(seerId, targetId, result) {
                if (!seerId || !targetId) return;
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦å‡å°‘é¢„è¨€å®¶æ±‡æŠ¥æ•ˆæœ
                const isSeerDead = this.players.some(p => p.claimedRole === 'seer' && !p.alive);
                const effectMultiplier = isSeerDead ? 0.25 : 1;
                // é’ˆå¯¹è¢«é”™è¯¯æŸ¥éªŒä¸ºç‹¼äººçš„å¥½äººç©å®¶ï¼Œå½“æœ‰é¢„è¨€å®¶æ­»äº¡æ—¶ï¼Œæ€€ç–‘åº¦å¢åŠ é‡åº”è¯¥æ›´é«˜
                const wrongAccusationMultiplier = isSeerDead ? 2 : 1;
                
                this.players.forEach(p => {
                    if (!p.isUser && p.alive) {
                        if (p.id === targetId) {
                            // è¢«æŸ¥éªŒçš„äººå¯¹é¢„è¨€å®¶çš„ååº”
                            if (result === 'å¥½äºº') {
                                // è¢«æŸ¥éªŒä¸ºå¥½äººï¼Œå¯¹é¢„è¨€å®¶å¤§å¹…å‡å°‘æ€€ç–‘åº¦ï¼ˆå¢åŠ ä¿¡ä»»ï¼‰
                                const change = (-40 - Math.random() * 15) * effectMultiplier;
                                // ç¡®ä¿suspicionLevelsæœ‰åˆå§‹å€¼
                                if (p.ai.suspicionLevels[seerId] === undefined) {
                                    p.ai.suspicionLevels[seerId] = 0;
                                }
                                // ç¡®ä¿suspicionLevelsæœ‰åˆå§‹å€¼
                            if (p.ai.suspicionLevels[seerId] === undefined) {
                                p.ai.suspicionLevels[seerId] = 0;
                            }
                            p.ai.suspicionLevels[seerId] = Math.max(-1000, p.ai.suspicionLevels[seerId] + change);
                                const seerPlayer = this.players.find(s => s.id === seerId);
                                console.log(`${p.name}è¢«é¢„è¨€å®¶${seerPlayer?.name}æŸ¥éªŒä¸ºå¥½äººï¼Œå¯¹å…¶ä¿¡ä»»åº¦å¤§å¹…æå‡${Math.round(change)}`);
                                this.logSuspicionChange(`${p.name}è¢«é¢„è¨€å®¶${seerPlayer?.name}æŸ¥éªŒä¸ºå¥½äººï¼Œå¯¹${seerPlayer?.name}çš„æ€€ç–‘åº¦å‡å°‘äº†${Math.round(Math.abs(change))}ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(p.ai.suspicionLevels[seerId])}`);
                            } else {
                                // è¢«æŸ¥éªŒä¸ºç‹¼äººï¼ˆéç‹¼äººæ—¶ï¼‰ï¼Œå¯¹é¢„è¨€å®¶å¢åŠ æ€€ç–‘åº¦
                                if (p.role !== 'werewolf') {
                                    // å½“æœ‰é¢„è¨€å®¶æ­»äº¡æ—¶ï¼Œè¢«é”™è¯¯æŸ¥éªŒçš„å¥½äººå¯¹å­˜æ´»å‡é¢„è¨€å®¶çš„æ€€ç–‘åº¦å¢åŠ é‡åº”è¯¥æ›´é«˜
                                    const change = (100 + Math.random() * 20) * wrongAccusationMultiplier;
                                    // ç¡®ä¿suspicionLevelsæœ‰åˆå§‹å€¼
                                    if (p.ai.suspicionLevels[seerId] === undefined) {
                                        p.ai.suspicionLevels[seerId] = 0;
                                    }
                                    p.ai.suspicionLevels[seerId] = Math.min(1000, p.ai.suspicionLevels[seerId] + change);
                                    const seerPlayer = this.players.find(s => s.id === seerId);
                                    console.log(`${p.name}è¢«é¢„è¨€å®¶${seerPlayer?.name}é”™è¯¯æŸ¥éªŒä¸ºç‹¼äººï¼Œå¯¹å…¶æ€€ç–‘åº¦æå‡${Math.round(change)}`);
                                    this.logSuspicionChange(`${p.name}è¢«é¢„è¨€å®¶${seerPlayer?.name}é”™è¯¯æŸ¥éªŒä¸ºç‹¼äººï¼Œå¯¹${seerPlayer?.name}çš„æ€€ç–‘åº¦å¢åŠ äº†${Math.round(change)}ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(p.ai.suspicionLevels[seerId])}`);
                                }
                            }
                        } else if (p.role === 'seer' && p.id !== seerId) {
                            // çœŸæ­£çš„é¢„è¨€å®¶å¯¹å‡é¢„è¨€å®¶çš„ååº”
                            // ç¡®ä¿suspicionLevelsæœ‰åˆå§‹å€¼
                            if (p.ai.suspicionLevels[seerId] === undefined) {
                                p.ai.suspicionLevels[seerId] = 0;
                            }
                            const trueChange = 60 + Math.random() * 20;
                            p.ai.suspicionLevels[seerId] = Math.min(1000, Math.max(-1000, p.ai.suspicionLevels[seerId] + trueChange));
                            const seerPlayer = this.players.find(s => s.id === seerId);
                            console.log(`çœŸé¢„è¨€å®¶${p.name}å‘ç°å‡é¢„è¨€å®¶${seerPlayer?.name}ï¼Œå¯¹å…¶æ€€ç–‘åº¦æå‡`);
                            this.logSuspicionChange(`çœŸé¢„è¨€å®¶${p.name}å‘ç°å‡é¢„è¨€å®¶${seerPlayer?.name}ï¼Œå¯¹${seerPlayer?.name}çš„æ€€ç–‘åº¦å¢åŠ äº†${Math.round(trueChange)}ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(p.ai.suspicionLevels[seerId])}`);
                        } else if (p.role !== 'werewolf' && p.role !== 'seer') {
                            // å…¶ä»–å¥½äººå¯¹é¢„è¨€å®¶çš„ä¿¡ä»»
                            // æ£€æŸ¥æ˜¯å¦å·²ç»å¯¹è¯¥é¢„è¨€å®¶å£°ç§°åšå‡ºè¿‡ååº”
                            if (!p.ai.reactedToSeerClaims.includes(seerId)) {
                                // è®°å½•å·²ååº”
                                p.ai.reactedToSeerClaims.push(seerId);
                                
                                // è·å–å½“å‰å£°ç§°é¢„è¨€å®¶çš„æ¬¡æ•°ï¼ˆåŒ…æ‹¬å½“å‰è¿™ä¸ªï¼‰
                            p.ai.roleClaimCounts['seer'] = (p.ai.roleClaimCounts['seer'] || 0) + 1;
                            const claimCount = p.ai.roleClaimCounts['seer'];
                            
                            // è®¡ç®—æ€€ç–‘åº¦é™ä½é‡ï¼Œæ¯æ¬¡å‡å°‘1/2
                            const baseChange = -40 - Math.random() * 10;
                            const multiplier = Math.pow(0.5, claimCount - 1);
                            const change = baseChange * multiplier;
                            
                            p.ai.suspicionLevels[seerId] = Math.max(-1000, p.ai.suspicionLevels[seerId] + change);
                            const seerPlayer = this.players.find(s => s.id === seerId);
                            console.log(`å¥½äºº${p.name}å¯¹ç¬¬${claimCount}ä¸ªé¢„è¨€å®¶${seerPlayer?.name}çš„ä¿¡ä»»åº¦å˜åŒ–ï¼Œæ€€ç–‘åº¦å‡å°‘${Math.round(Math.abs(change))}`);
                            this.logSuspicionChange(`å¥½äºº${p.name}å¯¹ç¬¬${claimCount}ä¸ªé¢„è¨€å®¶${seerPlayer?.name}çš„ä¿¡ä»»åº¦å˜åŒ–ï¼Œå¯¹${seerPlayer?.name}çš„æ€€ç–‘åº¦å‡å°‘äº†${Math.round(Math.abs(change))}ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(p.ai.suspicionLevels[seerId])}`);
                            }
                        }
                        
                        // å…¶ä»–ç©å®¶å¯¹è¢«æŸ¥éªŒè€…çš„ååº”
                        if (p.id !== seerId && p.id !== targetId) {
                            if (p.role !== 'werewolf') {
                                // å¥½äººç©å®¶çš„ååº”
                                if (result === 'å¥½äºº') {
                                    // å¬åˆ°é¢„è¨€å®¶æ±‡æŠ¥æŸäººä¸ºå¥½äººï¼Œå¯¹è¯¥å¥½äººå¤§å¹…å‡å°‘æ€€ç–‘åº¦
                                    const change = (-30 - Math.random() * 15) * effectMultiplier;
                                    // ç¡®ä¿suspicionLevelsæœ‰åˆå§‹å€¼
                                    if (p.ai.suspicionLevels[targetId] === undefined) {
                                        p.ai.suspicionLevels[targetId] = 0;
                                    }
                                    p.ai.suspicionLevels[targetId] = Math.max(-1000, p.ai.suspicionLevels[targetId] + change);
                            const seerPlayer = this.players.find(s => s.id === seerId);
                            const targetPlayer = this.players.find(t => t.id === targetId);
                            console.log(`${p.name}å¬åˆ°é¢„è¨€å®¶${seerPlayer?.name}è¯´${targetPlayer?.name}æ˜¯å¥½äººï¼Œå¯¹${targetPlayer?.name}çš„æ€€ç–‘åº¦å¤§å¹…å‡å°‘${Math.round(Math.abs(change))}`);
                            this.logSuspicionChange(`${p.name}å¬åˆ°é¢„è¨€å®¶${seerPlayer?.name}è¯´${targetPlayer?.name}æ˜¯å¥½äººï¼Œå¯¹${targetPlayer?.name}çš„æ€€ç–‘åº¦å‡å°‘äº†${Math.round(Math.abs(change))}ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(p.ai.suspicionLevels[targetId])}`);
                                } else {
                                    // å¬åˆ°é¢„è¨€å®¶æ±‡æŠ¥æŸäººä¸ºç‹¼äººï¼Œå¯¹è¯¥ç‹¼äººå¢åŠ æ€€ç–‘åº¦
                                    const change = (20 + Math.random() * 10) * effectMultiplier;
                                    // ç¡®ä¿suspicionLevelsæœ‰åˆå§‹å€¼
                                    if (p.ai.suspicionLevels[targetId] === undefined) {
                                        p.ai.suspicionLevels[targetId] = 0;
                                    }
                                    p.ai.suspicionLevels[targetId] = Math.min(1000, p.ai.suspicionLevels[targetId] + change);
                            const seerPlayer = this.players.find(s => s.id === seerId);
                            const targetPlayer = this.players.find(t => t.id === targetId);
                            console.log(`${p.name}å¬åˆ°é¢„è¨€å®¶${seerPlayer?.name}è¯´${targetPlayer?.name}æ˜¯ç‹¼äººï¼Œå¯¹${targetPlayer?.name}çš„æ€€ç–‘åº¦å¢åŠ ${Math.round(change)}`);
                            this.logSuspicionChange(`${p.name}å¬åˆ°é¢„è¨€å®¶${seerPlayer?.name}è¯´${targetPlayer?.name}æ˜¯ç‹¼äººï¼Œå¯¹${targetPlayer?.name}çš„æ€€ç–‘åº¦å¢åŠ äº†${Math.round(change)}ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(p.ai.suspicionLevels[targetId])}`);
                                }
                            }
                        }
                    }
                });
            }

            // é¢„è¨€å®¶æŸ¥éªŒåçš„æ€€ç–‘åº¦æ›´æ–°
            updateSeerSuspicion(seerId, targetId, result) {
                const seer = this.players.find(p => p.id === seerId);
                if (!seer || !seer.alive) return;
                
                if (result === 'ç‹¼äºº') {
                    seer.ai.suspicionLevels[targetId] = Math.min(1000, seer.ai.suspicionLevels[targetId] + 200); // å¢åŠ 200æ€€ç–‘åº¦
                    const targetPlayer = this.players.find(t => t.id === targetId);
                    console.log(`é¢„è¨€å®¶${seer.name}æŸ¥éªŒ${targetPlayer?.name}ä¸ºç‹¼äººï¼Œæ€€ç–‘åº¦å¢åŠ 200`);
                    this.logSuspicionChange(`é¢„è¨€å®¶${seer.name}æŸ¥éªŒ${targetPlayer?.name}ä¸ºç‹¼äººï¼Œå¯¹å…¶æ€€ç–‘åº¦å¢åŠ äº†200ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(seer.ai.suspicionLevels[targetId])}`);
                } else {
                    seer.ai.suspicionLevels[targetId] = Math.max(-1000, seer.ai.suspicionLevels[targetId] - 200); // å‡å°‘200æ€€ç–‘åº¦
                    const targetPlayer = this.players.find(t => t.id === targetId);
                    console.log(`é¢„è¨€å®¶${seer.name}æŸ¥éªŒ${targetPlayer?.name}ä¸ºå¥½äººï¼Œæ€€ç–‘åº¦å‡å°‘200`);
                    this.logSuspicionChange(`é¢„è¨€å®¶${seer.name}æŸ¥éªŒ${targetPlayer?.name}ä¸ºå¥½äººï¼Œå¯¹å…¶æ€€ç–‘åº¦å‡å°‘äº†200ï¼Œå½“å‰æ€€ç–‘åº¦ï¼š${Math.round(seer.ai.suspicionLevels[targetId])}`);
                }
            }
            
            // åŠ¨æ€æ›´æ–°ç‹¼äººé’ˆå¯¹æ€§å€¼
            updateWerewolfTargetingLevels() {
                const werewolves = this.players.filter(p => p.role === 'werewolf' && p.alive);
                
                werewolves.forEach(wolf => {
                    this.players.forEach(player => {
                        if (player.alive && player.role !== 'werewolf') {
                            let change = 0;
                            
                            // å®Œå…¨ç§»é™¤åŸºäºè§’è‰²ç±»å‹çš„æƒé‡è®¾ç½®
                            // ç‹¼äººæ— æ³•ç›´æ¥çŸ¥é“å…¶ä»–ç©å®¶çš„èº«ä»½ï¼Œåªèƒ½é€šè¿‡è¡Œä¸ºæ¨æµ‹
                            // ç§»é™¤åŸºç¡€å€¼ï¼Œä»…é€šè¿‡è¡Œä¸ºè°ƒæ•´é’ˆå¯¹å€¼
                            
                            // 2. æ ¹æ®ç©å®¶å¯¹ç‹¼äººçš„ä¿¡ä»»ç¨‹åº¦è°ƒæ•´é’ˆå¯¹æ€§å€¼
                            // å¯¹äºä¿¡ä»»ç‹¼äººçš„è§’è‰²ï¼ˆæ€€ç–‘åº¦ä½ï¼‰ï¼Œå‡å°‘é’ˆå¯¹æ€§å€¼
                            if (player.ai && player.ai.suspicionLevels[wolf.id] < -50) {
                                change -= 20; // å‡å°‘é’ˆå¯¹å€¼ï¼Œä¿æŠ¤ä¿¡ä»»ç‹¼äººçš„è§’è‰²
                            }
                            
                            // 3. æ ¹æ®ç©å®¶çš„æŠ•ç¥¨è¡Œä¸ºè°ƒæ•´é’ˆå¯¹æ€§å€¼
                            // å¦‚æœç©å®¶æ›¾ç»æŠ•ç¥¨ç»™ç‹¼äººï¼Œå¢åŠ é’ˆå¯¹æ€§å€¼
                            const hasVotedForWolf = Object.values(this.votes || {}).includes(wolf.id);
                            if (hasVotedForWolf && this.votes[player.id] === wolf.id) {
                                change += 5;
                            }
                            
                            // 4. æ ¹æ®ç©å®¶çš„å£°ç§°èº«ä»½è°ƒæ•´é’ˆå¯¹æ€§å€¼
                            // å¦‚æœç©å®¶å£°ç§°è‡ªå·±æ˜¯ç¥èŒè§’è‰²ï¼Œå¢åŠ é’ˆå¯¹æ€§å€¼
                            // ç‹¼äººå¯ä»¥ä»ç©å®¶çš„å‘è¨€ä¸­å¾—çŸ¥ä»–ä»¬å£°ç§°çš„èº«ä»½
                            if (player.claimedRole && ['seer', 'witch', 'hunter', 'idiot'].includes(player.claimedRole)) {
                                // æ¯å±€æ¸¸æˆä»…å¢åŠ ä¸€æ¬¡é’ˆå¯¹å€¼ï¼Œæ ¹æ®ä¸åŒç¥èŒèº«ä»½å¢åŠ ä¸åŒæ•°å€¼
                                if (!wolf.ai.processedRoleClaims) {
                                    wolf.ai.processedRoleClaims = {};
                                }
                                if (!wolf.ai.processedRoleClaims[player.id]) {
                                    wolf.ai.processedRoleClaims[player.id] = true;
                                    // æ ¹æ®ä¸åŒç¥èŒèº«ä»½å¢åŠ ä¸åŒé’ˆå¯¹å€¼
                                    const roleValues = {
                                        'seer': 50,
                                        'witch': 40,
                                        'hunter': 10,
                                        'idiot': 5
                                    };
                                    change += roleValues[player.claimedRole];
                                }
                            }
                            
                            // 5. æ ¹æ®ç©å®¶çš„å‘è¨€å†…å®¹è°ƒæ•´é’ˆå¯¹æ€§å€¼
                            // å¦‚æœç©å®¶åœ¨å‘è¨€ä¸­æ€€ç–‘ç‹¼äººï¼Œå¢åŠ é’ˆå¯¹æ€§å€¼
                            // è¿™ä¸ªé€»è¾‘éœ€è¦ç»“åˆspeechPhaseä¸­çš„å†…å®¹ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
                            
                            // ç¡®ä¿é’ˆå¯¹æ€§å€¼åœ¨åˆç†èŒƒå›´å†…
                            wolf.ai.targetingLevels[player.id] = Math.min(1000, Math.max(-1000, (wolf.ai.targetingLevels[player.id] || 0) + change));
                        }
                    });
                });
            }

            handleRoleCounterclaim(claimerId, claimedRole) {
                // å¤„ç†è§’è‰²å¯¹è·³æ—¶çš„æ€€ç–‘åº¦å˜åŒ–
                this.players.forEach(player => {
                    if (!player.isUser && player.alive) {
                        // çœŸæ­£çš„èŒä¸šè€…é‡åˆ°å¯¹è·³
                        if (player.role !== 'villager' && player.role !== 'werewolf' && player.role === claimedRole && player.id !== claimerId) {
                            // å¢åŠ å¯¹è·³è€…çš„æ€€ç–‘åº¦
                            player.ai.suspicionLevels[claimerId] = Math.min(1000, Math.max(-1000, player.ai.suspicionLevels[claimerId] + 60 + Math.random() * 20));
                            console.log(`${this.getRoleName(player.role)}${player.name}å‘ç°æœ‰äººå¯¹è·³ï¼Œå¢åŠ å¯¹${this.players.find(p => p.id === claimerId)?.name}çš„æ€€ç–‘åº¦`);
                            
                            // ä¸å†ç›¸ä¿¡å‡ç¥èŒçš„å‘è¨€
                            if (!player.ai.ignoredPlayers.includes(claimerId)) {
                                player.ai.ignoredPlayers.push(claimerId);
                                console.log(`${this.getRoleName(player.role)}${player.name}å¼€å§‹å¿½ç•¥${this.players.find(p => p.id === claimerId)?.name}çš„å‘è¨€`);
                            }
                        }
                        // å¥½äººAIå¯¹é¦–æ¬¡ç¥èŒå£°ç§°çš„ååº”
                        else if (player.role !== 'werewolf') {
                            // æ£€æŸ¥æ˜¯å¦å·²ç»å¯¹è¯¥è§’è‰²å£°ç§°åšå‡ºè¿‡ååº”
                            if (!player.ai.reactedToRoleClaims) {
                                player.ai.reactedToRoleClaims = {};
                            }
                            
                            // åªæœ‰åœ¨ç¥èŒç¬¬ä¸€æ¬¡å£°ç§°æ—¶æ‰å‡å°‘æ€€ç–‘åº¦
                            if (!player.ai.reactedToRoleClaims[claimedRole]) {
                                player.ai.reactedToRoleClaims[claimedRole] = [];
                            }
                            
                            if (!player.ai.reactedToRoleClaims[claimedRole].includes(claimerId)) {
                                // è®°å½•å·²ååº”
                                player.ai.reactedToRoleClaims[claimedRole].push(claimerId);
                                
                                // è·å–å½“å‰å£°ç§°è¯¥è§’è‰²çš„æ¬¡æ•°ï¼ˆåŒ…æ‹¬å½“å‰è¿™ä¸ªï¼‰
                                const claimCount = player.ai.reactedToRoleClaims[claimedRole].length;
                                
                                // æ ¹æ®è§’è‰²è®¡ç®—åŸºç¡€æ€€ç–‘åº¦å‡å°‘é‡
                                let baseChange;
                                if (claimedRole === 'seer' || claimedRole === 'witch') {
                                    baseChange = -40 - Math.random() * 10; // é¢„è¨€å®¶å’Œå¥³å·«å‡å°‘æœ€å¤š
                                } else {
                                    baseChange = -30 - Math.random() * 10; // å…¶ä»–ç¥èŒå…¶æ¬¡
                                }
                                
                                // æ¯æ¬¡å‡å°‘1/2
                                const multiplier = Math.pow(0.5, claimCount - 1);
                                const change = baseChange * multiplier;
                                
                                player.ai.suspicionLevels[claimerId] = Math.max(-1000, player.ai.suspicionLevels[claimerId] + change);
                                console.log(`å¥½äºº${player.name}å¯¹ç¬¬${claimCount}ä¸ª${this.getRoleName(claimedRole)}${this.players.find(p => p.id === claimerId)?.name}çš„ä¿¡ä»»åº¦å˜åŒ–ï¼Œæ€€ç–‘åº¦å‡å°‘${Math.round(Math.abs(change))}`);
                            }
                        }
                    }
                });
            }

            // å¤„ç†12äººå±€ç™½ç—´è¢«æŠ•ç¥¨å‡ºå±€åçš„æ€€ç–‘åº¦å˜åŒ–
            handleIdiotSurvival(idiotId) {
                this.players.forEach(player => {
                    // åªå¤„ç†AIç©å®¶
                    if (!player.isUser && player.alive) {
                        // å°†å¯¹ç™½ç—´çš„æ€€ç–‘åº¦é™è‡³æœ€ä½
                        player.ai.suspicionLevels[idiotId] = -1000;
                        console.log(`AIç©å®¶${player.name}å¯¹ç™½ç—´${this.players.find(i => i.id === idiotId)?.name}çš„æ€€ç–‘åº¦é™è‡³æœ€ä½`);
                    }
                });
            }
            
            // å¤„ç†é¢„è¨€å®¶ï¼ˆæ— è®ºçœŸå‡ï¼‰åœ¨å¤œé—´æ­»äº¡åçš„æ€€ç–‘åº¦å˜åŒ–
            handleSeerDeath() {
                // è·å–å½“å‰å­˜æ´»çš„å£°ç§°é¢„è¨€å®¶çš„ç©å®¶åˆ—è¡¨
                const aliveSeerClaimants = this.players.filter(p => p.claimedRole === 'seer' && p.alive);
                
                // å¦‚æœæœ‰å­˜æ´»çš„å£°ç§°é¢„è¨€å®¶
                if (aliveSeerClaimants.length > 0) {
                    // éå†æ‰€æœ‰å­˜æ´»çš„äººç±»AIç©å®¶
                    this.players.forEach(player => {
                        if (!player.isUser && player.alive && player.role !== 'werewolf') {
                            // å¯¹æ¯ä¸ªå­˜æ´»çš„å£°ç§°é¢„è¨€å®¶å¢åŠ å¤§é‡æ€€ç–‘åº¦ï¼ˆåŒç­‰äºå¯¹è·³çš„æ€€ç–‘åº¦å˜åŒ–ï¼‰
                            aliveSeerClaimants.forEach(seer => {
                                if (player.id !== seer.id) {
                                    const change = 60 + Math.random() * 20; // ä¸å¯¹è·³ç›¸åŒçš„æ€€ç–‘åº¦å¢åŠ 
                                    player.ai.suspicionLevels[seer.id] = Math.min(1000, player.ai.suspicionLevels[seer.id] + change);
                                    console.log(`äººç±»AI${player.name}å› é¢„è¨€å®¶å¤œé—´æ­»äº¡ï¼Œå¯¹å­˜æ´»çš„é¢„è¨€å®¶${seer.name}çš„æ€€ç–‘åº¦å¢åŠ ${Math.round(change)}`);
                                }
                            });
                        }
                    });
                }
            }

            getRoleName(role) {
                const roleNames = {
                    'werewolf': 'ğŸº ç‹¼äºº',
                    'seer': 'ğŸ”® é¢„è¨€å®¶',
                    'witch': 'ğŸŒ¿ å¥³å·«',
                    'hunter': 'ğŸ”« çŒäºº',
                    'idiot': 'ğŸ˜ ç™½ç—´',
                    'villager': 'ğŸ§‘â€ğŸŒ¾ å¹³æ°‘'
                };
                return roleNames[role];
            }

            getDeathEmoji(causeOfDeath) {
                const deathEmojis = {
                    'werewolf': '<span class="text-red-500 text-5xl font-bold">âŒ</span>', // è¢«ç‹¼äººæ€å®³
                    'vote': '<span class="text-yellow-500 text-5xl font-bold">â›“ï¸</span>',    // è¢«æŠ•ç¥¨å¤„å†³
                    'poison': '<span class="text-green-500 text-5xl font-bold">ğŸ§ª</span>',   // è¢«å¥³å·«æ¯’æ€
                    'shoot': '<span class="text-orange-500 text-5xl font-bold">ğŸ”«</span>'    // è¢«çŒäººæªæ€
                };
                return deathEmojis[causeOfDeath] || '<span class="text-white text-5xl font-bold">âŒ</span>';

            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const game = new WerewolfGame();
            game.init();
        });
    </script>
</body>
</html>